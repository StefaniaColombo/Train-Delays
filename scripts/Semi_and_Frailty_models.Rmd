---
title: "Nuova_versione"
output: html_document
date: "2025-06-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(broom)
library(dplyr)
library(ggplot2)
library(stringr)
library(gridExtra)
library(grid)
```

#Preparazione del dataset generale ----
```{r}
prova <- S5_msdata_cov_mix
prova$saliti <- prova$saliti/50
prova$scesi <- prova$scesi/50
prova$saturazione <- prova$saturazione/2
prova$direzione <- factor(prova$direzione, levels = c("0", "1"))
prova$traffico_ora <- factor(prova$traffico_ora, levels = c("Off-Peak Time", "Morning-Peak Time", "Evening-Peak Time"))
prova$zona <- as.character(prova$zona)
for (i in 1:nrow(prova)) {
  if(prova$zona[i] == "Mi-Città")
    prova$zona[i] <-"Zone 3"
  else if (prova$zona[i] == "Post-Mi" || prova$zona[i] == "Pre-Mi")
    prova$zona[i] <- "Zone 4"
  else if (prova$zona[i] == "Post-Mi.2" || prova$zona[i] == "Pre-Mi.1")
    prova$zona[i] <- "Zone 1"
  else if (prova$zona[i] == "Post-Mi.1" || prova$zona[i] == "Pre-Mi.2")
    prova$zona[i] <- "Zone 2"
}
prova$zona <- factor(prova$zona, levels = c("Zone 4", "Zone 3", "Zone 2", "Zone 1"))

prova_0 <- prova[prova$direzione == 0, ]
prova_1 <- prova[prova$direzione == 1, ]

cov_via <- c("saliti", "scesi", "fenom", "saturazione", "traffico_ora", "zona")
prova_exp_0 <- expand.covs(prova_0, cov_via, trans=tmat)
prova_exp_1 <- expand.covs(prova_1, cov_via, trans=tmat)
```


#Direzione 0----
##Solo covariate----
###Modello con covariate: Fascia Oraria (Separato per direzione) ---- 
Costruisco il modello di base con tutte le covariate e tolgo subito quelle non significative:
```{r}
cox_FasciaOraria_0 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + saturazione.1 + saturazione.2 + saturazione.3 + saturazione.4 + fenom1.1 + fenom1.2 + fenom1.3 + fenom1.4 + traffico_oraMorning.Peak.Time.1 + traffico_oraMorning.Peak.Time.2 + traffico_oraMorning.Peak.Time.3 + traffico_oraMorning.Peak.Time.4 + traffico_oraEvening.Peak.Time.1 + traffico_oraEvening.Peak.Time.2 + traffico_oraEvening.Peak.Time.3 + traffico_oraEvening.Peak.Time.4 + strata(trans), data = prova_exp_0, method = "breslow")
summary(cox_FasciaOraria_0)

cox_FasciaOraria_breve_0 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.2 + scesi.4 + saturazione.1 + saturazione.3 + saturazione.4 + fenom1.1 + fenom1.2 + traffico_oraMorning.Peak.Time.1 + traffico_oraEvening.Peak.Time.1 + traffico_oraEvening.Peak.Time.4 + strata(trans), data = prova_exp_0, method = "breslow")
summary(cox_FasciaOraria_breve_0)
```

Ora plotto gli HR:
```{r}
# Prepara i dati (come prima)
tidy_cox <- broom::tidy(cox_FasciaOraria_0, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""))

color_map <- c(
  "OnTime → Mild Delay" = "#F43F56",
  "MildDelay → SevereDelay" = "#F43F56",
  "SevereDelay → MildDelay" = "#00B88D",
  "MildDelay → OnTime" = "#00B88D"
)

# Prendi tutti i nomi unici delle covariate
covariate_names <- unique(tidy_cox$covariate)

# Lista vuota per salvare i plot
plots <- list()

# Ciclo per creare un plot per ogni covariata
for (cov in covariate_names) {
  df_cov <- tidy_cox %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high, color = trans_label)) +
    geom_pointrange(size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map) +
    coord_flip() +
    labs(title = paste("HR per transizioni - Covariata:", cov),
         x = "Transition",
         y = "Hazard Ratio (esponenziale del coefficiente)",
         color = "Transizione") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "none")
  
  plots[[cov]] <- p
}

#Modifica i titoletti:
#saliti:
plots[["saliti"]]$labels[2] <- "HR (50 people)"
plots[["saliti"]]$labels[4] <- "Hazard Ratios with 95% CI for Boarded"
#scesi:
plots[["scesi"]]$labels[2] <- "HR (50 people)"
plots[["scesi"]]$labels[4] <- "Hazard Ratios with 95% CI for Alighted"
#fenom1:
plots[["fenom1"]]$labels[2] <- "HR (Clear)"
plots[["fenom1"]]$labels[4] <- "Hazard Ratios with 95% CI for Adverse Weather"
#saturazione:
plots[["saturazione"]]$labels[2] <- "HR (2 trains)"
plots[["saturazione"]]$labels[4] <- "Hazard Ratios with 95% CI for Train Frequency per Hour"
#traffico_oraMorning.Peak.Time:
plots[["traffico_oraMorning.Peak.Time"]]$labels[2] <- "HR (Off-Peak Time)"
plots[["traffico_oraMorning.Peak.Time"]]$labels[4] <- "Hazard Ratios with 95% CI for Morning-Peak Time"
#traffico_oraEvening.Peak.Time:
plots[["traffico_oraEvening.Peak.Time"]]$labels[2] <- "HR (Off-Peak Time)"
plots[["traffico_oraEvening.Peak.Time"]]$labels[4] <- "Hazard Ratios with 95% CI for Evening-Peak Time"

# Plot:
print(plots[["saliti"]])
print(plots[["scesi"]])
print(plots[["fenom1"]])
print(plots[["saturazione"]])
print(plots[["traffico_oraMorning.Peak.Time"]])
print(plots[["traffico_oraEvening.Peak.Time"]])
```


Grafici Probabilità di transizione:

1- Analisi fascia oraria x passeggeri (min) - direzione 0
```{r}
quantile(prova$saliti, probs = c(0.15, 0.85))
quantile(prova$scesi, probs = c(0.15, 0.85))
saliti_min <- 0.04
saliti_max <- 0.98 
scesi_min <- 0.10
scesi_max <- 1.08

wh_mattina_passeggeri_min_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Morning-Peak Time")
mattina_passeggeri_min_0 <- prova_0[rep(wh_mattina_passeggeri_min_0[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_passeggeri_min_0$trans <- 1:4
mattina_passeggeri_min_0$saliti <-  saliti_min
mattina_passeggeri_min_0$scesi <- scesi_min
mattina_passeggeri_min_0$saturazione <- mean(prova$saturazione)
attr(mattina_passeggeri_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_passeggeri_min_0_exp <- expand.covs(mattina_passeggeri_min_0, cov, longnames = TRUE)
mattina_passeggeri_min_0_exp$strata <- mattina_passeggeri_min_0_exp$trans
ms_mattina_passeggeri_min_0 <- msfit(cox_FasciaOraria_breve_0, mattina_passeggeri_min_0_exp, trans = tmat)
prob_mattina_passeggeri_min_0 <- probtrans(ms_mattina_passeggeri_min_0, predt = 0)

wh_pome_passeggeri_min_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Off-Peak Time")
pome_passeggeri_min_0 <- prova_0[rep(wh_pome_passeggeri_min_0[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_passeggeri_min_0$trans <- 1:4
pome_passeggeri_min_0$saliti <-  saliti_min
pome_passeggeri_min_0$scesi <- scesi_min
pome_passeggeri_min_0$saturazione <- mean(prova$saturazione)
attr(pome_passeggeri_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_passeggeri_min_0_exp <- expand.covs(pome_passeggeri_min_0, cov, longnames = TRUE)
pome_passeggeri_min_0_exp$strata <- pome_passeggeri_min_0_exp$trans
ms_pome_passeggeri_min_0 <- msfit(cox_FasciaOraria_breve_0, pome_passeggeri_min_0_exp, trans = tmat)
prob_pome_passeggeri_min_0 <- probtrans(ms_pome_passeggeri_min_0, predt = 0)

wh_sera_passeggeri_min_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Evening-Peak Time")
sera_passeggeri_min_0 <- prova_0[rep(wh_sera_passeggeri_min_0[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_passeggeri_min_0$trans <- 1:4
sera_passeggeri_min_0$saliti <-  saliti_min
sera_passeggeri_min_0$scesi <- scesi_min
sera_passeggeri_min_0$saturazione <- mean(prova$saturazione)
attr(sera_passeggeri_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_passeggeri_min_0_exp <- expand.covs(sera_passeggeri_min_0, cov, longnames = TRUE)
sera_passeggeri_min_0_exp$strata <- sera_passeggeri_min_0_exp$trans
ms_sera_passeggeri_min_0 <- msfit(cox_FasciaOraria_breve_0, sera_passeggeri_min_0_exp, trans = tmat)
prob_sera_passeggeri_min_0 <- probtrans(ms_sera_passeggeri_min_0, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_passeggeri_min_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_passeggeri_min_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_passeggeri_min_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_passeggeri_min_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_passeggeri_min_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_passeggeri_min_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_passeggeri_min_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_passeggeri_min_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_passeggeri_min_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Passengers (min) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

2- Analisi fascia oraria x passeggeri (max) - direzione 0
```{r}
# quantile(prova$saliti, probs = c(0.15, 0.85))
# quantile(prova$scesi, probs = c(0.15, 0.85))
# saliti_min <- 0.04
# saliti_max <- 0.98 
# scesi_min <- 0.10
# scesi_max <- 1.08

wh_mattina_passeggeri_max_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Morning-Peak Time")
mattina_passeggeri_max_0 <- prova_0[rep(wh_mattina_passeggeri_max_0[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_passeggeri_max_0$trans <- 1:4
mattina_passeggeri_max_0$saliti <-  saliti_max
mattina_passeggeri_max_0$scesi <- scesi_max
mattina_passeggeri_max_0$saturazione <- mean(prova$saturazione)
attr(mattina_passeggeri_max_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_passeggeri_max_0_exp <- expand.covs(mattina_passeggeri_max_0, cov, longnames = TRUE)
mattina_passeggeri_max_0_exp$strata <- mattina_passeggeri_max_0_exp$trans
ms_mattina_passeggeri_max_0 <- msfit(cox_FasciaOraria_breve_0, mattina_passeggeri_max_0_exp, trans = tmat)
prob_mattina_passeggeri_max_0 <- probtrans(ms_mattina_passeggeri_max_0, predt = 0)

wh_pome_passeggeri_max_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Off-Peak Time")
pome_passeggeri_max_0 <- prova_0[rep(wh_pome_passeggeri_max_0[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_passeggeri_max_0$trans <- 1:4
pome_passeggeri_max_0$saliti <-  saliti_max
pome_passeggeri_max_0$scesi <- scesi_max
pome_passeggeri_max_0$saturazione <- mean(prova$saturazione)
attr(pome_passeggeri_max_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_passeggeri_max_0_exp <- expand.covs(pome_passeggeri_max_0, cov, longnames = TRUE)
pome_passeggeri_max_0_exp$strata <- pome_passeggeri_max_0_exp$trans
ms_pome_passeggeri_max_0 <- msfit(cox_FasciaOraria_breve_0, pome_passeggeri_max_0_exp, trans = tmat)
prob_pome_passeggeri_max_0 <- probtrans(ms_pome_passeggeri_max_0, predt = 0)

wh_sera_passeggeri_max_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Evening-Peak Time")
sera_passeggeri_max_0 <- prova_0[rep(wh_sera_passeggeri_max_0[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_passeggeri_max_0$trans <- 1:4
sera_passeggeri_max_0$saliti <-  saliti_max
sera_passeggeri_max_0$scesi <- scesi_max
sera_passeggeri_max_0$saturazione <- mean(prova$saturazione)
attr(sera_passeggeri_max_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_passeggeri_max_0_exp <- expand.covs(sera_passeggeri_max_0, cov, longnames = TRUE)
sera_passeggeri_max_0_exp$strata <- sera_passeggeri_max_0_exp$trans
ms_sera_passeggeri_max_0 <- msfit(cox_FasciaOraria_breve_0, sera_passeggeri_max_0_exp, trans = tmat)
prob_sera_passeggeri_max_0 <- probtrans(ms_sera_passeggeri_max_0, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_passeggeri_max_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_passeggeri_max_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_passeggeri_max_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_passeggeri_max_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_passeggeri_max_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_passeggeri_max_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_passeggeri_max_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_passeggeri_max_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_passeggeri_max_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Passengers (max) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

3- Analisi fascia oraria x meteo (good) - direzione 0
```{r}
wh_mattina_meteo_good_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Morning-Peak Time")
mattina_meteo_good_0 <- prova_0[rep(wh_mattina_meteo_good_0[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_meteo_good_0$trans <- 1:4
mattina_meteo_good_0$saliti <-  mean(prova$saliti)
mattina_meteo_good_0$scesi <- mean(prova$scesi)
mattina_meteo_good_0$saturazione <- mean(prova$saturazione)
attr(mattina_meteo_good_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_meteo_good_0_exp <- expand.covs(mattina_meteo_good_0, cov, longnames = TRUE)
mattina_meteo_good_0_exp$strata <- mattina_meteo_good_0_exp$trans
ms_mattina_meteo_good_0 <- msfit(cox_FasciaOraria_breve_0, mattina_meteo_good_0_exp, trans = tmat)
prob_mattina_meteo_good_0 <- probtrans(ms_mattina_meteo_good_0, predt = 0)

wh_pome_meteo_good_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Off-Peak Time")
pome_meteo_good_0 <- prova_0[rep(wh_pome_meteo_good_0[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_meteo_good_0$trans <- 1:4
pome_meteo_good_0$saliti <-  mean(prova$saliti)
pome_meteo_good_0$scesi <- mean(prova$scesi)
pome_meteo_good_0$saturazione <- mean(prova$saturazione)
attr(pome_meteo_good_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_meteo_good_0_exp <- expand.covs(pome_meteo_good_0, cov, longnames = TRUE)
pome_meteo_good_0_exp$strata <- pome_meteo_good_0_exp$trans
ms_pome_meteo_good_0 <- msfit(cox_FasciaOraria_breve_0, pome_meteo_good_0_exp, trans = tmat)
prob_pome_meteo_good_0 <- probtrans(ms_pome_meteo_good_0, predt = 0)

wh_sera_meteo_good_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Evening-Peak Time")
sera_meteo_good_0 <- prova_0[rep(wh_sera_meteo_good_0[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_meteo_good_0$trans <- 1:4
sera_meteo_good_0$saliti <- mean(prova$saliti)
sera_meteo_good_0$scesi <- mean(prova$scesi)
sera_meteo_good_0$saturazione <- mean(prova$saturazione)
attr(sera_meteo_good_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_meteo_good_0_exp <- expand.covs(sera_meteo_good_0, cov, longnames = TRUE)
sera_meteo_good_0_exp$strata <- sera_meteo_good_0_exp$trans
ms_sera_meteo_good_0 <- msfit(cox_FasciaOraria_breve_0, sera_meteo_good_0_exp, trans = tmat)
prob_sera_meteo_good_0 <- probtrans(ms_sera_meteo_good_0, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_meteo_good_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_meteo_good_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_meteo_good_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_meteo_good_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_meteo_good_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_meteo_good_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_meteo_good_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_meteo_good_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_meteo_good_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Clear Weather per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

4- Analisi fascia oraria x meteo (bad) - direzione 0
```{r}
wh_mattina_meteo_bad_0 <- which(prova_0$fenom == 1 & prova_0$traffico_ora == "Morning-Peak Time")
mattina_meteo_bad_0 <- prova_0[rep(wh_mattina_meteo_bad_0[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_meteo_bad_0$trans <- 1:4
mattina_meteo_bad_0$saliti <-  mean(prova$saliti)
mattina_meteo_bad_0$scesi <- mean(prova$scesi)
mattina_meteo_bad_0$saturazione <- mean(prova$saturazione)
attr(mattina_meteo_bad_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_meteo_bad_0_exp <- expand.covs(mattina_meteo_bad_0, cov, longnames = TRUE)
mattina_meteo_bad_0_exp$strata <- mattina_meteo_bad_0_exp$trans
ms_mattina_meteo_bad_0 <- msfit(cox_FasciaOraria_breve_0, mattina_meteo_bad_0_exp, trans = tmat)
prob_mattina_meteo_bad_0 <- probtrans(ms_mattina_meteo_bad_0, predt = 0)

wh_pome_meteo_bad_0 <- which(prova_0$fenom == 1 & prova_0$traffico_ora == "Off-Peak Time")
pome_meteo_bad_0 <- prova_0[rep(wh_pome_meteo_bad_0[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_meteo_bad_0$trans <- 1:4
pome_meteo_bad_0$saliti <-  mean(prova$saliti)
pome_meteo_bad_0$scesi <- mean(prova$scesi)
pome_meteo_bad_0$saturazione <- mean(prova$saturazione)
attr(pome_meteo_bad_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_meteo_bad_0_exp <- expand.covs(pome_meteo_bad_0, cov, longnames = TRUE)
pome_meteo_bad_0_exp$strata <- pome_meteo_bad_0_exp$trans
ms_pome_meteo_bad_0 <- msfit(cox_FasciaOraria_breve_0, pome_meteo_bad_0_exp, trans = tmat)
prob_pome_meteo_bad_0 <- probtrans(ms_pome_meteo_bad_0, predt = 0)

wh_sera_meteo_bad_0 <- which(prova_0$fenom == 1 & prova_0$traffico_ora == "Evening-Peak Time")
sera_meteo_bad_0 <- prova_0[rep(wh_sera_meteo_bad_0[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_meteo_bad_0$trans <- 1:4
sera_meteo_bad_0$saliti <- mean(prova$saliti)
sera_meteo_bad_0$scesi <- mean(prova$scesi)
sera_meteo_bad_0$saturazione <- mean(prova$saturazione)
attr(sera_meteo_bad_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_meteo_bad_0_exp <- expand.covs(sera_meteo_bad_0, cov, longnames = TRUE)
sera_meteo_bad_0_exp$strata <- sera_meteo_bad_0_exp$trans
ms_sera_meteo_bad_0 <- msfit(cox_FasciaOraria_breve_0, sera_meteo_bad_0_exp, trans = tmat)
prob_sera_meteo_bad_0 <- probtrans(ms_sera_meteo_bad_0, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_meteo_bad_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_meteo_bad_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_meteo_bad_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_meteo_bad_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_meteo_bad_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_meteo_bad_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_meteo_bad_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_meteo_bad_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_meteo_bad_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Adverse Weather per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

5- Analisi fascia oraria x saturazione (min) - direzione 0
```{r}
saturazione_val_min <- 2 #4/2 --> Zona Varese
saturazione_val_max <- 12 #24/2 --> Milano

wh_mattina_saturazione_min_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Morning-Peak Time")
mattina_saturazione_min_0 <- prova_0[rep(wh_mattina_saturazione_min_0[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_saturazione_min_0$trans <- 1:4
mattina_saturazione_min_0$saliti <-  mean(prova$saliti)
mattina_saturazione_min_0$scesi <- mean(prova$scesi)
mattina_saturazione_min_0$saturazione <- saturazione_val_min
attr(mattina_saturazione_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_saturazione_min_0_exp <- expand.covs(mattina_saturazione_min_0, cov, longnames = TRUE)
mattina_saturazione_min_0_exp$strata <- mattina_saturazione_min_0_exp$trans
ms_mattina_saturazione_min_0 <- msfit(cox_FasciaOraria_breve_0, mattina_saturazione_min_0_exp, trans = tmat)
prob_mattina_saturazione_min_0 <- probtrans(ms_mattina_saturazione_min_0, predt = 0)

wh_pome_saturazione_min_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Off-Peak Time")
pome_saturazione_min_0 <- prova_0[rep(wh_pome_saturazione_min_0[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_saturazione_min_0$trans <- 1:4
pome_saturazione_min_0$saliti <- mean(prova$saliti)
pome_saturazione_min_0$scesi <- mean(prova$scesi)
pome_saturazione_min_0$saturazione <- saturazione_val_min
attr(pome_saturazione_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_saturazione_min_0_exp <- expand.covs(pome_saturazione_min_0, cov, longnames = TRUE)
pome_saturazione_min_0_exp$strata <- pome_saturazione_min_0_exp$trans
ms_pome_saturazione_min_0 <- msfit(cox_FasciaOraria_breve_0, pome_saturazione_min_0_exp, trans = tmat)
prob_pome_saturazione_min_0 <- probtrans(ms_pome_saturazione_min_0, predt = 0)

wh_sera_saturazione_min_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Evening-Peak Time")
sera_saturazione_min_0 <- prova_0[rep(wh_sera_saturazione_min_0[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_saturazione_min_0$trans <- 1:4
sera_saturazione_min_0$saliti <-  mean(prova$saliti)
sera_saturazione_min_0$scesi <- mean(prova$scesi)
sera_saturazione_min_0$saturazione <- saturazione_val_min
attr(sera_saturazione_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_saturazione_min_0_exp <- expand.covs(sera_saturazione_min_0, cov, longnames = TRUE)
sera_saturazione_min_0_exp$strata <- sera_saturazione_min_0_exp$trans
ms_sera_saturazione_min_0 <- msfit(cox_FasciaOraria_breve_0, sera_saturazione_min_0_exp, trans = tmat)
prob_sera_saturazione_min_0 <- probtrans(ms_sera_saturazione_min_0, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_saturazione_min_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_saturazione_min_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_saturazione_min_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_saturazione_min_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_saturazione_min_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_saturazione_min_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_saturazione_min_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_saturazione_min_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_saturazione_min_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Train Frequency per Hour (min) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

6- Analisi fascia oraria x saturazione (max) - direzione 0
```{r}
# saturazione_val_min <- 2 #4/2 --> Zona Varese
# saturazione_val_max <- 12 #24/2 --> Milano

wh_mattina_saturazione_max_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Morning-Peak Time")
mattina_saturazione_max_0 <- prova_0[rep(wh_mattina_saturazione_max_0[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_saturazione_max_0$trans <- 1:4
mattina_saturazione_max_0$saliti <-  mean(prova$saliti)
mattina_saturazione_max_0$scesi <- mean(prova$scesi)
mattina_saturazione_max_0$saturazione <- saturazione_val_max
attr(mattina_saturazione_max_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_saturazione_max_0_exp <- expand.covs(mattina_saturazione_max_0, cov, longnames = TRUE)
mattina_saturazione_max_0_exp$strata <- mattina_saturazione_max_0_exp$trans
ms_mattina_saturazione_max_0 <- msfit(cox_FasciaOraria_breve_0, mattina_saturazione_max_0_exp, trans = tmat)
prob_mattina_saturazione_max_0 <- probtrans(ms_mattina_saturazione_max_0, predt = 0)

wh_pome_saturazione_max_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Off-Peak Time")
pome_saturazione_max_0 <- prova_0[rep(wh_pome_saturazione_max_0[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_saturazione_max_0$trans <- 1:4
pome_saturazione_max_0$saliti <- mean(prova$saliti)
pome_saturazione_max_0$scesi <- mean(prova$scesi)
pome_saturazione_max_0$saturazione <- saturazione_val_max
attr(pome_saturazione_max_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_saturazione_max_0_exp <- expand.covs(pome_saturazione_max_0, cov, longnames = TRUE)
pome_saturazione_max_0_exp$strata <- pome_saturazione_max_0_exp$trans
ms_pome_saturazione_max_0 <- msfit(cox_FasciaOraria_breve_0, pome_saturazione_max_0_exp, trans = tmat)
prob_pome_saturazione_max_0 <- probtrans(ms_pome_saturazione_max_0, predt = 0)

wh_sera_saturazione_max_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Evening-Peak Time")
sera_saturazione_max_0 <- prova_0[rep(wh_sera_saturazione_max_0[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_saturazione_max_0$trans <- 1:4
sera_saturazione_max_0$saliti <-  mean(prova$saliti)
sera_saturazione_max_0$scesi <- mean(prova$scesi)
sera_saturazione_max_0$saturazione <- saturazione_val_max
attr(sera_saturazione_max_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_saturazione_max_0_exp <- expand.covs(sera_saturazione_max_0, cov, longnames = TRUE)
sera_saturazione_max_0_exp$strata <- sera_saturazione_max_0_exp$trans
ms_sera_saturazione_max_0 <- msfit(cox_FasciaOraria_breve_0, sera_saturazione_max_0_exp, trans = tmat)
prob_sera_saturazione_max_0 <- probtrans(ms_sera_saturazione_max_0, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_saturazione_max_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_saturazione_max_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_saturazione_max_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_saturazione_max_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_saturazione_max_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_saturazione_max_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_saturazione_max_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_saturazione_max_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_saturazione_max_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Train Frequency per Hour (max) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

7- Analisi fascia oraria x bestcase - direzione 0
```{r}
wh_mattina_best_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Morning-Peak Time")
mattina_best_0 <- prova_0[rep(wh_mattina_best_0[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_best_0$trans <- 1:4
mattina_best_0$saliti <-  saliti_min
mattina_best_0$scesi <- scesi_min
mattina_best_0$saturazione <- saturazione_val_min
attr(mattina_best_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_best_0_exp <- expand.covs(mattina_best_0, cov, longnames = TRUE)
mattina_best_0_exp$strata <- mattina_best_0_exp$trans
ms_mattina_best_0 <- msfit(cox_FasciaOraria_breve_0, mattina_best_0_exp, trans = tmat)
prob_mattina_best_0 <- probtrans(ms_mattina_best_0, predt = 0)

wh_pome_best_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Off-Peak Time")
pome_best_0 <- prova_0[rep(wh_pome_best_0[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_best_0$trans <- 1:4
pome_best_0$saliti <-  saliti_min
pome_best_0$scesi <- scesi_min
pome_best_0$saturazione <- saturazione_val_min
attr(pome_best_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_best_0_exp <- expand.covs(pome_best_0, cov, longnames = TRUE)
pome_best_0_exp$strata <- pome_best_0_exp$trans
ms_pome_best_0 <- msfit(cox_FasciaOraria_breve_0, pome_best_0_exp, trans = tmat)
prob_pome_best_0 <- probtrans(ms_pome_best_0, predt = 0)

wh_sera_best_0 <- which(prova_0$fenom == 0 & prova_0$traffico_ora == "Evening-Peak Time")
sera_best_0 <- prova_0[rep(wh_sera_best_0[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_best_0$trans <- 1:4
sera_best_0$saliti <- saliti_min
sera_best_0$scesi <- scesi_min
sera_best_0$saturazione <- saturazione_val_min
attr(sera_best_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_best_0_exp <- expand.covs(sera_best_0, cov, longnames = TRUE)
sera_best_0_exp$strata <- sera_best_0_exp$trans
ms_sera_best_0 <- msfit(cox_FasciaOraria_breve_0, sera_best_0_exp, trans = tmat)
prob_sera_best_0 <- probtrans(ms_sera_best_0, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_best_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_best_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_best_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_best_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_best_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_best_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_best_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_best_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_best_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Best Case Scenario per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

8- Analisi fascia oraria x worstcase - direzione 0
```{r}
wh_mattina_worst_0 <- which(prova_0$fenom == 1 & prova_0$traffico_ora == "Morning-Peak Time")
mattina_worst_0 <- prova_0[rep(wh_mattina_worst_0[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_worst_0$trans <- 1:4
mattina_worst_0$saliti <-  saliti_max
mattina_worst_0$scesi <- scesi_max
mattina_worst_0$saturazione <- saturazione_val_max
attr(mattina_worst_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_worst_0_exp <- expand.covs(mattina_worst_0, cov, longnames = TRUE)
mattina_worst_0_exp$strata <- mattina_worst_0_exp$trans
ms_mattina_worst_0 <- msfit(cox_FasciaOraria_breve_0, mattina_worst_0_exp, trans = tmat)
prob_mattina_worst_0 <- probtrans(ms_mattina_worst_0, predt = 0)

wh_pome_worst_0 <- which(prova_0$fenom == 1 & prova_0$traffico_ora == "Off-Peak Time")
pome_worst_0 <- prova_0[rep(wh_pome_worst_0[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_worst_0$trans <- 1:4
pome_worst_0$saliti <-  saliti_max
pome_worst_0$scesi <- scesi_max
pome_worst_0$saturazione <- saturazione_val_max
attr(pome_worst_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_worst_0_exp <- expand.covs(pome_worst_0, cov, longnames = TRUE)
pome_worst_0_exp$strata <- pome_worst_0_exp$trans
ms_pome_worst_0 <- msfit(cox_FasciaOraria_breve_0, pome_worst_0_exp, trans = tmat)
prob_pome_worst_0 <- probtrans(ms_pome_worst_0, predt = 0)

wh_sera_worst_0 <- which(prova_0$fenom == 1 & prova_0$traffico_ora == "Evening-Peak Time")
sera_worst_0 <- prova_0[rep(wh_sera_worst_0[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_worst_0$trans <- 1:4
sera_worst_0$saliti <- saliti_max
sera_worst_0$scesi <- scesi_max
sera_worst_0$saturazione <- saturazione_val_max
attr(sera_worst_0, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_worst_0_exp <- expand.covs(sera_worst_0, cov, longnames = TRUE)
sera_worst_0_exp$strata <- sera_worst_0_exp$trans
ms_sera_worst_0 <- msfit(cox_FasciaOraria_breve_0, sera_worst_0_exp, trans = tmat)
prob_sera_worst_0 <- probtrans(ms_sera_worst_0, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_worst_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_worst_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_worst_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_worst_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_worst_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_worst_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_worst_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_worst_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_worst_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Worst Case Scenario per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```


###Modello con covariate: Zona (Separato per direzione) ---- 
Costruisco il modello di base con tutte le covariate e tolgo subito quelle non significative:
```{r}
cox_Zona_0 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + zonaZone.3.1 + zonaZone.3.2 + zonaZone.3.3 + zonaZone.3.4 + zonaZone.2.1 + zonaZone.2.2 + zonaZone.2.3 + zonaZone.2.4 + zonaZone.1.1 + zonaZone.1.2 + zonaZone.1.3 + zonaZone.1.4 + strata(trans), data = prova_exp_0, method = "breslow")
summary(cox_Zona_0)

cox_Zona_breve_0 <- coxph(Surv(time, status) ~ saliti.2 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + zonaZone.3.1 + zonaZone.3.3 + zonaZone.3.4 + zonaZone.2.1 + zonaZone.2.2 + zonaZone.2.3 + zonaZone.2.4 + zonaZone.1.1 + zonaZone.1.2 + strata(trans), data = prova_exp_0, method = "breslow")
summary(cox_Zona_breve_0)
```

Ora plotto gli HR:
```{r}
# Prepara i dati (come prima)
tidy_cox <- broom::tidy(cox_Zona_0, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""))

color_map <- c(
  "OnTime → Mild Delay" = "#F43F56",
  "MildDelay → SevereDelay" = "#F43F56",
  "SevereDelay → MildDelay" = "#00B88D",
  "MildDelay → OnTime" = "#00B88D"
)

# Prendi tutti i nomi unici delle covariate
covariate_names <- unique(tidy_cox$covariate)

# Lista vuota per salvare i plot
plots <- list()

# Ciclo per creare un plot per ogni covariata
for (cov in covariate_names) {
  df_cov <- tidy_cox %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high, color = trans_label)) +
    geom_pointrange(size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map) +
    coord_flip() +
    labs(title = paste("HR per transizioni - Covariata:", cov),
         x = "Transition",
         y = "Hazard Ratio (esponenziale del coefficiente)",
         color = "Transizione") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "none")
  
  plots[[cov]] <- p
}

#Modifica i titoletti:
#saliti:
plots[["saliti"]]$labels[2] <- "HR (50 people)"
plots[["saliti"]]$labels[4] <- "Hazard Ratios with 95% CI for Boarded"
#scesi:
plots[["scesi"]]$labels[2] <- "HR (50 people)"
plots[["scesi"]]$labels[4] <- "Hazard Ratios with 95% CI for Alighted"
#zonaZone.1:
plots[["zonaZone.1"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zonaZone.1"]]$labels[4] <- "Hazard Ratios with 95% CI for Varese - Gallarate"
#zonaZone.2:
plots[["zonaZone.2"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zonaZone.2"]]$labels[4] <- "Hazard Ratios with 95% CI for Busto Arsizio - Rho Fiera"
#zonaZone.3:
plots[["zonaZone.3"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zonaZone.3"]]$labels[4] <- "Hazard Ratios with 95% CI for Milano Certosa - Milano Forlanini"

# Plot:
print(plots[["saliti"]])
print(plots[["scesi"]])
print(plots[["zonaZone.1"]])
print(plots[["zonaZone.2"]])
print(plots[["zonaZone.3"]])
```


Grafici Probabilità di transizione:

1- Analisi zona x passeggeri (min) - direzione 0
```{r}
# quantile(prova$saliti, probs = c(0.15, 0.85))
# quantile(prova$scesi, probs = c(0.15, 0.85))
# saliti_min <- 0.04
# saliti_max <- 0.98 
# scesi_min <- 0.10
# scesi_max <- 1.08

wh_VaGa_passeggeri_min_0 <- which(prova_0$zona == "Zone 1")
VaGa_passeggeri_min_0 <- prova_0[rep(wh_VaGa_passeggeri_min_0[1], 4), c(17, 18, 20, 22)]
VaGa_passeggeri_min_0$trans <- 1:4
VaGa_passeggeri_min_0$saliti <-  saliti_min
VaGa_passeggeri_min_0$scesi <- scesi_min
attr(VaGa_passeggeri_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
VaGa_passeggeri_min_0_exp <- expand.covs(VaGa_passeggeri_min_0, cov, longnames = TRUE)
VaGa_passeggeri_min_0_exp$strata <- VaGa_passeggeri_min_0_exp$trans
ms_VaGa_passeggeri_min_0 <- msfit(cox_Zona_breve_0, VaGa_passeggeri_min_0_exp, trans = tmat)
prob_VaGa_passeggeri_min_0 <- probtrans(ms_VaGa_passeggeri_min_0, predt = 0)

wh_BuRho_passeggeri_min_0 <- which(prova_0$zona == "Zone 2")
BuRho_passeggeri_min_0 <- prova_0[rep(wh_BuRho_passeggeri_min_0[1], 4), c(17, 18, 20, 22)]
BuRho_passeggeri_min_0$trans <- 1:4
BuRho_passeggeri_min_0$saliti <-  saliti_min
BuRho_passeggeri_min_0$scesi <- scesi_min
attr(BuRho_passeggeri_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
BuRho_passeggeri_min_0_exp <- expand.covs(BuRho_passeggeri_min_0, cov, longnames = TRUE)
BuRho_passeggeri_min_0_exp$strata <- BuRho_passeggeri_min_0_exp$trans
ms_BuRho_passeggeri_min_0 <- msfit(cox_Zona_breve_0, BuRho_passeggeri_min_0_exp, trans = tmat)
prob_BuRho_passeggeri_min_0 <- probtrans(ms_BuRho_passeggeri_min_0, predt = 0)

wh_Milano_passeggeri_min_0 <- which(prova_0$zona == "Zone 3")
Milano_passeggeri_min_0 <- prova_0[rep(wh_Milano_passeggeri_min_0[1], 4), c(17, 18, 20, 22)]
Milano_passeggeri_min_0$trans <- 1:4
Milano_passeggeri_min_0$saliti <-  saliti_min
Milano_passeggeri_min_0$scesi <- scesi_min
attr(Milano_passeggeri_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
Milano_passeggeri_min_0_exp <- expand.covs(Milano_passeggeri_min_0, cov, longnames = TRUE)
Milano_passeggeri_min_0_exp$strata <- Milano_passeggeri_min_0_exp$trans
ms_Milano_passeggeri_min_0 <- msfit(cox_Zona_breve_0, Milano_passeggeri_min_0_exp, trans = tmat)
prob_Milano_passeggeri_min_0 <- probtrans(ms_Milano_passeggeri_min_0, predt = 0)

wh_SeTre_passeggeri_min_0 <- which(prova_0$zona == "Zone 4")
SeTre_passeggeri_min_0 <- prova_0[rep(wh_SeTre_passeggeri_min_0[1], 4), c(17, 18, 20, 22)]
SeTre_passeggeri_min_0$trans <- 1:4
SeTre_passeggeri_min_0$saliti <-  saliti_min
SeTre_passeggeri_min_0$scesi <- scesi_min
attr(SeTre_passeggeri_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
SeTre_passeggeri_min_0_exp <- expand.covs(SeTre_passeggeri_min_0, cov, longnames = TRUE)
SeTre_passeggeri_min_0_exp$strata <- SeTre_passeggeri_min_0_exp$trans
ms_SeTre_passeggeri_min_0 <- msfit(cox_Zona_breve_0, SeTre_passeggeri_min_0_exp, trans = tmat)
prob_SeTre_passeggeri_min_0 <- probtrans(ms_SeTre_passeggeri_min_0, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_VaGa_passeggeri_min_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_VaGa_passeggeri_min_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_VaGa_passeggeri_min_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_BuRho_passeggeri_min_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_BuRho_passeggeri_min_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_BuRho_passeggeri_min_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_Milano_passeggeri_min_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_Milano_passeggeri_min_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_Milano_passeggeri_min_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p10<-plot(prob_SeTre_passeggeri_min_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p10 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p11<-plot(prob_SeTre_passeggeri_min_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p11 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p12<-plot(prob_SeTre_passeggeri_min_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p12 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p10 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p11 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p12 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 4, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Passengers (min) per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

2- Analisi zona x passeggeri (max) - direzione 0
```{r}
wh_VaGa_passeggeri_max_0 <- which(prova_0$zona == "Zone 1")
VaGa_passeggeri_max_0 <- prova_0[rep(wh_VaGa_passeggeri_max_0[1], 4), c(17, 18, 20, 22)]
VaGa_passeggeri_max_0$trans <- 1:4
VaGa_passeggeri_max_0$saliti <-  saliti_max
VaGa_passeggeri_max_0$scesi <- scesi_max
attr(VaGa_passeggeri_max_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
VaGa_passeggeri_max_0_exp <- expand.covs(VaGa_passeggeri_max_0, cov, longnames = TRUE)
VaGa_passeggeri_max_0_exp$strata <- VaGa_passeggeri_max_0_exp$trans
ms_VaGa_passeggeri_max_0 <- msfit(cox_Zona_breve_0, VaGa_passeggeri_max_0_exp, trans = tmat)
prob_VaGa_passeggeri_max_0 <- probtrans(ms_VaGa_passeggeri_max_0, predt = 0)

wh_BuRho_passeggeri_max_0 <- which(prova_0$zona == "Zone 2")
BuRho_passeggeri_max_0 <- prova_0[rep(wh_BuRho_passeggeri_max_0[1], 4), c(17, 18, 20, 22)]
BuRho_passeggeri_max_0$trans <- 1:4
BuRho_passeggeri_max_0$saliti <-  saliti_max
BuRho_passeggeri_max_0$scesi <- scesi_max
attr(BuRho_passeggeri_max_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
BuRho_passeggeri_max_0_exp <- expand.covs(BuRho_passeggeri_max_0, cov, longnames = TRUE)
BuRho_passeggeri_max_0_exp$strata <- BuRho_passeggeri_max_0_exp$trans
ms_BuRho_passeggeri_max_0 <- msfit(cox_Zona_breve_0, BuRho_passeggeri_max_0_exp, trans = tmat)
prob_BuRho_passeggeri_max_0 <- probtrans(ms_BuRho_passeggeri_max_0, predt = 0)

wh_Milano_passeggeri_max_0 <- which(prova_0$zona == "Zone 3")
Milano_passeggeri_max_0 <- prova_0[rep(wh_Milano_passeggeri_max_0[1], 4), c(17, 18, 20, 22)]
Milano_passeggeri_max_0$trans <- 1:4
Milano_passeggeri_max_0$saliti <-  saliti_max
Milano_passeggeri_max_0$scesi <- scesi_max
attr(Milano_passeggeri_max_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
Milano_passeggeri_max_0_exp <- expand.covs(Milano_passeggeri_max_0, cov, longnames = TRUE)
Milano_passeggeri_max_0_exp$strata <- Milano_passeggeri_max_0_exp$trans
ms_Milano_passeggeri_max_0 <- msfit(cox_Zona_breve_0, Milano_passeggeri_max_0_exp, trans = tmat)
prob_Milano_passeggeri_max_0 <- probtrans(ms_Milano_passeggeri_max_0, predt = 0)

wh_SeTre_passeggeri_max_0 <- which(prova_0$zona == "Zone 4")
SeTre_passeggeri_max_0 <- prova_0[rep(wh_SeTre_passeggeri_max_0[1], 4), c(17, 18, 20, 22)]
SeTre_passeggeri_max_0$trans <- 1:4
SeTre_passeggeri_max_0$saliti <-  saliti_max
SeTre_passeggeri_max_0$scesi <- scesi_max
attr(SeTre_passeggeri_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
SeTre_passeggeri_max_0_exp <- expand.covs(SeTre_passeggeri_max_0, cov, longnames = TRUE)
SeTre_passeggeri_max_0_exp$strata <- SeTre_passeggeri_max_0_exp$trans
ms_SeTre_passeggeri_max_0 <- msfit(cox_Zona_breve_0, SeTre_passeggeri_max_0_exp, trans = tmat)
prob_SeTre_passeggeri_max_0 <- probtrans(ms_SeTre_passeggeri_max_0, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_VaGa_passeggeri_max_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_VaGa_passeggeri_max_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_VaGa_passeggeri_max_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_BuRho_passeggeri_max_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_BuRho_passeggeri_max_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_BuRho_passeggeri_max_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_Milano_passeggeri_max_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_Milano_passeggeri_max_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_Milano_passeggeri_max_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p10<-plot(prob_SeTre_passeggeri_max_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p10 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p11<-plot(prob_SeTre_passeggeri_max_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p11 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p12<-plot(prob_SeTre_passeggeri_max_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p12 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p10 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p11 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p12 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 4, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Passengers (max) per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```









##Frailty----
###Modello con covariate e frailty: Fascia Oraria (Separato per direzione) ---- 
Costruisco il modello mettendo la frailty su ID_Treno:
```{r}
# frailtyGamma_FasciaOraria_0 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + saturazione.1 + saturazione.2 + saturazione.3 + saturazione.4 + fenom1.1 + fenom1.2 + fenom1.3 + fenom1.4 + traffico_oraMorning.Peak.Time.1 + traffico_oraMorning.Peak.Time.2 + traffico_oraMorning.Peak.Time.3 + traffico_oraMorning.Peak.Time.4 + traffico_oraEvening.Peak.Time.1 + traffico_oraEvening.Peak.Time.2 + traffico_oraEvening.Peak.Time.3 + traffico_oraEvening.Peak.Time.4 + frailty(ID_Treno, distribution = "gamma") + strata(trans), data = prova_exp_0, method = "breslow")
# summary(frailtyGamma_FasciaOraria_0)
# logLik(frailtyGamma_FasciaOraria_0)

# frailtyGaussian_FasciaOraria_0 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + saturazione.1 + saturazione.2 + saturazione.3 + saturazione.4 + fenom1.1 + fenom1.2 + fenom1.3 + fenom1.4 + traffico_oraMorning.Peak.Time.1 + traffico_oraMorning.Peak.Time.2 + traffico_oraMorning.Peak.Time.3 + traffico_oraMorning.Peak.Time.4 + traffico_oraEvening.Peak.Time.1 + traffico_oraEvening.Peak.Time.2 + traffico_oraEvening.Peak.Time.3 + traffico_oraEvening.Peak.Time.4 + frailty(ID_Treno, distribution = "gaussian") + strata(trans), data = prova_exp_0, method = "breslow")
# summary(frailtyGaussian_FasciaOraria_0)
# logLik(frailtyGaussian_FasciaOraria_0) #Gauss è leggermente migliore
```

Costruisco il modello mettendo la frailty su ID_Mezzo (meglio questo, qua si vede una certa eterogeneità):
```{r}
frailtyGamma_FasciaOraria_0 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + saturazione.1 + saturazione.2 + saturazione.3 + saturazione.4 + fenom1.1 + fenom1.2 + fenom1.3 + fenom1.4 + traffico_oraMorning.Peak.Time.1 + traffico_oraMorning.Peak.Time.2 + traffico_oraMorning.Peak.Time.3 + traffico_oraMorning.Peak.Time.4 + traffico_oraEvening.Peak.Time.1 + traffico_oraEvening.Peak.Time.2 + traffico_oraEvening.Peak.Time.3 + traffico_oraEvening.Peak.Time.4 + frailty(ID_Mezzo, distribution = "gamma") + strata(trans), data = prova_exp_0, method = "breslow")
summary(frailtyGamma_FasciaOraria_0)
logLik(frailtyGamma_FasciaOraria_0) #Siamo lì, ma leggermente meglio il gamma, quindi faccio riferimento a questo

# frailtyGaussian_FasciaOraria_0 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + saturazione.1 + saturazione.2 + saturazione.3 + saturazione.4 + fenom1.1 + fenom1.2 + fenom1.3 + fenom1.4 + traffico_oraMorning.Peak.Time.1 + traffico_oraMorning.Peak.Time.2 + traffico_oraMorning.Peak.Time.3 + traffico_oraMorning.Peak.Time.4 + traffico_oraEvening.Peak.Time.1 + traffico_oraEvening.Peak.Time.2 + traffico_oraEvening.Peak.Time.3 + traffico_oraEvening.Peak.Time.4 + frailty(ID_Mezzo, distribution = "gaussian") + strata(trans), data = prova_exp_0, method = "breslow")
# summary(frailtyGaussian_FasciaOraria_0)
# logLik(frailtyGaussian_FasciaOraria_0)
```

Ora plotto gli HR:
```{r}
# Mappa colori per le transizioni
color_map <- c(
  "OnTime → Mild Delay" = "#F43F56",
  "MildDelay → SevereDelay" = "#F43F56",
  "SevereDelay → MildDelay" = "#00B88D",
  "MildDelay → OnTime" = "#00B88D"
)

# Tidizza Cox
tidy_cox <- broom::tidy(cox_FasciaOraria_0, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""),
         model = "Cox")

# Tidizza Frailty
# Estrai coeff, confint e calcola HR
frailty_coef <- coef(frailtyGamma_FasciaOraria_0)
frailty_ci <- confint(frailtyGamma_FasciaOraria_0)

tidy_frailty <- tibble(
  term = names(frailty_coef),
  estimate = exp(frailty_coef),
  conf.low = exp(frailty_ci[, 1]),
  conf.high = exp(frailty_ci[, 2])
) %>%
  mutate(
    trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
    trans_label = factor(trans, levels = c("1","3","4","2"),
                         labels = c("OnTime → Mild Delay",
                                    "MildDelay → SevereDelay",
                                    "SevereDelay → MildDelay",
                                    "MildDelay → OnTime")),
    covariate = str_replace(term, "\\.\\d$", ""),
    model = "Frailty"
  )

# Combina i due
combined_data <- bind_rows(tidy_cox, tidy_frailty)

# Lista covariate
covariate_names <- unique(combined_data$covariate)

# Lista di plot
plots <- list()
pd <- position_dodge(width = 0.6)

# Ciclo su tutte le covariate
for (cov in covariate_names) {
  df_cov <- combined_data %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high,
                          color = trans_label, shape = model)) +
    geom_pointrange(position = pd, size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map, name = "Transition") +
    scale_shape_manual(values = c(Cox = 16, Frailty = 17),
                       labels = c("Cox model", "Frailty model"),
                       name = "Model") +
    coord_flip() +
    labs(title = paste("HR per transizioni - Covariata:", cov),
         x = "Transition",
         y = "Hazard Ratio (esponenziale del coefficiente)") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "right",
          legend.box = "vertical",
          legend.title = element_text(face = "bold"),
          legend.spacing.y = unit(0.4, 'cm'),
          legend.text = element_text(size = 11))
  
  plots[[cov]] <- p
}

# Personalizza titoli e assi per covariate selezionate
plots[["saliti"]]$labels[["y"]] <- "HR (50 people)"
plots[["saliti"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Boarded"

plots[["scesi"]]$labels[["y"]] <- "HR (50 people)"
plots[["scesi"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Alighted"

plots[["fenom1"]]$labels[["y"]] <- "HR (Clear)"
plots[["fenom1"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Adverse Weather"

plots[["saturazione"]]$labels[["y"]] <- "HR (2 trains)"
plots[["saturazione"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Train Frequency per Hour"

plots[["traffico_oraMorning.Peak.Time"]]$labels[["y"]] <- "HR (Off-Peak Time)"
plots[["traffico_oraMorning.Peak.Time"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Morning-Peak Time"

plots[["traffico_oraEvening.Peak.Time"]]$labels[["y"]] <- "HR (Off-Peak Time)"
plots[["traffico_oraEvening.Peak.Time"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Evening-Peak Time"

# Stampa dei plot
print(plots[["saliti"]])
print(plots[["scesi"]])
print(plots[["fenom1"]])
print(plots[["saturazione"]])
print(plots[["traffico_oraMorning.Peak.Time"]])
print(plots[["traffico_oraEvening.Peak.Time"]])
```


Grafici Frailty:
```{r}
# Estraggio i valori delle log(wj)
frailty_vals_FasciaOraria_0 <- frailtyGamma_FasciaOraria_0$frail

#  Assegno ID_Mezzo ai rispettivi valori di frailty e considero anche le varianze specifiche per wj:
cluster_levels_FasciaOraria_0 <- sort(unique(prova_exp_0$ID_Mezzo))
frailty_table_FasciaOraria_0 <- data.frame(ID_Mezzo = cluster_levels_FasciaOraria_0, frailty = frailtyGamma_FasciaOraria_0$frail, var=frailtyGamma_FasciaOraria_0$fvar)

#  Adesso uguale ma per ID_Treno e aggiungo anche i veri vlori wj al posto di avere frailty=log(wj):
#Morning
dati_distinct_FasciaOraria_0 <- prova_exp[!duplicated(prova_exp_0$ID_Mezzo), c("ID_Mezzo", "ID_Treno", "partenza", "traffico_ora")]
tabella_frailty_FasciaOraria_0 <- merge(frailty_table_FasciaOraria_0, dati_distinct_FasciaOraria_0, by = "ID_Mezzo")
tabella_frailty_FasciaOraria_0$wj <- exp(tabella_frailty_FasciaOraria_0$frailty)
tabella_frailty_FasciaOraria_0$partenza <- format(as.POSIXct(tabella_frailty_FasciaOraria_0$partenza), "%I:%M %p")
tabella_frailty_FasciaOraria_0$lower <- exp(tabella_frailty_FasciaOraria_0$frailty - 1.96 * sqrt(tabella_frailty_FasciaOraria_0$var))
tabella_frailty_FasciaOraria_0$upper <- exp(tabella_frailty_FasciaOraria_0$frailty + 1.96 * sqrt(tabella_frailty_FasciaOraria_0$var))
```

Plot colorato per FasciaOraria:
```{r}
orari_unici_FasciaOraria_0 <- c("Morning-Peak Time", "Off-Peak Time", "Evening-Peak Time")
tabella_frailty_FasciaOraria_0$traffico_ora <- factor(tabella_frailty_FasciaOraria_0$traffico_ora, levels = orari_unici_FasciaOraria_0)
colori_personalizzati <- c("#87CEFA", "#EB5C82", "#F59B51")
palette_orari_FasciaOraria_0 <- setNames(colori_personalizzati, orari_unici_FasciaOraria_0)

theta_FasciaOraria_0 <- 0.235767
down <- exp(-1.5 * sqrt(theta_FasciaOraria_0))
up <- exp(1.5 * sqrt(theta_FasciaOraria_0))

ggplot(tabella_frailty_FasciaOraria_0, aes(x = ID_Mezzo, y = wj, color = traffico_ora)) +
  geom_point(size = 2) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", linewidth = 0.4) +
  geom_hline(yintercept = up, linetype = "dashed", color = "grey", linewidth = 0.4) +
  geom_hline(yintercept = down, linetype = "dashed", color = "grey", linewidth = 0.4) +
  scale_color_manual(values = palette_orari_FasciaOraria_0) +
  labs(
    title = "Empirical Gamma Failty Terms",
    x = "Mission",
    y = "Frailty (wj)",
    color = "Time Slot"
  ) +
  theme_minimal()
```


###Modello con covariate e frailty: Zona (Separato per direzione) ---- 
Costruisco il modello di base con tutte le covariate e tolgo subito quelle non significative:
```{r}
cox_Zona_0 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + zonaZone.3.1 + zonaZone.3.2 + zonaZone.3.3 + zonaZone.3.4 + zonaZone.2.1 + zonaZone.2.2 + zonaZone.2.3 + zonaZone.2.4 + zonaZone.1.1 + zonaZone.1.2 + zonaZone.1.3 + zonaZone.1.4 + strata(trans), data = prova_exp_0, method = "breslow")
summary(cox_Zona_0)

cox_Zona_breve_0 <- coxph(Surv(time, status) ~ saliti.2 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + zonaZone.3.1 + zonaZone.3.3 + zonaZone.3.4 + zonaZone.2.1 + zonaZone.2.2 + zonaZone.2.3 + zonaZone.2.4 + zonaZone.1.1 + zonaZone.1.2 + strata(trans), data = prova_exp_0, method = "breslow")
summary(cox_Zona_breve_0)
```

Ora plotto gli HR:
```{r}
# Prepara i dati (come prima)
tidy_cox <- broom::tidy(cox_Zona_0, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""))

color_map <- c(
  "OnTime → Mild Delay" = "#F43F56",
  "MildDelay → SevereDelay" = "#F43F56",
  "SevereDelay → MildDelay" = "#00B88D",
  "MildDelay → OnTime" = "#00B88D"
)

# Prendi tutti i nomi unici delle covariate
covariate_names <- unique(tidy_cox$covariate)

# Lista vuota per salvare i plot
plots <- list()

# Ciclo per creare un plot per ogni covariata
for (cov in covariate_names) {
  df_cov <- tidy_cox %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high, color = trans_label)) +
    geom_pointrange(size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map) +
    coord_flip() +
    labs(title = paste("HR per transizioni - Covariata:", cov),
         x = "Transition",
         y = "Hazard Ratio (esponenziale del coefficiente)",
         color = "Transizione") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "none")
  
  plots[[cov]] <- p
}

#Modifica i titoletti:
#saliti:
plots[["saliti"]]$labels[2] <- "HR (50 people)"
plots[["saliti"]]$labels[4] <- "Hazard Ratios with 95% CI for Boarded"
#scesi:
plots[["scesi"]]$labels[2] <- "HR (50 people)"
plots[["scesi"]]$labels[4] <- "Hazard Ratios with 95% CI for Alighted"
#zonaZone.1:
plots[["zonaZone.1"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zonaZone.1"]]$labels[4] <- "Hazard Ratios with 95% CI for Varese - Gallarate"
#zonaZone.2:
plots[["zonaZone.2"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zonaZone.2"]]$labels[4] <- "Hazard Ratios with 95% CI for Busto Arsizio - Rho Fiera"
#zonaZone.3:
plots[["zonaZone.3"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zonaZone.3"]]$labels[4] <- "Hazard Ratios with 95% CI for Milano Certosa - Milano Forlanini"

# Plot:
print(plots[["saliti"]])
print(plots[["scesi"]])
print(plots[["zonaZone.1"]])
print(plots[["zonaZone.2"]])
print(plots[["zonaZone.3"]])
```


Grafici Probabilità di transizione:

1- Analisi zona x passeggeri (min) - direzione 0
```{r}
# quantile(prova$saliti, probs = c(0.15, 0.85))
# quantile(prova$scesi, probs = c(0.15, 0.85))
# saliti_min <- 0.04
# saliti_max <- 0.98 
# scesi_min <- 0.10
# scesi_max <- 1.08

wh_VaGa_passeggeri_min_0 <- which(prova_0$zona == "Zone 1")
VaGa_passeggeri_min_0 <- prova_0[rep(wh_VaGa_passeggeri_min_0[1], 4), c(17, 18, 20, 22)]
VaGa_passeggeri_min_0$trans <- 1:4
VaGa_passeggeri_min_0$saliti <-  saliti_min
VaGa_passeggeri_min_0$scesi <- scesi_min
attr(VaGa_passeggeri_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
VaGa_passeggeri_min_0_exp <- expand.covs(VaGa_passeggeri_min_0, cov, longnames = TRUE)
VaGa_passeggeri_min_0_exp$strata <- VaGa_passeggeri_min_0_exp$trans
ms_VaGa_passeggeri_min_0 <- msfit(cox_Zona_breve_0, VaGa_passeggeri_min_0_exp, trans = tmat)
prob_VaGa_passeggeri_min_0 <- probtrans(ms_VaGa_passeggeri_min_0, predt = 0)

wh_BuRho_passeggeri_min_0 <- which(prova_0$zona == "Zone 2")
BuRho_passeggeri_min_0 <- prova_0[rep(wh_BuRho_passeggeri_min_0[1], 4), c(17, 18, 20, 22)]
BuRho_passeggeri_min_0$trans <- 1:4
BuRho_passeggeri_min_0$saliti <-  saliti_min
BuRho_passeggeri_min_0$scesi <- scesi_min
attr(BuRho_passeggeri_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
BuRho_passeggeri_min_0_exp <- expand.covs(BuRho_passeggeri_min_0, cov, longnames = TRUE)
BuRho_passeggeri_min_0_exp$strata <- BuRho_passeggeri_min_0_exp$trans
ms_BuRho_passeggeri_min_0 <- msfit(cox_Zona_breve_0, BuRho_passeggeri_min_0_exp, trans = tmat)
prob_BuRho_passeggeri_min_0 <- probtrans(ms_BuRho_passeggeri_min_0, predt = 0)

wh_Milano_passeggeri_min_0 <- which(prova_0$zona == "Zone 3")
Milano_passeggeri_min_0 <- prova_0[rep(wh_Milano_passeggeri_min_0[1], 4), c(17, 18, 20, 22)]
Milano_passeggeri_min_0$trans <- 1:4
Milano_passeggeri_min_0$saliti <-  saliti_min
Milano_passeggeri_min_0$scesi <- scesi_min
attr(Milano_passeggeri_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
Milano_passeggeri_min_0_exp <- expand.covs(Milano_passeggeri_min_0, cov, longnames = TRUE)
Milano_passeggeri_min_0_exp$strata <- Milano_passeggeri_min_0_exp$trans
ms_Milano_passeggeri_min_0 <- msfit(cox_Zona_breve_0, Milano_passeggeri_min_0_exp, trans = tmat)
prob_Milano_passeggeri_min_0 <- probtrans(ms_Milano_passeggeri_min_0, predt = 0)

wh_SeTre_passeggeri_min_0 <- which(prova_0$zona == "Zone 4")
SeTre_passeggeri_min_0 <- prova_0[rep(wh_SeTre_passeggeri_min_0[1], 4), c(17, 18, 20, 22)]
SeTre_passeggeri_min_0$trans <- 1:4
SeTre_passeggeri_min_0$saliti <-  saliti_min
SeTre_passeggeri_min_0$scesi <- scesi_min
attr(SeTre_passeggeri_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
SeTre_passeggeri_min_0_exp <- expand.covs(SeTre_passeggeri_min_0, cov, longnames = TRUE)
SeTre_passeggeri_min_0_exp$strata <- SeTre_passeggeri_min_0_exp$trans
ms_SeTre_passeggeri_min_0 <- msfit(cox_Zona_breve_0, SeTre_passeggeri_min_0_exp, trans = tmat)
prob_SeTre_passeggeri_min_0 <- probtrans(ms_SeTre_passeggeri_min_0, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_VaGa_passeggeri_min_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_VaGa_passeggeri_min_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_VaGa_passeggeri_min_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_BuRho_passeggeri_min_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_BuRho_passeggeri_min_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_BuRho_passeggeri_min_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_Milano_passeggeri_min_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_Milano_passeggeri_min_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_Milano_passeggeri_min_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p10<-plot(prob_SeTre_passeggeri_min_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p10 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p11<-plot(prob_SeTre_passeggeri_min_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p11 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p12<-plot(prob_SeTre_passeggeri_min_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p12 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p10 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p11 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p12 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 4, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Passengers (min) per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

2- Analisi zona x passeggeri (max) - direzione 0
```{r}
wh_VaGa_passeggeri_max_0 <- which(prova_0$zona == "Zone 1")
VaGa_passeggeri_max_0 <- prova_0[rep(wh_VaGa_passeggeri_max_0[1], 4), c(17, 18, 20, 22)]
VaGa_passeggeri_max_0$trans <- 1:4
VaGa_passeggeri_max_0$saliti <-  saliti_max
VaGa_passeggeri_max_0$scesi <- scesi_max
attr(VaGa_passeggeri_max_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
VaGa_passeggeri_max_0_exp <- expand.covs(VaGa_passeggeri_max_0, cov, longnames = TRUE)
VaGa_passeggeri_max_0_exp$strata <- VaGa_passeggeri_max_0_exp$trans
ms_VaGa_passeggeri_max_0 <- msfit(cox_Zona_breve_0, VaGa_passeggeri_max_0_exp, trans = tmat)
prob_VaGa_passeggeri_max_0 <- probtrans(ms_VaGa_passeggeri_max_0, predt = 0)

wh_BuRho_passeggeri_max_0 <- which(prova_0$zona == "Zone 2")
BuRho_passeggeri_max_0 <- prova_0[rep(wh_BuRho_passeggeri_max_0[1], 4), c(17, 18, 20, 22)]
BuRho_passeggeri_max_0$trans <- 1:4
BuRho_passeggeri_max_0$saliti <-  saliti_max
BuRho_passeggeri_max_0$scesi <- scesi_max
attr(BuRho_passeggeri_max_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
BuRho_passeggeri_max_0_exp <- expand.covs(BuRho_passeggeri_max_0, cov, longnames = TRUE)
BuRho_passeggeri_max_0_exp$strata <- BuRho_passeggeri_max_0_exp$trans
ms_BuRho_passeggeri_max_0 <- msfit(cox_Zona_breve_0, BuRho_passeggeri_max_0_exp, trans = tmat)
prob_BuRho_passeggeri_max_0 <- probtrans(ms_BuRho_passeggeri_max_0, predt = 0)

wh_Milano_passeggeri_max_0 <- which(prova_0$zona == "Zone 3")
Milano_passeggeri_max_0 <- prova_0[rep(wh_Milano_passeggeri_max_0[1], 4), c(17, 18, 20, 22)]
Milano_passeggeri_max_0$trans <- 1:4
Milano_passeggeri_max_0$saliti <-  saliti_max
Milano_passeggeri_max_0$scesi <- scesi_max
attr(Milano_passeggeri_max_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
Milano_passeggeri_max_0_exp <- expand.covs(Milano_passeggeri_max_0, cov, longnames = TRUE)
Milano_passeggeri_max_0_exp$strata <- Milano_passeggeri_max_0_exp$trans
ms_Milano_passeggeri_max_0 <- msfit(cox_Zona_breve_0, Milano_passeggeri_max_0_exp, trans = tmat)
prob_Milano_passeggeri_max_0 <- probtrans(ms_Milano_passeggeri_max_0, predt = 0)

wh_SeTre_passeggeri_max_0 <- which(prova_0$zona == "Zone 4")
SeTre_passeggeri_max_0 <- prova_0[rep(wh_SeTre_passeggeri_max_0[1], 4), c(17, 18, 20, 22)]
SeTre_passeggeri_max_0$trans <- 1:4
SeTre_passeggeri_max_0$saliti <-  saliti_max
SeTre_passeggeri_max_0$scesi <- scesi_max
attr(SeTre_passeggeri_min_0, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
SeTre_passeggeri_max_0_exp <- expand.covs(SeTre_passeggeri_max_0, cov, longnames = TRUE)
SeTre_passeggeri_max_0_exp$strata <- SeTre_passeggeri_max_0_exp$trans
ms_SeTre_passeggeri_max_0 <- msfit(cox_Zona_breve_0, SeTre_passeggeri_max_0_exp, trans = tmat)
prob_SeTre_passeggeri_max_0 <- probtrans(ms_SeTre_passeggeri_max_0, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_VaGa_passeggeri_max_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_VaGa_passeggeri_max_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_VaGa_passeggeri_max_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_BuRho_passeggeri_max_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_BuRho_passeggeri_max_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_BuRho_passeggeri_max_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_Milano_passeggeri_max_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_Milano_passeggeri_max_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_Milano_passeggeri_max_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p10<-plot(prob_SeTre_passeggeri_max_0, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p10 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p11<-plot(prob_SeTre_passeggeri_max_0, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p11 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p12<-plot(prob_SeTre_passeggeri_max_0, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p12 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p10 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p11 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p12 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 4, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Passengers (max) per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```









Costruisco il modello mettendo la frailty su ID_Treno:
```{r}
# frailtyGamma_Zona_0 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + zonaZone.3.1 + zonaZone.3.2 + zonaZone.3.3 + zonaZone.3.4 + zonaZone.2.1 + zonaZone.2.2 + zonaZone.2.3 + zonaZone.2.4 + zonaZone.1.1 + zonaZone.1.2 + zonaZone.1.3 + zonaZone.1.4 + frailty(ID_Treno, distribution = "gamma") + strata(trans), data = prova_exp_0, method = "breslow")
# summary(frailtyGamma_Zona_0)
# logLik(frailtyGamma_Zona_0) #Leggermente migliore rispetto al Gauss
# 
# frailtyGaussian_Zona_0 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + zonaZone.3.1 + zonaZone.3.2 + zonaZone.3.3 + zonaZone.3.4 + zonaZone.2.1 + zonaZone.2.2 + zonaZone.2.3 + zonaZone.2.4 + zonaZone.1.1 + zonaZone.1.2 + zonaZone.1.3 + zonaZone.1.4 + frailty(ID_Treno, distribution = "gaussian") + strata(trans), data = prova_exp_0, method = "breslow")
# summary(frailtyGaussian_Zona_0)
# logLik(frailtyGaussian_Zona_0)
```

Costruisco il modello mettendo la frailty su ID_Mezzo (meglio questo, qua si vede una cera eterogeneità):
```{r}
frailtyGamma_Zona_0 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + zonaZone.3.1 + zonaZone.3.2 + zonaZone.3.3 + zonaZone.3.4 + zonaZone.2.1 + zonaZone.2.2 + zonaZone.2.3 + zonaZone.2.4 + zonaZone.1.1 + zonaZone.1.2 + zonaZone.1.3 + zonaZone.1.4 + frailty(ID_Mezzo, distribution = "gamma") + strata(trans), data = prova_exp_0, method = "breslow")
summary(frailtyGamma_Zona_0)
logLik(frailtyGamma_Zona_0) #Leggermente migliore rispetto al Gauss

# frailtyGaussian_Zona_0 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + zonaZone.3.1 + zonaZone.3.2 + zonaZone.3.3 + zonaZone.3.4 + zonaZone.2.1 + zonaZone.2.2 + zonaZone.2.3 + zonaZone.2.4 + zonaZone.1.1 + zonaZone.1.2 + zonaZone.1.3 + zonaZone.1.4 + frailty(ID_Mezzo, distribution = "gaussian") + strata(trans), data = prova_exp_0, method = "breslow")
# summary(frailtyGaussian_Zona_0)
# logLik(frailtyGaussian_Zona_0)
```

Ora plotto gli HR:
```{r}
# Mappa colori per le transizioni
color_map <- c(
  "OnTime → Mild Delay" = "#F43F56",
  "MildDelay → SevereDelay" = "#F43F56",
  "SevereDelay → MildDelay" = "#00B88D",
  "MildDelay → OnTime" = "#00B88D"
)

# Tidizza Cox
tidy_cox <- broom::tidy(cox_Zona_0, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""),
         model = "Cox")

# Tidizza Frailty
# Estrai coeff, confint e calcola HR
frailty_coef <- coef(frailtyGamma_Zona_0)
frailty_ci <- confint(frailtyGamma_Zona_0)

tidy_frailty <- tibble(
  term = names(frailty_coef),
  estimate = exp(frailty_coef),
  conf.low = exp(frailty_ci[, 1]),
  conf.high = exp(frailty_ci[, 2])
) %>%
  mutate(
    trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
    trans_label = factor(trans, levels = c("1","3","4","2"),
                         labels = c("OnTime → Mild Delay",
                                    "MildDelay → SevereDelay",
                                    "SevereDelay → MildDelay",
                                    "MildDelay → OnTime")),
    covariate = str_replace(term, "\\.\\d$", ""),
    model = "Frailty"
  )

# Combina i due
combined_data <- bind_rows(tidy_cox, tidy_frailty)

# Lista covariate
covariate_names <- unique(combined_data$covariate)

# Lista di plot
plots <- list()
pd <- position_dodge(width = 0.6)

# Ciclo su tutte le covariate
for (cov in covariate_names) {
  df_cov <- combined_data %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high,
                          color = trans_label, shape = model)) +
    geom_pointrange(position = pd, size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map, name = "Transition") +
    scale_shape_manual(values = c(Cox = 16, Frailty = 17),
                       labels = c("Cox model", "Frailty model"),
                       name = "Model") +
    coord_flip() +
    labs(title = paste("HR per transizioni - Covariata:", cov),
         x = "Transition",
         y = "Hazard Ratio (esponenziale del coefficiente)") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "right",
          legend.box = "vertical",
          legend.title = element_text(face = "bold"),
          legend.spacing.y = unit(0.4, 'cm'),
          legend.text = element_text(size = 11))
  
  plots[[cov]] <- p
}

#Modifica i titoletti:
#saliti:
plots[["saliti"]]$labels[2] <- "HR (50 people)"
plots[["saliti"]]$labels[3] <- "Hazard Ratios with 95% CI for Boarded"
#scesi:
plots[["scesi"]]$labels[2] <- "HR (50 people)"
plots[["scesi"]]$labels[3] <- "Hazard Ratios with 95% CI for Alighted"
#zonaZone.1:
plots[["zonaZone.1"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zonaZone.1"]]$labels[3] <- "Hazard Ratios with 95% CI for Varese - Gallarate"
#zonaZone.2:
plots[["zonaZone.2"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zonaZone.2"]]$labels[3] <- "Hazard Ratios with 95% CI for Busto Arsizio - Rho Fiera"
#zonaZone.3:
plots[["zonaZone.3"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zonaZone.3"]]$labels[3] <- "Hazard Ratios with 95% CI for Milano Certosa - Milano Forlanini"

# Plot:
print(plots[["saliti"]])
print(plots[["scesi"]])
print(plots[["zonaZone.1"]])
print(plots[["zonaZone.2"]])
print(plots[["zonaZone.3"]])
```


Grafici Frailty:
```{r}
# Estraggio i valori delle log(wj)
frailty_vals_Zona_0 <- frailtyGamma_Zona_0$frail

#  Assegno ID_Mezzo ai rispettivi valori di frailty e considero anche le varianze specifiche per wj:
cluster_levels_Zona_0 <- sort(unique(prova_exp_0$ID_Mezzo))
frailty_table_Zona_0 <- data.frame(ID_Mezzo = cluster_levels_Zona_0, frailty = frailtyGamma_Zona_0$frail, var=frailtyGamma_Zona_0$fvar)

#  Adesso uguale ma per ID_Treno e aggiungo anche i veri vlori wj al posto di avere frailty=log(wj):
#Morning
dati_distinct_Zona_0 <- prova_exp[!duplicated(prova_exp_0$ID_Mezzo), c("ID_Mezzo", "ID_Treno", "partenza", "traffico_ora")]
tabella_frailty_Zona_0 <- merge(frailty_table_Zona_0, dati_distinct_Zona_0, by = "ID_Mezzo")
tabella_frailty_Zona_0$wj <- exp(tabella_frailty_Zona_0$frailty)
tabella_frailty_Zona_0$partenza <- format(as.POSIXct(tabella_frailty_Zona_0$partenza), "%I:%M %p")
tabella_frailty_Zona_0$lower <- exp(tabella_frailty_Zona_0$frailty - 1.96 * sqrt(tabella_frailty_Zona_0$var))
tabella_frailty_Zona_0$upper <- exp(tabella_frailty_Zona_0$frailty + 1.96 * sqrt(tabella_frailty_Zona_0$var))
```

Plot colorato per FasciaOraria:
```{r}
orari_unici_Zona_0 <- c("Morning-Peak Time", "Off-Peak Time", "Evening-Peak Time")
tabella_frailty_Zona_0$traffico_ora <- factor(tabella_frailty_Zona_0$traffico_ora, levels = orari_unici_Zona_0)
colori_personalizzati <- c("#87CEFA", "#EB5C82", "#F59B51")
palette_orari_Zona_0 <- setNames(colori_personalizzati, orari_unici_Zona_0)

theta_Zona_0 <- 0.3317728
down <- exp(- 1.5 * sqrt(theta_Zona_0))
up <- exp(1.5 * sqrt(theta_Zona_0))

ggplot(tabella_frailty_Zona_0, aes(x = ID_Mezzo, y = wj, color = traffico_ora)) +
  geom_point(size = 2) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", linewidth = 0.4) +
  geom_hline(yintercept = up, linetype = "dashed", color = "grey", linewidth = 0.4) +
  geom_hline(yintercept = down, linetype = "dashed", color = "grey", linewidth = 0.4) +
  scale_color_manual(values = palette_orari_Zona_0) +
  labs(
    title = "Empirical Gamma Failty Terms",
    x = "Mission",
    y = "Frailty (wj)",
    color = "Time Slot"
  ) +
  theme_minimal()
```


#Direzione 1----
##Solo covariate----
###Modello con covariate: Fascia Oraria (Separato per direzione) ---- 
Costruisco il modello di base con tutte le covariate e tolgo subito quelle non significative:
```{r}
cox_FasciaOraria_1 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + saturazione.1 + saturazione.2 + saturazione.3 + saturazione.4 + fenom1.1 + fenom1.2 + fenom1.3 + fenom1.4 + traffico_oraMorning.Peak.Time.1 + traffico_oraMorning.Peak.Time.2 + traffico_oraMorning.Peak.Time.3 + traffico_oraMorning.Peak.Time.4 + traffico_oraEvening.Peak.Time.1 + traffico_oraEvening.Peak.Time.2 + traffico_oraEvening.Peak.Time.3 + traffico_oraEvening.Peak.Time.4 + strata(trans), data = prova_exp_1, method = "breslow")
summary(cox_FasciaOraria_1)

cox_FasciaOraria_breve_1 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + saturazione.2 + saturazione.3 + fenom1.2 + traffico_oraMorning.Peak.Time.1 + traffico_oraMorning.Peak.Time.2 + traffico_oraEvening.Peak.Time.1 + traffico_oraEvening.Peak.Time.2 + traffico_oraEvening.Peak.Time.4 + strata(trans), data = prova_exp_1, method = "breslow")
summary(cox_FasciaOraria_breve_1)
```

Ora plotto gli HR:
```{r}
# Prepara i dati (come prima)
tidy_cox <- broom::tidy(cox_FasciaOraria_1, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""))

color_map <- c(
  "OnTime → Mild Delay" = "#F43F56",
  "MildDelay → SevereDelay" = "#F43F56",
  "SevereDelay → MildDelay" = "#00B88D",
  "MildDelay → OnTime" = "#00B88D"
)

# Prendi tutti i nomi unici delle covariate
covariate_names <- unique(tidy_cox$covariate)

# Lista vuota per salvare i plot
plots <- list()

# Ciclo per creare un plot per ogni covariata
for (cov in covariate_names) {
  df_cov <- tidy_cox %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high, color = trans_label)) +
    geom_pointrange(size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map) +
    coord_flip() +
    labs(title = paste("HR per transizioni - Covariata:", cov),
         x = "Transition",
         y = "Hazard Ratio (esponenziale del coefficiente)",
         color = "Transizione") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "none")
  
  plots[[cov]] <- p
}

#Modifica i titoletti:
#saliti:
plots[["saliti"]]$labels[2] <- "HR (50 people)"
plots[["saliti"]]$labels[4] <- "Hazard Ratios with 95% CI for Boarded"
#scesi:
plots[["scesi"]]$labels[2] <- "HR (50 people)"
plots[["scesi"]]$labels[4] <- "Hazard Ratios with 95% CI for Alighted"
#fenom1:
plots[["fenom1"]]$labels[2] <- "HR (Clear)"
plots[["fenom1"]]$labels[4] <- "Hazard Ratios with 95% CI for Adverse Weather"
#saturazione:
plots[["saturazione"]]$labels[2] <- "HR (2 trains)"
plots[["saturazione"]]$labels[4] <- "Hazard Ratios with 95% CI for Train Frequency per Hour"
#traffico_oraMorning.Peak.Time:
plots[["traffico_oraMorning.Peak.Time"]]$labels[2] <- "HR (Off-Peak Time)"
plots[["traffico_oraMorning.Peak.Time"]]$labels[4] <- "Hazard Ratios with 95% CI for Morning-Peak Time"
#traffico_oraEvening.Peak.Time:
plots[["traffico_oraEvening.Peak.Time"]]$labels[2] <- "HR (Off-Peak Time)"
plots[["traffico_oraEvening.Peak.Time"]]$labels[4] <- "Hazard Ratios with 95% CI for Evening-Peak Time"

# Plot:
print(plots[["saliti"]])
print(plots[["scesi"]])
print(plots[["fenom1"]])
print(plots[["saturazione"]])
print(plots[["traffico_oraMorning.Peak.Time"]])
print(plots[["traffico_oraEvening.Peak.Time"]])
```


Grafici Probabilità di transizione:

1- Analisi fascia oraria x passeggeri (min) - direzione 1
```{r}
# quantile(prova$saliti, probs = c(0.15, 0.85))
# quantile(prova$scesi, probs = c(0.15, 0.85))
# saliti_min <- 0.04
# saliti_max <- 0.98 
# scesi_min <- 0.10
# scesi_max <- 1.08

wh_mattina_passeggeri_min_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Morning-Peak Time")
mattina_passeggeri_min_1 <- prova_1[rep(wh_mattina_passeggeri_min_1[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_passeggeri_min_1$trans <- 1:4
mattina_passeggeri_min_1$saliti <-  saliti_min
mattina_passeggeri_min_1$scesi <- scesi_min
mattina_passeggeri_min_1$saturazione <- mean(prova$saturazione)
attr(mattina_passeggeri_min_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_passeggeri_min_1_exp <- expand.covs(mattina_passeggeri_min_1, cov, longnames = TRUE)
mattina_passeggeri_min_1_exp$strata <- mattina_passeggeri_min_1_exp$trans
ms_mattina_passeggeri_min_1 <- msfit(cox_FasciaOraria_breve_1, mattina_passeggeri_min_1_exp, trans = tmat)
prob_mattina_passeggeri_min_1 <- probtrans(ms_mattina_passeggeri_min_1, predt = 0)

wh_pome_passeggeri_min_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Off-Peak Time")
pome_passeggeri_min_1 <- prova_1[rep(wh_pome_passeggeri_min_1[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_passeggeri_min_1$trans <- 1:4
pome_passeggeri_min_1$saliti <-  saliti_min
pome_passeggeri_min_1$scesi <- scesi_min
pome_passeggeri_min_1$saturazione <- mean(prova$saturazione)
attr(pome_passeggeri_min_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_passeggeri_min_1_exp <- expand.covs(pome_passeggeri_min_1, cov, longnames = TRUE)
pome_passeggeri_min_1_exp$strata <- pome_passeggeri_min_1_exp$trans
ms_pome_passeggeri_min_1 <- msfit(cox_FasciaOraria_breve_1, pome_passeggeri_min_1_exp, trans = tmat)
prob_pome_passeggeri_min_1 <- probtrans(ms_pome_passeggeri_min_1, predt = 0)

wh_sera_passeggeri_min_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Evening-Peak Time")
sera_passeggeri_min_1 <- prova_1[rep(wh_sera_passeggeri_min_1[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_passeggeri_min_1$trans <- 1:4
sera_passeggeri_min_1$saliti <-  saliti_min
sera_passeggeri_min_1$scesi <- scesi_min
sera_passeggeri_min_1$saturazione <- mean(prova$saturazione)
attr(sera_passeggeri_min_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_passeggeri_min_1_exp <- expand.covs(sera_passeggeri_min_1, cov, longnames = TRUE)
sera_passeggeri_min_1_exp$strata <- sera_passeggeri_min_1_exp$trans
ms_sera_passeggeri_min_1 <- msfit(cox_FasciaOraria_breve_1, sera_passeggeri_min_1_exp, trans = tmat)
prob_sera_passeggeri_min_1 <- probtrans(ms_sera_passeggeri_min_1, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_passeggeri_min_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_passeggeri_min_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_passeggeri_min_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_passeggeri_min_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_passeggeri_min_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_passeggeri_min_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_passeggeri_min_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_passeggeri_min_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_passeggeri_min_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Passengers (min) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

2- Analisi fascia oraria x passeggeri (max) - direzione 1
```{r}
# quantile(prova$saliti, probs = c(0.15, 0.85))
# quantile(prova$scesi, probs = c(0.15, 0.85))
# saliti_min <- 0.04
# saliti_max <- 0.98 
# scesi_min <- 0.10
# scesi_max <- 1.08

wh_mattina_passeggeri_max_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Morning-Peak Time")
mattina_passeggeri_max_1 <- prova_1[rep(wh_mattina_passeggeri_max_1[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_passeggeri_max_1$trans <- 1:4
mattina_passeggeri_max_1$saliti <-  saliti_max
mattina_passeggeri_max_1$scesi <- scesi_max
mattina_passeggeri_max_1$saturazione <- mean(prova$saturazione)
attr(mattina_passeggeri_max_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_passeggeri_max_1_exp <- expand.covs(mattina_passeggeri_max_1, cov, longnames = TRUE)
mattina_passeggeri_max_1_exp$strata <- mattina_passeggeri_max_1_exp$trans
ms_mattina_passeggeri_max_1 <- msfit(cox_FasciaOraria_breve_1, mattina_passeggeri_max_1_exp, trans = tmat)
prob_mattina_passeggeri_max_1 <- probtrans(ms_mattina_passeggeri_max_1, predt = 0)

wh_pome_passeggeri_max_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Off-Peak Time")
pome_passeggeri_max_1 <- prova_1[rep(wh_pome_passeggeri_max_1[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_passeggeri_max_1$trans <- 1:4
pome_passeggeri_max_1$saliti <-  saliti_max
pome_passeggeri_max_1$scesi <- scesi_max
pome_passeggeri_max_1$saturazione <- mean(prova$saturazione)
attr(pome_passeggeri_max_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_passeggeri_max_1_exp <- expand.covs(pome_passeggeri_max_1, cov, longnames = TRUE)
pome_passeggeri_max_1_exp$strata <- pome_passeggeri_max_1_exp$trans
ms_pome_passeggeri_max_1 <- msfit(cox_FasciaOraria_breve_1, pome_passeggeri_max_1_exp, trans = tmat)
prob_pome_passeggeri_max_1 <- probtrans(ms_pome_passeggeri_max_1, predt = 0)

wh_sera_passeggeri_max_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Evening-Peak Time")
sera_passeggeri_max_1 <- prova_1[rep(wh_sera_passeggeri_max_1[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_passeggeri_max_1$trans <- 1:4
sera_passeggeri_max_1$saliti <-  saliti_max
sera_passeggeri_max_1$scesi <- scesi_max
sera_passeggeri_max_1$saturazione <- mean(prova$saturazione)
attr(sera_passeggeri_max_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_passeggeri_max_1_exp <- expand.covs(sera_passeggeri_max_1, cov, longnames = TRUE)
sera_passeggeri_max_1_exp$strata <- sera_passeggeri_max_1_exp$trans
ms_sera_passeggeri_max_1 <- msfit(cox_FasciaOraria_breve_1, sera_passeggeri_max_1_exp, trans = tmat)
prob_sera_passeggeri_max_1 <- probtrans(ms_sera_passeggeri_max_1, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_passeggeri_max_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_passeggeri_max_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_passeggeri_max_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_passeggeri_max_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_passeggeri_max_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_passeggeri_max_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_passeggeri_max_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_passeggeri_max_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_passeggeri_max_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Passengers (max) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

3- Analisi fascia oraria x meteo (good) - direzione 1
```{r}
wh_mattina_meteo_good_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Morning-Peak Time")
mattina_meteo_good_1 <- prova_1[rep(wh_mattina_meteo_good_1[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_meteo_good_1$trans <- 1:4
mattina_meteo_good_1$saliti <-  mean(prova$saliti)
mattina_meteo_good_1$scesi <- mean(prova$scesi)
mattina_meteo_good_1$saturazione <- mean(prova$saturazione)
attr(mattina_meteo_good_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_meteo_good_1_exp <- expand.covs(mattina_meteo_good_1, cov, longnames = TRUE)
mattina_meteo_good_1_exp$strata <- mattina_meteo_good_1_exp$trans
ms_mattina_meteo_good_1 <- msfit(cox_FasciaOraria_breve_1, mattina_meteo_good_1_exp, trans = tmat)
prob_mattina_meteo_good_1 <- probtrans(ms_mattina_meteo_good_1, predt = 0)

wh_pome_meteo_good_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Off-Peak Time")
pome_meteo_good_1 <- prova_1[rep(wh_pome_meteo_good_1[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_meteo_good_1$trans <- 1:4
pome_meteo_good_1$saliti <-  mean(prova$saliti)
pome_meteo_good_1$scesi <- mean(prova$scesi)
pome_meteo_good_1$saturazione <- mean(prova$saturazione)
attr(pome_meteo_good_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_meteo_good_1_exp <- expand.covs(pome_meteo_good_1, cov, longnames = TRUE)
pome_meteo_good_1_exp$strata <- pome_meteo_good_1_exp$trans
ms_pome_meteo_good_1 <- msfit(cox_FasciaOraria_breve_1, pome_meteo_good_1_exp, trans = tmat)
prob_pome_meteo_good_1 <- probtrans(ms_pome_meteo_good_1, predt = 0)

wh_sera_meteo_good_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Evening-Peak Time")
sera_meteo_good_1 <- prova_1[rep(wh_sera_meteo_good_1[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_meteo_good_1$trans <- 1:4
sera_meteo_good_1$saliti <- mean(prova$saliti)
sera_meteo_good_1$scesi <- mean(prova$scesi)
sera_meteo_good_1$saturazione <- mean(prova$saturazione)
attr(sera_meteo_good_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_meteo_good_1_exp <- expand.covs(sera_meteo_good_1, cov, longnames = TRUE)
sera_meteo_good_1_exp$strata <- sera_meteo_good_1_exp$trans
ms_sera_meteo_good_1 <- msfit(cox_FasciaOraria_breve_1, sera_meteo_good_1_exp, trans = tmat)
prob_sera_meteo_good_1 <- probtrans(ms_sera_meteo_good_1, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_meteo_good_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_meteo_good_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_meteo_good_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_meteo_good_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_meteo_good_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_meteo_good_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_meteo_good_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_meteo_good_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_meteo_good_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Clear Weather per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

4- Analisi fascia oraria x meteo (bad) - direzione 1
```{r}
wh_mattina_meteo_bad_1 <- which(prova_1$fenom == 1 & prova_1$traffico_ora == "Morning-Peak Time")
mattina_meteo_bad_1 <- prova_1[rep(wh_mattina_meteo_bad_1[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_meteo_bad_1$trans <- 1:4
mattina_meteo_bad_1$saliti <-  mean(prova$saliti)
mattina_meteo_bad_1$scesi <- mean(prova$scesi)
mattina_meteo_bad_1$saturazione <- mean(prova$saturazione)
attr(mattina_meteo_bad_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_meteo_bad_1_exp <- expand.covs(mattina_meteo_bad_1, cov, longnames = TRUE)
mattina_meteo_bad_1_exp$strata <- mattina_meteo_bad_1_exp$trans
ms_mattina_meteo_bad_1 <- msfit(cox_FasciaOraria_breve_1, mattina_meteo_bad_1_exp, trans = tmat)
prob_mattina_meteo_bad_1 <- probtrans(ms_mattina_meteo_bad_1, predt = 0)

wh_pome_meteo_bad_1 <- which(prova_1$fenom == 1 & prova_1$traffico_ora == "Off-Peak Time")
pome_meteo_bad_1 <- prova_1[rep(wh_pome_meteo_bad_1[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_meteo_bad_1$trans <- 1:4
pome_meteo_bad_1$saliti <-  mean(prova$saliti)
pome_meteo_bad_1$scesi <- mean(prova$scesi)
pome_meteo_bad_1$saturazione <- mean(prova$saturazione)
attr(pome_meteo_bad_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_meteo_bad_1_exp <- expand.covs(pome_meteo_bad_1, cov, longnames = TRUE)
pome_meteo_bad_1_exp$strata <- pome_meteo_bad_1_exp$trans
ms_pome_meteo_bad_1 <- msfit(cox_FasciaOraria_breve_1, pome_meteo_bad_1_exp, trans = tmat)
prob_pome_meteo_bad_1 <- probtrans(ms_pome_meteo_bad_1, predt = 0)

wh_sera_meteo_bad_1 <- which(prova_1$fenom == 1 & prova_1$traffico_ora == "Evening-Peak Time")
sera_meteo_bad_1 <- prova_1[rep(wh_sera_meteo_bad_1[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_meteo_bad_1$trans <- 1:4
sera_meteo_bad_1$saliti <- mean(prova$saliti)
sera_meteo_bad_1$scesi <- mean(prova$scesi)
sera_meteo_bad_1$saturazione <- mean(prova$saturazione)
attr(sera_meteo_bad_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_meteo_bad_1_exp <- expand.covs(sera_meteo_bad_1, cov, longnames = TRUE)
sera_meteo_bad_1_exp$strata <- sera_meteo_bad_1_exp$trans
ms_sera_meteo_bad_1 <- msfit(cox_FasciaOraria_breve_1, sera_meteo_bad_1_exp, trans = tmat)
prob_sera_meteo_bad_1 <- probtrans(ms_sera_meteo_bad_1, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_meteo_bad_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_meteo_bad_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_meteo_bad_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_meteo_bad_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_meteo_bad_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_meteo_bad_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_meteo_bad_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_meteo_bad_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_meteo_bad_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Adverse Weather per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

5- Analisi fascia oraria x saturazione (min) - direzione 1
```{r}
# saturazione_val_min <- 2 #4/2 --> Zona Varese
# saturazione_val_max <- 12 #24/2 --> Milano

wh_mattina_saturazione_min_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Morning-Peak Time")
mattina_saturazione_min_1 <- prova_1[rep(wh_mattina_saturazione_min_1[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_saturazione_min_1$trans <- 1:4
mattina_saturazione_min_1$saliti <-  mean(prova$saliti)
mattina_saturazione_min_1$scesi <- mean(prova$scesi)
mattina_saturazione_min_1$saturazione <- saturazione_val_min
attr(mattina_saturazione_min_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_saturazione_min_1_exp <- expand.covs(mattina_saturazione_min_1, cov, longnames = TRUE)
mattina_saturazione_min_1_exp$strata <- mattina_saturazione_min_1_exp$trans
ms_mattina_saturazione_min_1 <- msfit(cox_FasciaOraria_breve_1, mattina_saturazione_min_1_exp, trans = tmat)
prob_mattina_saturazione_min_1 <- probtrans(ms_mattina_saturazione_min_1, predt = 0)

wh_pome_saturazione_min_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Off-Peak Time")
pome_saturazione_min_1 <- prova_1[rep(wh_pome_saturazione_min_1[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_saturazione_min_1$trans <- 1:4
pome_saturazione_min_1$saliti <- mean(prova$saliti)
pome_saturazione_min_1$scesi <- mean(prova$scesi)
pome_saturazione_min_1$saturazione <- saturazione_val_min
attr(pome_saturazione_min_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_saturazione_min_1_exp <- expand.covs(pome_saturazione_min_1, cov, longnames = TRUE)
pome_saturazione_min_1_exp$strata <- pome_saturazione_min_1_exp$trans
ms_pome_saturazione_min_1 <- msfit(cox_FasciaOraria_breve_1, pome_saturazione_min_1_exp, trans = tmat)
prob_pome_saturazione_min_1 <- probtrans(ms_pome_saturazione_min_1, predt = 0)

wh_sera_saturazione_min_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Evening-Peak Time")
sera_saturazione_min_1 <- prova_1[rep(wh_sera_saturazione_min_1[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_saturazione_min_1$trans <- 1:4
sera_saturazione_min_1$saliti <-  mean(prova$saliti)
sera_saturazione_min_1$scesi <- mean(prova$scesi)
sera_saturazione_min_1$saturazione <- saturazione_val_min
attr(sera_saturazione_min_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_saturazione_min_1_exp <- expand.covs(sera_saturazione_min_1, cov, longnames = TRUE)
sera_saturazione_min_1_exp$strata <- sera_saturazione_min_1_exp$trans
ms_sera_saturazione_min_1 <- msfit(cox_FasciaOraria_breve_1, sera_saturazione_min_1_exp, trans = tmat)
prob_sera_saturazione_min_1 <- probtrans(ms_sera_saturazione_min_1, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_saturazione_min_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_saturazione_min_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_saturazione_min_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_saturazione_min_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_saturazione_min_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_saturazione_min_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_saturazione_min_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_saturazione_min_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_saturazione_min_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Train Frequency per Hour (min) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

6- Analisi fascia oraria x saturazione (max) - direzione 1
```{r}
# saturazione_val_min <- 2 #4/2 --> Zona Varese
# saturazione_val_max <- 12 #24/2 --> Milano

wh_mattina_saturazione_max_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Morning-Peak Time")
mattina_saturazione_max_1 <- prova_1[rep(wh_mattina_saturazione_max_1[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_saturazione_max_1$trans <- 1:4
mattina_saturazione_max_1$saliti <-  mean(prova$saliti)
mattina_saturazione_max_1$scesi <- mean(prova$scesi)
mattina_saturazione_max_1$saturazione <- saturazione_val_max
attr(mattina_saturazione_max_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_saturazione_max_1_exp <- expand.covs(mattina_saturazione_max_1, cov, longnames = TRUE)
mattina_saturazione_max_1_exp$strata <- mattina_saturazione_max_1_exp$trans
ms_mattina_saturazione_max_1 <- msfit(cox_FasciaOraria_breve_1, mattina_saturazione_max_1_exp, trans = tmat)
prob_mattina_saturazione_max_1 <- probtrans(ms_mattina_saturazione_max_1, predt = 0)

wh_pome_saturazione_max_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Off-Peak Time")
pome_saturazione_max_1 <- prova_1[rep(wh_pome_saturazione_max_1[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_saturazione_max_1$trans <- 1:4
pome_saturazione_max_1$saliti <- mean(prova$saliti)
pome_saturazione_max_1$scesi <- mean(prova$scesi)
pome_saturazione_max_1$saturazione <- saturazione_val_max
attr(pome_saturazione_max_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_saturazione_max_1_exp <- expand.covs(pome_saturazione_max_1, cov, longnames = TRUE)
pome_saturazione_max_1_exp$strata <- pome_saturazione_max_1_exp$trans
ms_pome_saturazione_max_1 <- msfit(cox_FasciaOraria_breve_1, pome_saturazione_max_1_exp, trans = tmat)
prob_pome_saturazione_max_1 <- probtrans(ms_pome_saturazione_max_1, predt = 0)

wh_sera_saturazione_max_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Evening-Peak Time")
sera_saturazione_max_1 <- prova_1[rep(wh_sera_saturazione_max_1[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_saturazione_max_1$trans <- 1:4
sera_saturazione_max_1$saliti <-  mean(prova$saliti)
sera_saturazione_max_1$scesi <- mean(prova$scesi)
sera_saturazione_max_1$saturazione <- saturazione_val_max
attr(sera_saturazione_max_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_saturazione_max_1_exp <- expand.covs(sera_saturazione_max_1, cov, longnames = TRUE)
sera_saturazione_max_1_exp$strata <- sera_saturazione_max_1_exp$trans
ms_sera_saturazione_max_1 <- msfit(cox_FasciaOraria_breve_1, sera_saturazione_max_1_exp, trans = tmat)
prob_sera_saturazione_max_1 <- probtrans(ms_sera_saturazione_max_1, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_saturazione_max_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_saturazione_max_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_saturazione_max_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_saturazione_max_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_saturazione_max_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_saturazione_max_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_saturazione_max_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_saturazione_max_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_saturazione_max_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Train Frequency per Hour (max) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

7- Analisi fascia oraria x bestcase - direzione 1
```{r}
wh_mattina_best_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Morning-Peak Time")
mattina_best_1 <- prova_1[rep(wh_mattina_best_1[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_best_1$trans <- 1:4
mattina_best_1$saliti <-  saliti_min
mattina_best_1$scesi <- scesi_min
mattina_best_1$saturazione <- saturazione_val_min
attr(mattina_best_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_best_1_exp <- expand.covs(mattina_best_1, cov, longnames = TRUE)
mattina_best_1_exp$strata <- mattina_best_1_exp$trans
ms_mattina_best_1 <- msfit(cox_FasciaOraria_breve_1, mattina_best_1_exp, trans = tmat)
prob_mattina_best_1 <- probtrans(ms_mattina_best_1, predt = 0)

wh_pome_best_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Off-Peak Time")
pome_best_1 <- prova_1[rep(wh_pome_best_1[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_best_1$trans <- 1:4
pome_best_1$saliti <-  saliti_min
pome_best_1$scesi <- scesi_min
pome_best_1$saturazione <- saturazione_val_min
attr(pome_best_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_best_1_exp <- expand.covs(pome_best_1, cov, longnames = TRUE)
pome_best_1_exp$strata <- pome_best_1_exp$trans
ms_pome_best_1 <- msfit(cox_FasciaOraria_breve_1, pome_best_1_exp, trans = tmat)
prob_pome_best_1 <- probtrans(ms_pome_best_1, predt = 0)

wh_sera_best_1 <- which(prova_1$fenom == 0 & prova_1$traffico_ora == "Evening-Peak Time")
sera_best_1 <- prova_1[rep(wh_sera_best_1[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_best_1$trans <- 1:4
sera_best_1$saliti <- saliti_min
sera_best_1$scesi <- scesi_min
sera_best_1$saturazione <- saturazione_val_min
attr(sera_best_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_best_1_exp <- expand.covs(sera_best_1, cov, longnames = TRUE)
sera_best_1_exp$strata <- sera_best_1_exp$trans
ms_sera_best_1 <- msfit(cox_FasciaOraria_breve_1, sera_best_1_exp, trans = tmat)
prob_sera_best_1 <- probtrans(ms_sera_best_1, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_best_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_best_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_best_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_best_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_best_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_best_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_best_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_best_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_best_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Best Case Scenario per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

8- Analisi fascia oraria x worstcase - direzione 1
```{r}
wh_mattina_worst_1 <- which(prova_1$fenom == 1 & prova_1$traffico_ora == "Morning-Peak Time")
mattina_worst_1 <- prova_1[rep(wh_mattina_worst_1[1], 4), c(17, 18, 20, 21, 23, 24)]
mattina_worst_1$trans <- 1:4
mattina_worst_1$saliti <-  saliti_max
mattina_worst_1$scesi <- scesi_max
mattina_worst_1$saturazione <- saturazione_val_max
attr(mattina_worst_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
mattina_worst_1_exp <- expand.covs(mattina_worst_1, cov, longnames = TRUE)
mattina_worst_1_exp$strata <- mattina_worst_1_exp$trans
ms_mattina_worst_1 <- msfit(cox_FasciaOraria_breve_1, mattina_worst_1_exp, trans = tmat)
prob_mattina_worst_1 <- probtrans(ms_mattina_worst_1, predt = 0)

wh_pome_worst_1 <- which(prova_1$fenom == 1 & prova_1$traffico_ora == "Off-Peak Time")
pome_worst_1 <- prova_1[rep(wh_pome_worst_1[1], 4), c(17, 18, 20, 21, 23, 24)]
pome_worst_1$trans <- 1:4
pome_worst_1$saliti <-  saliti_max
pome_worst_1$scesi <- scesi_max
pome_worst_1$saturazione <- saturazione_val_max
attr(pome_worst_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "traffico_ora")
pome_worst_1_exp <- expand.covs(pome_worst_1, cov, longnames = TRUE)
pome_worst_1_exp$strata <- pome_worst_1_exp$trans
ms_pome_worst_1 <- msfit(cox_FasciaOraria_breve_1, pome_worst_1_exp, trans = tmat)
prob_pome_worst_1 <- probtrans(ms_pome_worst_1, predt = 0)

wh_sera_worst_1 <- which(prova_1$fenom == 1 & prova_1$traffico_ora == "Evening-Peak Time")
sera_worst_1 <- prova_1[rep(wh_sera_worst_1[1], 4), c(17, 18, 20, 21, 23, 24)]
sera_worst_1$trans <- 1:4
sera_worst_1$saliti <- saliti_max
sera_worst_1$scesi <- scesi_max
sera_worst_1$saturazione <- saturazione_val_max
attr(sera_worst_1, "trans") <- tmat
cov <- c("saliti", "scesi", "saturazione", "fenom", "direzione", "traffico_ora")
sera_worst_1_exp <- expand.covs(sera_worst_1, cov, longnames = TRUE)
sera_worst_1_exp$strata <- sera_worst_1_exp$trans
ms_sera_worst_1 <- msfit(cox_FasciaOraria_breve_1, sera_worst_1_exp, trans = tmat)
prob_sera_worst_1 <- probtrans(ms_sera_worst_1, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_mattina_worst_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_mattina_worst_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_mattina_worst_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_pome_worst_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_pome_worst_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_pome_worst_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_sera_worst_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_sera_worst_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_sera_worst_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 3, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Worst Case Scenario per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```



###Modello con covariate: Zona (Separato per direzione) ---- 
Costruisco il modello di base con tutte le covariate e tolgo subito quelle non significative:
```{r}
cox_Zona_1 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + zonaZone.3.1 + zonaZone.3.2 + zonaZone.3.3 + zonaZone.3.4 + zonaZone.2.1 + zonaZone.2.2 + zonaZone.2.3 + zonaZone.2.4 + zonaZone.1.1 + zonaZone.1.2 + zonaZone.1.3 + zonaZone.1.4 + strata(trans), data = prova_exp_1, method = "breslow")
summary(cox_Zona_1)

cox_Zona_breve_1 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + scesi.2 + scesi.4 + zonaZone.3.1 + zonaZone.3.2 + zonaZone.3.3 + zonaZone.2.1 + zonaZone.2.2 + zonaZone.2.3 + zonaZone.2.4 + zonaZone.1.2 + zonaZone.1.3 + strata(trans), data = prova_exp_1, method = "breslow")
summary(cox_Zona_breve_1)
```

Ora plotto gli HR:
```{r}
# Prepara i dati (come prima)
tidy_cox <- broom::tidy(cox_Zona_1, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""))

color_map <- c(
  "OnTime → Mild Delay" = "#F43F56",
  "MildDelay → SevereDelay" = "#F43F56",
  "SevereDelay → MildDelay" = "#00B88D",
  "MildDelay → OnTime" = "#00B88D"
)

# Prendi tutti i nomi unici delle covariate
covariate_names <- unique(tidy_cox$covariate)

# Lista vuota per salvare i plot
plots <- list()

# Ciclo per creare un plot per ogni covariata
for (cov in covariate_names) {
  df_cov <- tidy_cox %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high, color = trans_label)) +
    geom_pointrange(size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map) +
    coord_flip() +
    labs(title = paste("HR per transizioni - Covariata:", cov),
         x = "Transition",
         y = "Hazard Ratio (esponenziale del coefficiente)",
         color = "Transizione") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "none")
  
  plots[[cov]] <- p
}

#Modifica i titoletti:
#saliti:
plots[["saliti"]]$labels[2] <- "HR (50 people)"
plots[["saliti"]]$labels[4] <- "Hazard Ratios with 95% CI for Boarded"
#scesi:
plots[["scesi"]]$labels[2] <- "HR (50 people)"
plots[["scesi"]]$labels[4] <- "Hazard Ratios with 95% CI for Alighted"
#zonaZone.1:
plots[["zonaZone.1"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zonaZone.1"]]$labels[4] <- "Hazard Ratios with 95% CI for Varese - Gallarate"
#zonaZone.2:
plots[["zonaZone.2"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zonaZone.2"]]$labels[4] <- "Hazard Ratios with 95% CI for Busto Arsizio - Rho Fiera"
#zonaZone.3:
plots[["zonaZone.3"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zonaZone.3"]]$labels[4] <- "Hazard Ratios with 95% CI for Milano Certosa - Milano Forlanini"

# Plot:
print(plots[["saliti"]])
print(plots[["scesi"]])
print(plots[["zonaZone.1"]])
print(plots[["zonaZone.2"]])
print(plots[["zonaZone.3"]])
```


Grafici Probabilità di transizione:

1- Analisi zona x passeggeri (min) - direzione 1
```{r}
# quantile(prova$saliti, probs = c(0.15, 0.85))
# quantile(prova$scesi, probs = c(0.15, 0.85))
# saliti_min <- 0.04
# saliti_max <- 0.98 
# scesi_min <- 0.10
# scesi_max <- 1.08

wh_VaGa_passeggeri_min_1 <- which(prova_1$zona == "Zone 1")
VaGa_passeggeri_min_1 <- prova_1[rep(wh_VaGa_passeggeri_min_1[1], 4), c(17, 18, 20, 22)]
VaGa_passeggeri_min_1$trans <- 1:4
VaGa_passeggeri_min_1$saliti <-  saliti_min
VaGa_passeggeri_min_1$scesi <- scesi_min
attr(VaGa_passeggeri_min_1, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
VaGa_passeggeri_min_1_exp <- expand.covs(VaGa_passeggeri_min_1, cov, longnames = TRUE)
VaGa_passeggeri_min_1_exp$strata <- VaGa_passeggeri_min_1_exp$trans
ms_VaGa_passeggeri_min_1 <- msfit(cox_Zona_breve_1, VaGa_passeggeri_min_1_exp, trans = tmat)
prob_VaGa_passeggeri_min_1 <- probtrans(ms_VaGa_passeggeri_min_1, predt = 0)

wh_BuRho_passeggeri_min_1 <- which(prova_1$zona == "Zone 2")
BuRho_passeggeri_min_1 <- prova_1[rep(wh_BuRho_passeggeri_min_1[1], 4), c(17, 18, 20, 22)]
BuRho_passeggeri_min_1$trans <- 1:4
BuRho_passeggeri_min_1$saliti <-  saliti_min
BuRho_passeggeri_min_1$scesi <- scesi_min
attr(BuRho_passeggeri_min_1, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
BuRho_passeggeri_min_1_exp <- expand.covs(BuRho_passeggeri_min_1, cov, longnames = TRUE)
BuRho_passeggeri_min_1_exp$strata <- BuRho_passeggeri_min_1_exp$trans
ms_BuRho_passeggeri_min_1 <- msfit(cox_Zona_breve_1, BuRho_passeggeri_min_1_exp, trans = tmat)
prob_BuRho_passeggeri_min_1 <- probtrans(ms_BuRho_passeggeri_min_1, predt = 0)

wh_Milano_passeggeri_min_1 <- which(prova_1$zona == "Zone 3")
Milano_passeggeri_min_1 <- prova_1[rep(wh_Milano_passeggeri_min_1[1], 4), c(17, 18, 20, 22)]
Milano_passeggeri_min_1$trans <- 1:4
Milano_passeggeri_min_1$saliti <-  saliti_min
Milano_passeggeri_min_1$scesi <- scesi_min
attr(Milano_passeggeri_min_1, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
Milano_passeggeri_min_1_exp <- expand.covs(Milano_passeggeri_min_1, cov, longnames = TRUE)
Milano_passeggeri_min_1_exp$strata <- Milano_passeggeri_min_1_exp$trans
ms_Milano_passeggeri_min_1 <- msfit(cox_Zona_breve_1, Milano_passeggeri_min_1_exp, trans = tmat)
prob_Milano_passeggeri_min_1 <- probtrans(ms_Milano_passeggeri_min_1, predt = 0)

wh_SeTre_passeggeri_min_1 <- which(prova_1$zona == "Zone 4")
SeTre_passeggeri_min_1 <- prova_1[rep(wh_SeTre_passeggeri_min_1[1], 4), c(17, 18, 20, 22)]
SeTre_passeggeri_min_1$trans <- 1:4
SeTre_passeggeri_min_1$saliti <-  saliti_min
SeTre_passeggeri_min_1$scesi <- scesi_min
attr(SeTre_passeggeri_min_1, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
SeTre_passeggeri_min_1_exp <- expand.covs(SeTre_passeggeri_min_1, cov, longnames = TRUE)
SeTre_passeggeri_min_1_exp$strata <- SeTre_passeggeri_min_1_exp$trans
ms_SeTre_passeggeri_min_1 <- msfit(cox_Zona_breve_1, SeTre_passeggeri_min_1_exp, trans = tmat)
prob_SeTre_passeggeri_min_1 <- probtrans(ms_SeTre_passeggeri_min_1, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_SeTre_passeggeri_min_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_SeTre_passeggeri_min_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_SeTre_passeggeri_min_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_Milano_passeggeri_min_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_Milano_passeggeri_min_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_Milano_passeggeri_min_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_BuRho_passeggeri_min_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_BuRho_passeggeri_min_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_BuRho_passeggeri_min_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p10<-plot(prob_VaGa_passeggeri_min_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p10 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p11<-plot(prob_VaGa_passeggeri_min_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p11 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p12<-plot(prob_VaGa_passeggeri_min_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p12 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p10 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p11 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p12 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 4, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Passengers (min) per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

2- Analisi zona x passeggeri (max) - direzione 1
```{r}
wh_VaGa_passeggeri_max_1 <- which(prova_1$zona == "Zone 1")
VaGa_passeggeri_max_1 <- prova_1[rep(wh_VaGa_passeggeri_max_1[1], 4), c(17, 18, 20, 22)]
VaGa_passeggeri_max_1$trans <- 1:4
VaGa_passeggeri_max_1$saliti <-  saliti_max
VaGa_passeggeri_max_1$scesi <- scesi_max
attr(VaGa_passeggeri_max_1, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
VaGa_passeggeri_max_1_exp <- expand.covs(VaGa_passeggeri_max_1, cov, longnames = TRUE)
VaGa_passeggeri_max_1_exp$strata <- VaGa_passeggeri_max_1_exp$trans
ms_VaGa_passeggeri_max_1 <- msfit(cox_Zona_breve_1, VaGa_passeggeri_max_1_exp, trans = tmat)
prob_VaGa_passeggeri_max_1 <- probtrans(ms_VaGa_passeggeri_max_1, predt = 0)

wh_BuRho_passeggeri_max_1 <- which(prova_1$zona == "Zone 2")
BuRho_passeggeri_max_1 <- prova_1[rep(wh_BuRho_passeggeri_max_1[1], 4), c(17, 18, 20, 22)]
BuRho_passeggeri_max_1$trans <- 1:4
BuRho_passeggeri_max_1$saliti <-  saliti_max
BuRho_passeggeri_max_1$scesi <- scesi_max
attr(BuRho_passeggeri_max_1, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
BuRho_passeggeri_max_1_exp <- expand.covs(BuRho_passeggeri_max_1, cov, longnames = TRUE)
BuRho_passeggeri_max_1_exp$strata <- BuRho_passeggeri_max_1_exp$trans
ms_BuRho_passeggeri_max_1 <- msfit(cox_Zona_breve_1, BuRho_passeggeri_max_1_exp, trans = tmat)
prob_BuRho_passeggeri_max_1 <- probtrans(ms_BuRho_passeggeri_max_1, predt = 0)

wh_Milano_passeggeri_max_1 <- which(prova_0$zona == "Zone 3")
Milano_passeggeri_max_1 <- prova_1[rep(wh_Milano_passeggeri_max_1[1], 4), c(17, 18, 20, 22)]
Milano_passeggeri_max_1$trans <- 1:4
Milano_passeggeri_max_1$saliti <-  saliti_max
Milano_passeggeri_max_1$scesi <- scesi_max
attr(Milano_passeggeri_max_1, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
Milano_passeggeri_max_1_exp <- expand.covs(Milano_passeggeri_max_1, cov, longnames = TRUE)
Milano_passeggeri_max_1_exp$strata <- Milano_passeggeri_max_1_exp$trans
ms_Milano_passeggeri_max_1 <- msfit(cox_Zona_breve_1, Milano_passeggeri_max_1_exp, trans = tmat)
prob_Milano_passeggeri_max_1 <- probtrans(ms_Milano_passeggeri_max_1, predt = 0)

wh_SeTre_passeggeri_max_1 <- which(prova_1$zona == "Zone 4")
SeTre_passeggeri_max_1 <- prova_1[rep(wh_SeTre_passeggeri_max_1[1], 4), c(17, 18, 20, 22)]
SeTre_passeggeri_max_1$trans <- 1:4
SeTre_passeggeri_max_1$saliti <-  saliti_max
SeTre_passeggeri_max_1$scesi <- scesi_max
attr(SeTre_passeggeri_min_1, "trans") <- tmat
cov <- c("saliti", "scesi", "zona")
SeTre_passeggeri_max_1_exp <- expand.covs(SeTre_passeggeri_max_1, cov, longnames = TRUE)
SeTre_passeggeri_max_1_exp$strata <- SeTre_passeggeri_max_1_exp$trans
ms_SeTre_passeggeri_max_1 <- msfit(cox_Zona_breve_1, SeTre_passeggeri_max_1_exp, trans = tmat)
prob_SeTre_passeggeri_max_1 <- probtrans(ms_SeTre_passeggeri_max_1, predt = 0)


statecols <- c("#C3EEBF", "#FBDD88", "#E05265")
ord <- c(1,2,3)

p1<-plot(prob_SeTre_passeggeri_max_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p1 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p2<-plot(prob_SeTre_passeggeri_max_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p2 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p3<-plot(prob_SeTre_passeggeri_max_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p3 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p4<-plot(prob_Milano_passeggeri_max_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p4 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p5<-plot(prob_Milano_passeggeri_max_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p5 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p6<-plot(prob_Milano_passeggeri_max_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p6 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p7<-plot(prob_BuRho_passeggeri_max_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p7 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p8<-plot(prob_BuRho_passeggeri_max_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p8 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p9<-plot(prob_BuRho_passeggeri_max_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p9 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

p10<-plot(prob_VaGa_passeggeri_max_1, ord = ord, from=1, xlim=c(0,30), use.ggplot = TRUE)
p10 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from OnTime)",x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p11<-plot(prob_VaGa_passeggeri_max_1, ord = ord, from=2, xlim=c(0,30), use.ggplot = TRUE)
p11 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from Delay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))  # Modifica il titolo della legenda
#plot0: starting state= Ritardo nel lungo tempo
p12<-plot(prob_VaGa_passeggeri_max_1, ord = ord, from=3, xlim=c(0,30), use.ggplot = TRUE)
p12 + 
  scale_fill_manual(values = statecols) +
  theme_minimal() + 
  labs(title = "Transition Probabilities (starting from SevereDelay)", x = "Time (Minutes)", y = "Probability") +  # Aggiungi etichette
  guides(fill = guide_legend(title = "States"))

grid.arrange(
  arrangeGrob(
    p1 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p2 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p3 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p4 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p5 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p6 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p7 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p8 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p9 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p10 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From OnTime", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p11 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From MildDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    p12 + scale_fill_manual(values = statecols) +
      theme_minimal() + 
      labs(title = "From SevereDelay", 
           x = "Time (Minutes)", y = "Transition Probability") +
      guides(fill = guide_legend(title = "States")),
    
    nrow = 4, ncol = 3
  ),
  top = textGrob("Predicted Future State Probabilities for Passengers (max) per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```




##Frailty----
###Modello con covariate e frailty: Fascia Oraria (Separato per direzione) ---- 
Costruisco il modello mettendo la frailty su ID_Treno:
```{r}
# frailtyGamma_FasciaOraria_1 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + saturazione.1 + saturazione.2 + saturazione.3 + saturazione.4 + fenom1.1 + fenom1.2 + fenom1.3 + fenom1.4 + traffico_oraMorning.Peak.Time.1 + traffico_oraMorning.Peak.Time.2 + traffico_oraMorning.Peak.Time.3 + traffico_oraMorning.Peak.Time.4 + traffico_oraEvening.Peak.Time.1 + traffico_oraEvening.Peak.Time.2 + traffico_oraEvening.Peak.Time.3 + traffico_oraEvening.Peak.Time.4 + frailty(ID_Treno, distribution = "gamma") + strata(trans), data = prova_exp_1, method = "breslow")
# summary(frailtyGamma_FasciaOraria_1)
# logLik(frailtyGamma_FasciaOraria_1)
# 
# frailtyGaussian_FasciaOraria_1 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + saturazione.1 + saturazione.2 + saturazione.3 + saturazione.4 + fenom1.1 + fenom1.2 + fenom1.3 + fenom1.4 + traffico_oraMorning.Peak.Time.1 + traffico_oraMorning.Peak.Time.2 + traffico_oraMorning.Peak.Time.3 + traffico_oraMorning.Peak.Time.4 + traffico_oraEvening.Peak.Time.1 + traffico_oraEvening.Peak.Time.2 + traffico_oraEvening.Peak.Time.3 + traffico_oraEvening.Peak.Time.4 + frailty(ID_Treno, distribution = "gaussian") + strata(trans), data = prova_exp_1, method = "breslow")
# summary(frailtyGaussian_FasciaOraria_1)
# logLik(frailtyGaussian_FasciaOraria_1) #Gauss è leggermente migliore
```

Costruisco il modello mettendo la frailty su ID_Mezzo (meglio questo, qua si vede una cera eterogeneità):
```{r}
frailtyGamma_FasciaOraria_1 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + saturazione.1 + saturazione.2 + saturazione.3 + saturazione.4 + fenom1.1 + fenom1.2 + fenom1.3 + fenom1.4 + traffico_oraMorning.Peak.Time.1 + traffico_oraMorning.Peak.Time.2 + traffico_oraMorning.Peak.Time.3 + traffico_oraMorning.Peak.Time.4 + traffico_oraEvening.Peak.Time.1 + traffico_oraEvening.Peak.Time.2 + traffico_oraEvening.Peak.Time.3 + traffico_oraEvening.Peak.Time.4 + frailty(ID_Mezzo, distribution = "gamma") + strata(trans), data = prova_exp_1, method = "breslow")
summary(frailtyGamma_FasciaOraria_1)
logLik(frailtyGamma_FasciaOraria_1)

# frailtyGaussian_FasciaOraria_1 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + saturazione.1 + saturazione.2 + saturazione.3 + saturazione.4 + fenom1.1 + fenom1.2 + fenom1.3 + fenom1.4 + traffico_oraMorning.Peak.Time.1 + traffico_oraMorning.Peak.Time.2 + traffico_oraMorning.Peak.Time.3 + traffico_oraMorning.Peak.Time.4 + traffico_oraEvening.Peak.Time.1 + traffico_oraEvening.Peak.Time.2 + traffico_oraEvening.Peak.Time.3 + traffico_oraEvening.Peak.Time.4 + frailty(ID_Mezzo, distribution = "gaussian") + strata(trans), data = prova_exp_1, method = "breslow")
# summary(frailtyGaussian_FasciaOraria_1)
# logLik(frailtyGaussian_FasciaOraria_1) #Siamo lì ma leggermente meglio questo. prendo comunque il gamma per conformità con il resto
```

Ora plotto gli HR:
```{r}
# Mappa colori per le transizioni
color_map <- c(
  "OnTime → Mild Delay" = "#F43F56",
  "MildDelay → SevereDelay" = "#F43F56",
  "SevereDelay → MildDelay" = "#00B88D",
  "MildDelay → OnTime" = "#00B88D"
)

# Tidizza Cox
tidy_cox <- broom::tidy(cox_FasciaOraria_1, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""),
         model = "Cox")

# Tidizza Frailty
# Estrai coeff, confint e calcola HR
frailty_coef <- coef(frailtyGamma_FasciaOraria_1)
frailty_ci <- confint(frailtyGamma_FasciaOraria_1)

tidy_frailty <- tibble(
  term = names(frailty_coef),
  estimate = exp(frailty_coef),
  conf.low = exp(frailty_ci[, 1]),
  conf.high = exp(frailty_ci[, 2])
) %>%
  mutate(
    trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
    trans_label = factor(trans, levels = c("1","3","4","2"),
                         labels = c("OnTime → Mild Delay",
                                    "MildDelay → SevereDelay",
                                    "SevereDelay → MildDelay",
                                    "MildDelay → OnTime")),
    covariate = str_replace(term, "\\.\\d$", ""),
    model = "Frailty"
  )

# Combina i due
combined_data <- bind_rows(tidy_cox, tidy_frailty)

# Lista covariate
covariate_names <- unique(combined_data$covariate)

# Lista di plot
plots <- list()
pd <- position_dodge(width = 0.6)

# Ciclo su tutte le covariate
for (cov in covariate_names) {
  df_cov <- combined_data %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high,
                          color = trans_label, shape = model)) +
    geom_pointrange(position = pd, size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map, name = "Transition") +
    scale_shape_manual(values = c(Cox = 16, Frailty = 17),
                       labels = c("Cox model", "Frailty model"),
                       name = "Model") +
    coord_flip() +
    labs(title = paste("HR per transizioni - Covariata:", cov),
         x = "Transition",
         y = "Hazard Ratio (esponenziale del coefficiente)") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "right",
          legend.box = "vertical",
          legend.title = element_text(face = "bold"),
          legend.spacing.y = unit(0.4, 'cm'),
          legend.text = element_text(size = 11))
  
  plots[[cov]] <- p
}

# Personalizza titoli e assi per covariate selezionate
plots[["saliti"]]$labels[["y"]] <- "HR (50 people)"
plots[["saliti"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Boarded"

plots[["scesi"]]$labels[["y"]] <- "HR (50 people)"
plots[["scesi"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Alighted"

plots[["fenom1"]]$labels[["y"]] <- "HR (Clear)"
plots[["fenom1"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Adverse Weather"

plots[["saturazione"]]$labels[["y"]] <- "HR (2 trains)"
plots[["saturazione"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Train Frequency per Hour"

plots[["traffico_oraMorning.Peak.Time"]]$labels[["y"]] <- "HR (Off-Peak Time)"
plots[["traffico_oraMorning.Peak.Time"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Morning-Peak Time"

plots[["traffico_oraEvening.Peak.Time"]]$labels[["y"]] <- "HR (Off-Peak Time)"
plots[["traffico_oraEvening.Peak.Time"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Evening-Peak Time"

# Stampa dei plot
print(plots[["saliti"]])
print(plots[["scesi"]])
print(plots[["fenom1"]])
print(plots[["saturazione"]])
print(plots[["traffico_oraMorning.Peak.Time"]])
print(plots[["traffico_oraEvening.Peak.Time"]])
```


Grafici Frailty:
```{r}
# Estraggio i valori delle log(wj)
frailty_vals_FasciaOraria_1 <- frailtyGamma_FasciaOraria_1$frail

#  Assegno ID_Mezzo ai rispettivi valori di frailty e considero anche le varianze specifiche per wj:
cluster_levels_FasciaOraria_1 <- sort(unique(prova_exp_1$ID_Mezzo))
frailty_table_FasciaOraria_1 <- data.frame(ID_Mezzo = cluster_levels_FasciaOraria_1, frailty = frailtyGamma_FasciaOraria_1$frail, var=frailtyGamma_FasciaOraria_1$fvar)

#  Adesso uguale ma per ID_Treno e aggiungo anche i veri vlori wj al posto di avere frailty=log(wj):
#Morning
dati_distinct_FasciaOraria_1 <- prova_exp[!duplicated(prova_exp_1$ID_Mezzo), c("ID_Mezzo", "ID_Treno", "partenza", "traffico_ora")]
tabella_frailty_FasciaOraria_1 <- merge(frailty_table_FasciaOraria_1, dati_distinct_FasciaOraria_1, by = "ID_Mezzo")
tabella_frailty_FasciaOraria_1$wj <- exp(tabella_frailty_FasciaOraria_1$frailty)
tabella_frailty_FasciaOraria_1$partenza <- format(as.POSIXct(tabella_frailty_FasciaOraria_1$partenza), "%I:%M %p")
tabella_frailty_FasciaOraria_1$lower <- exp(tabella_frailty_FasciaOraria_1$frailty - 1.96 * sqrt(tabella_frailty_FasciaOraria_1$var))
tabella_frailty_FasciaOraria_1$upper <- exp(tabella_frailty_FasciaOraria_1$frailty + 1.96 * sqrt(tabella_frailty_FasciaOraria_1$var))
```

Plot colorato per FasciaOraria:
```{r}
orari_unici_FasciaOraria_1 <- c("Morning-Peak Time", "Off-Peak Time", "Evening-Peak Time")
tabella_frailty_FasciaOraria_1$traffico_ora <- factor(tabella_frailty_FasciaOraria_1$traffico_ora, levels = orari_unici_FasciaOraria_1)
colori_personalizzati <- c("#87CEFA", "#EB5C82", "#F59B51")
palette_orari_FasciaOraria_1 <- setNames(colori_personalizzati, orari_unici_FasciaOraria_1)

theta_FasciaOraria_1 <- 0.1276486 
down <- exp(-1.5 * sqrt(theta_FasciaOraria_1))
up <- exp(1.5 * sqrt(theta_FasciaOraria_1))

ggplot(tabella_frailty_FasciaOraria_1, aes(x = ID_Mezzo, y = wj, color = traffico_ora)) +
  geom_point(size = 2) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", linewidth = 0.4) +
  geom_hline(yintercept = up, linetype = "dashed", color = "grey", linewidth = 0.4) +
  geom_hline(yintercept = down, linetype = "dashed", color = "grey", linewidth = 0.4) +
  scale_color_manual(values = palette_orari_FasciaOraria_0) +
  labs(
    title = "Empirical Gamma Failty Terms",
    x = "Mission",
    y = "Frailty (wj)",
    color = "Time Slot"
  ) +
  theme_minimal()
```


###Modello con covariate e frailty: Zona (Separato per direzione) ---- 
Costruisco il modello mettendo la frailty su ID_Treno:
```{r}
# frailtyGamma_Zona_1 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + zonaZone.3.1 + zonaZone.3.2 + zonaZone.3.3 + zonaZone.3.4 + zonaZone.2.1 + zonaZone.2.2 + zonaZone.2.3 + zonaZone.2.4 + zonaZone.1.1 + zonaZone.1.2 + zonaZone.1.3 + zonaZone.1.4 + frailty(ID_Treno, distribution = "gamma") + strata(trans), data = prova_exp_1, method = "breslow")
# summary(frailtyGamma_Zona_1)
# logLik(frailtyGamma_Zona_1)
# 
# frailtyGaussian_Zona_1 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + zonaZone.3.1 + zonaZone.3.2 + zonaZone.3.3 + zonaZone.3.4 + zonaZone.2.1 + zonaZone.2.2 + zonaZone.2.3 + zonaZone.2.4 + zonaZone.1.1 + zonaZone.1.2 + zonaZone.1.3 + zonaZone.1.4 + frailty(ID_Treno, distribution = "gaussian") + strata(trans), data = prova_exp_1, method = "breslow")
# summary(frailtyGaussian_Zona_1)
# logLik(frailtyGaussian_Zona_1)
```

Costruisco il modello mettendo la frailty su ID_Mezzo (meglio questo, qua si vede una cera eterogeneità):
```{r}
frailtyGamma_Zona_1 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + zonaZone.3.1 + zonaZone.3.2 + zonaZone.3.3 + zonaZone.3.4 + zonaZone.2.1 + zonaZone.2.2 + zonaZone.2.3 + zonaZone.2.4 + zonaZone.1.1 + zonaZone.1.2 + zonaZone.1.3 + zonaZone.1.4 + frailty(ID_Mezzo, distribution = "gamma") + strata(trans), data = prova_exp_1, method = "breslow")
summary(frailtyGamma_Zona_1)
logLik(frailtyGamma_Zona_1)

# frailtyGaussian_Zona_1 <- coxph(Surv(time, status) ~ saliti.1 + saliti.2 + saliti.3 + saliti.4 + scesi.1 + scesi.2 +scesi.3 + scesi.4 + zonaZone.3.1 + zonaZone.3.2 + zonaZone.3.3 + zonaZone.3.4 + zonaZone.2.1 + zonaZone.2.2 + zonaZone.2.3 + zonaZone.2.4 + zonaZone.1.1 + zonaZone.1.2 + zonaZone.1.3 + zonaZone.1.4 + frailty(ID_Mezzo, distribution = "gaussian") + strata(trans), data = prova_exp_1, method = "breslow")
# summary(frailtyGaussian_Zona_1)
# logLik(frailtyGaussian_Zona_1)
```

Ora plotto gli HR:
```{r}
# Mappa colori per le transizioni
color_map <- c(
  "OnTime → Mild Delay" = "#F43F56",
  "MildDelay → SevereDelay" = "#F43F56",
  "SevereDelay → MildDelay" = "#00B88D",
  "MildDelay → OnTime" = "#00B88D"
)

# Tidizza Cox
tidy_cox <- broom::tidy(cox_Zona_1, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""),
         model = "Cox")

# Tidizza Frailty
# Estrai coeff, confint e calcola HR
frailty_coef <- coef(frailtyGamma_Zona_1)
frailty_ci <- confint(frailtyGamma_Zona_1)

tidy_frailty <- tibble(
  term = names(frailty_coef),
  estimate = exp(frailty_coef),
  conf.low = exp(frailty_ci[, 1]),
  conf.high = exp(frailty_ci[, 2])
) %>%
  mutate(
    trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
    trans_label = factor(trans, levels = c("1","3","4","2"),
                         labels = c("OnTime → Mild Delay",
                                    "MildDelay → SevereDelay",
                                    "SevereDelay → MildDelay",
                                    "MildDelay → OnTime")),
    covariate = str_replace(term, "\\.\\d$", ""),
    model = "Frailty"
  )

# Combina i due
combined_data <- bind_rows(tidy_cox, tidy_frailty)

# Lista covariate
covariate_names <- unique(combined_data$covariate)

# Lista di plot
plots <- list()
pd <- position_dodge(width = 0.6)

# Ciclo su tutte le covariate
for (cov in covariate_names) {
  df_cov <- combined_data %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high,
                          color = trans_label, shape = model)) +
    geom_pointrange(position = pd, size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map, name = "Transition") +
    scale_shape_manual(values = c(Cox = 16, Frailty = 17),
                       labels = c("Cox model", "Frailty model"),
                       name = "Model") +
    coord_flip() +
    labs(title = paste("HR per transizioni - Covariata:", cov),
         x = "Transition",
         y = "Hazard Ratio (esponenziale del coefficiente)") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "right",
          legend.box = "vertical",
          legend.title = element_text(face = "bold"),
          legend.spacing.y = unit(0.4, 'cm'),
          legend.text = element_text(size = 11))
  
  plots[[cov]] <- p
}

#Modifica i titoletti:
#saliti:
plots[["saliti"]]$labels[2] <- "HR (50 people)"
plots[["saliti"]]$labels[3] <- "Hazard Ratios with 95% CI for Boarded"
#scesi:
plots[["scesi"]]$labels[2] <- "HR (50 people)"
plots[["scesi"]]$labels[3] <- "Hazard Ratios with 95% CI for Alighted"
#zonaZone.1:
plots[["zonaZone.1"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zonaZone.1"]]$labels[3] <- "Hazard Ratios with 95% CI for Varese - Gallarate"
#zonaZone.2:
plots[["zonaZone.2"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zonaZone.2"]]$labels[3] <- "Hazard Ratios with 95% CI for Busto Arsizio - Rho Fiera"
#zonaZone.3:
plots[["zonaZone.3"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zonaZone.3"]]$labels[3] <- "Hazard Ratios with 95% CI for Milano Certosa - Milano Forlanini"

# Plot:
print(plots[["saliti"]])
print(plots[["scesi"]])
print(plots[["zonaZone.1"]])
print(plots[["zonaZone.2"]])
print(plots[["zonaZone.3"]])
```


Grafici Frailty:
```{r}
# Estraggio i valori delle log(wj)
frailty_vals_Zona_1 <- frailtyGamma_Zona_1$frail

#  Assegno ID_Mezzo ai rispettivi valori di frailty e considero anche le varianze specifiche per wj:
cluster_levels_Zona_1 <- sort(unique(prova_exp_1$ID_Mezzo))
frailty_table_Zona_1 <- data.frame(ID_Mezzo = cluster_levels_Zona_1, frailty = frailtyGamma_Zona_1$frail, var=frailtyGamma_Zona_1$fvar)

#  Adesso uguale ma per ID_Treno e aggiungo anche i veri vlori wj al posto di avere frailty=log(wj):
#Morning
dati_distinct_Zona_1 <- prova_exp[!duplicated(prova_exp_1$ID_Mezzo), c("ID_Mezzo", "ID_Treno", "partenza", "traffico_ora")]
tabella_frailty_Zona_1 <- merge(frailty_table_Zona_1, dati_distinct_Zona_1, by = "ID_Mezzo")
tabella_frailty_Zona_1$wj <- exp(tabella_frailty_Zona_1$frailty)
tabella_frailty_Zona_1$partenza <- format(as.POSIXct(tabella_frailty_Zona_1$partenza), "%I:%M %p")
tabella_frailty_Zona_1$lower <- exp(tabella_frailty_Zona_1$frailty - 1.96 * sqrt(tabella_frailty_Zona_1$var))
tabella_frailty_Zona_1$upper <- exp(tabella_frailty_Zona_1$frailty + 1.96 * sqrt(tabella_frailty_Zona_1$var))
```

Plot colorato per FasciaOraria:
```{r}
orari_unici_Zona_1 <- c("Morning-Peak Time", "Off-Peak Time", "Evening-Peak Time")
tabella_frailty_Zona_1$traffico_ora <- factor(tabella_frailty_Zona_1$traffico_ora, levels = orari_unici_Zona_1)
colori_personalizzati <- c("#87CEFA", "#EB5C82", "#F59B51")
palette_orari_Zona_1 <- setNames(colori_personalizzati, orari_unici_Zona_1)

theta_Zona_1 <- 0.2233342
down <- exp(- 1.5 * sqrt(theta_Zona_1))
up <- exp(1.5 * sqrt(theta_Zona_1))

ggplot(tabella_frailty_Zona_1, aes(x = ID_Mezzo, y = wj, color = traffico_ora)) +
  geom_point(size = 2) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", linewidth = 0.4) +
  geom_hline(yintercept = up, linetype = "dashed", color = "grey", linewidth = 0.4) +
  geom_hline(yintercept = down, linetype = "dashed", color = "grey", linewidth = 0.4) +
  scale_color_manual(values = palette_orari_Zona_1) +
  labs(
    title = "Empirical Gamma Failty Terms",
    x = "Mission",
    y = "Frailty (wj)",
    color = "Time Slot"
  ) +
  theme_minimal()
```



