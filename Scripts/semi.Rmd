---
title: "Semi_and_Frailty_models"
output: html_document
date: "2024-11-26"
---

STATE DEFINITION:
0) OnTime: Arrival Delay <= 5min
1) Delay: 5min < Arrival Delay <= 10min
2) Severe Delay: Arrival Delay > 10min

RMK.1:
   - Morning-Peak Time: 6a.m.-10a.m.
   - Off-Peak Time    : 10a.m.-4p.m.
   - Evening-Peak Time: 4p.m.-8p.m.

RMK.2:
   - Zone 1: from Varese to Gallarate;
   - Zone 2: from Busto Arsizio to Rho Fiera;
   - Zone 3: from Milano Certosa to Milano Forlanini;
   - Zone 4: from Segrate to Treviglio.

Additional information:
- we consider 3 months (September, October, November) during 2023
- Only S5 line (from Varese to Treviglio and vice versa)
- The dataset is a combination of 3 main sources: Operational data from Trenord, Weather conditions and Custom frequency indicators.

```{r}
# Loading necessary libraries
library(survival)
library(survminer)
library(dplyr) 
library(ggplot2)
library(knitr)
library(broom)
library(tidyr)
library(mstate)
library(msm)
library(timechange)
library(lubridate)
library("colorspace")
library(frailtypack)
library(gridExtra)
library(survidm)
library(flexsurv)
library(muhaz)
library(gridExtra)
library(stringr)
```

# Preprocessing ----
Prepare data to make the HR visualization clearer. Ad adjust other covariates types.
```{r}
msdata_cov$boarded <- msdata_cov$boarded/50
msdata_cov$alighted <- msdata_cov$alighted/50
msdata_cov$saturation <- msdata_cov$saturation/2
msdata_cov$direction <- factor(msdata_cov$direction, levels = c("0", "1"))
msdata_cov$time_slot <- factor(msdata_cov$time_slot, levels = c("Off-Peak Time", "Morning-Peak Time", "Evening-Peak Time"))
msdata_cov$zone <- factor(msdata_cov$zone, levels = c("Zone 4", "Zone 3", "Zone 2", "Zone 1"))

msdata_cov_0 <- msdata_cov[msdata_cov$direction == 0, ]
msdata_cov_1 <- msdata_cov[msdata_cov$direction == 1, ]

covs <- c("boarded", "alighted", "weather", "saturation", "time_slot", "zone")
msdata_cov_exp_0 <- expand.covs(msdata_cov_0, covs, trans=tmat)
msdata_cov_exp_1 <- expand.covs(msdata_cov_1, covs, trans=tmat)
```



#Direction 0----
##Only Covariates----
###Model with covariates: Time Slot (Split by Direction) ---- 
Construct the base model with all the covariates included and then remove the non-significant ones:
```{r}
cox_TimeSlot_0 <- coxph(Surv(time, status) ~ boarded.1 + boarded.2 + boarded.3 + boarded.4 + alighted.1 + alighted.2 + alighted.3 + alighted.4 + saturation.1 + saturation.2 + saturation.3 + saturation.4 + weather1.1 + weather1.2 + weather1.3 + weather1.4 + time_slotMorning.Peak.Time.1 + time_slotMorning.Peak.Time.2 + time_slotMorning.Peak.Time.3 + time_slotMorning.Peak.Time.4 + time_slotEvening.Peak.Time.1 + time_slotEvening.Peak.Time.2 + time_slotEvening.Peak.Time.3 + time_slotEvening.Peak.Time.4 + strata(trans), data = msdata_cov_exp_0, method = "breslow")
summary(cox_TimeSlot_0)

# cox_TimeSlot_bis_0 <- coxph(Surv(time, status) ~ boarded.1 + boarded.2 + boarded.3 + boarded.4 + alighted.2 + alighted.4 + saturation.1 + saturation.3 + saturation.4 + weather1.1 + weather1.2 + time_slotMorning.Peak.Time.1 + time_slotEvening.Peak.Time.1 + time_slotEvening.Peak.Time.4 + strata(trans), data = msdata_cov_exp_0, method = "breslow")
# summary(cox_TimeSlot_bis_0)
```

Plot HR:
```{r}
# Prepare data
tidy_cox <- broom::tidy(cox_TimeSlot_0, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""))

color_map <- c(
  "OnTime → Mild Delay" = "black",
  "MildDelay → SevereDelay" = "black",
  "SevereDelay → MildDelay" = "black",
  "MildDelay → OnTime" = "black"
)

covariate_names <- unique(tidy_cox$covariate)

plots <- list()

# Build a plot for each covariate
for (cov in covariate_names) {
  df_cov <- tidy_cox %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high, color = trans_label)) +
    geom_pointrange(size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map) +
    coord_flip() +
    labs(title = paste("HR for transitions - Covariate:", cov),
         x = "Transition",
         y = "Hazard Ratio (exponential of the coefficient)",
         color = "Transition") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "none")
  
  plots[[cov]] <- p
}

#Little changes in the titles:
#boarded:
plots[["boarded"]]$labels[2] <- "HR (50 people)"
plots[["boarded"]]$labels[4] <- "Hazard Ratios with 95% CI for Boarded"
#alighted:
plots[["alighted"]]$labels[2] <- "HR (50 people)"
plots[["alighted"]]$labels[4] <- "Hazard Ratios with 95% CI for Alighted"
#weather1:
plots[["weather1"]]$labels[2] <- "HR (Clear)"
plots[["weather1"]]$labels[4] <- "Hazard Ratios with 95% CI for Adverse Weather"
#saturation:
plots[["saturation"]]$labels[2] <- "HR (2 trains)"
plots[["saturation"]]$labels[4] <- "Hazard Ratios with 95% CI for Train Frequency per Hour"
#time_slotMorning.Peak.Time:
plots[["time_slotMorning.Peak.Time"]]$labels[2] <- "HR (Off-Peak Time)"
plots[["time_slotMorning.Peak.Time"]]$labels[4] <- "Hazard Ratios with 95% CI for Morning-Peak Time"
#time_slotEvening.Peak.Time:
plots[["time_slotEvening.Peak.Time"]]$labels[2] <- "HR (Off-Peak Time)"
plots[["time_slotEvening.Peak.Time"]]$labels[4] <- "Hazard Ratios with 95% CI for Evening-Peak Time"

# Plot:
print(plots[["boarded"]])
print(plots[["alighted"]])
print(plots[["weather1"]])
print(plots[["saturation"]])
print(plots[["time_slotMorning.Peak.Time"]])
print(plots[["time_slotEvening.Peak.Time"]])
```


Plot Transition probabilities:

1- Analysis for Time Slot x passengers(boarded&alighted) (min) - Direction 0
```{r}
quantile(msdata_cov$boarded, probs = c(0.15, 0.85))
quantile(msdata_cov$alighted, probs = c(0.15, 0.85))
boarded_min <- 0.04
boarded_max <- 0.98 
alighted_min <- 0.10
alighted_max <- 1.08
cov <- c("boarded", "alighted", "saturation", "weather", "time_slot")

make_probtrans <- function(time_slot, model, data, tmat, boarded, alighted) {
  idx <- which(data$weather == 0 & data$time_slot == time_slot)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- boarded
  df$alighted <- alighted
  df$saturation <- mean(msdata_cov$saturation)
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_morning_passengers_min_0 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, boarded_min, alighted_min)
prob_off_passengers_min_0 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, boarded_min, alighted_min)
prob_evening_passengers_min_0 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, boarded_min, alighted_min)

pt_list <- list(
  MorningPeak = prob_morning_passengers_min_0,
  OffPeak     = prob_off_passengers_min_0,
  EveningPeak = prob_evening_passengers_min_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
  plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
    scale_fill_manual(values = statecols) +
    theme_minimal() +
    labs(
      title = paste("From", state_label, "(", timeslot_name, ")"),
      x = "Time (Minutes ahead)",
      y = "Transition Probability"
    ) +
    guides(fill = guide_legend(title = "States"))
}
plot_specs <- expand.grid(
  timeslot = names(pt_list),
  from = 1:3,
  stringsAsFactors = FALSE
)
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Passengers (min) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

2- Analysis for Time Slot x passengers(boarded&alighted) (max) - Direction 0
```{r}
prob_morning_passengers_max_0 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, boarded_max, alighted_max)
prob_off_passengers_max_0 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, boarded_max, alighted_max)
prob_evening_passengers_max_0 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, boarded_max, alighted_max)

pt_list <- list(
  MorningPeak = prob_morning_passengers_max_0,
  OffPeak     = prob_off_passengers_max_0,
  EveningPeak = prob_evening_passengers_max_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", timeslot_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   timeslot = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Passengers (max) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

3- Analysis for Time Slot x weather (good) - Direction 0
```{r}
make_probtrans <- function(time_slot, model, data, tmat, weather) {
  idx <- which(data$weather == weather & data$time_slot == time_slot)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- mean(msdata_cov$boarded)
  df$alighted <- mean(msdata_cov$alighted)
  df$saturation <- mean(msdata_cov$saturation)
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_morning_weather_good_0 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, 0)
prob_off_weather_good_0 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, 0)
prob_evening_weather_good_0 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, 0)

pt_list <- list(
  MorningPeak = prob_morning_weather_good_0,
  OffPeak     = prob_off_weather_good_0,
  EveningPeak = prob_evening_weather_good_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", timeslot_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   timeslot = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Clear Weather per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

4- Analysis for Time Slot x weather (bad) - Direction 0
```{r}
prob_morning_weather_bad_0 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, 1)
prob_off_weather_bad_0 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, 1)
prob_evening_weather_bad_0 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, 1)

pt_list <- list(
  MorningPeak = prob_morning_weather_bad_0,
  OffPeak     = prob_off_weather_bad_0,
  EveningPeak = prob_evening_weather_bad_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", timeslot_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   timeslot = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Adverse Weather per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

5- Analysis for Time Slot x saturation (min) - Direction 0
```{r}
saturation_min <- 2 #4/2 --> Peripheral areas
saturation_max <- 12 #24/2 --> Milan urban core

make_probtrans <- function(time_slot, model, data, tmat, saturation) {
  idx <- which(data$weather == 0 & data$time_slot == time_slot)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- mean(msdata_cov$boarded)
  df$alighted <- mean(msdata_cov$alighted)
  df$saturation <- saturation
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_morning_saturation_min_0 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, saturation_min)
prob_off_saturation_min_0 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, saturation_min)
prob_evening_saturation_min_0 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, saturation_min)

pt_list <- list(
  MorningPeak = prob_morning_saturation_min_0,
  OffPeak     = prob_off_saturation_min_0,
  EveningPeak = prob_evening_saturation_min_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", timeslot_name, ")"),
#       x = "Time (Minutes)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   timeslot = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Train Frequency per Hour (min) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

6- Analysis for Time Slot x saturation (max) - Direction 0
```{r}
prob_morning_saturation_max_0 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, saturation_max)
prob_off_saturation_max_0 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, saturation_max)
prob_evening_saturation_max_0 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, saturation_max)

pt_list <- list(
  MorningPeak = prob_morning_saturation_max_0,
  OffPeak     = prob_off_saturation_max_0,
  EveningPeak = prob_evening_saturation_max_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", timeslot_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   timeslot = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Train Frequency per Hour (max) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

7- Analysis for Time Slot x best case - Direction 0
```{r}
make_probtrans <- function(time_slot, model, data, tmat, boarded, alighted, weather, saturation) {
  idx <- which(data$weather == weather & data$time_slot == time_slot)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- boarded
  df$alighted <- alighted
  df$saturation <- saturation
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_morning_best_0 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, boarded_min, alighted_min, 0, saturation_min)
prob_off_best_0 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, boarded_min, alighted_min, 0, saturation_min)
prob_evening_best_0 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, boarded_min, alighted_min, 0, saturation_min)

pt_list <- list(
  MorningPeak = prob_morning_best_0,
  OffPeak     = prob_off_best_0,
  EveningPeak = prob_evening_best_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", timeslot_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   timeslot = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Best Case Scenario per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

8- Analysis for Time Slot x worst case - Direction 0
```{r}
prob_morning_worst_0 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, boarded_max, alighted_max, 1, saturation_max)
prob_off_worst_0 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, boarded_max, alighted_max, 1, saturation_max)
prob_evening_worst_0 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_0, msdata_cov_0, tmat, boarded_max, alighted_max, 1, saturation_max)

pt_list <- list(
  MorningPeak = prob_morning_worst_0,
  OffPeak     = prob_off_worst_0,
  EveningPeak = prob_evening_worst_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", timeslot_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   timeslot = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Worst Case Scenario per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```


###Model with covariates: Route Section (Split by Direction) ---- 
Construct the base model with all the covariates included and then remove the non-significant ones:
```{r}
cox_Zone_0 <- coxph(Surv(time, status) ~ boarded.1 + boarded.2 + boarded.3 + boarded.4 + alighted.1 + alighted.2 + alighted.3 + alighted.4 + saturation.1 + saturation.2 + saturation.3 + saturation.4 + weather1.1 + weather1.2 + weather1.3 + weather1.4 + + zoneZone.3.1 + zoneZone.3.2 + zoneZone.3.3 + zoneZone.3.4 + zoneZone.2.1 + zoneZone.2.2 + zoneZone.2.3 + zoneZone.2.4 + zoneZone.1.1 + zoneZone.1.2 + zoneZone.1.3 + zoneZone.1.4 + strata(trans), data = msdata_cov_exp_0, method = "breslow")
summary(cox_Zone_0)

# cox_Zone_bis_0 <- coxph(Surv(time, status) ~ boarded.2 + alighted.1 + alighted.2 + alighted.3 + alighted.4 + zoneZone.3.1 + zoneZone.3.3 + zoneZone.3.4 + zoneZone.2.1 + zoneZone.2.2 + zoneZone.2.3 + zoneZone.2.4 + zoneZone.1.1 + zoneZone.1.2 + strata(trans), data = msdata_cov_exp_0, method = "breslow")
# summary(cox_Zone_bis_0)
```

Plot HR:
```{r}
# Prepare data
tidy_cox <- broom::tidy(cox_Zone_0, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""))

color_map <- c(
  "OnTime → Mild Delay" = "black",
  "MildDelay → SevereDelay" = "black",
  "SevereDelay → MildDelay" = "black",
  "MildDelay → OnTime" = "black"
)

covariate_names <- unique(tidy_cox$covariate)

plots <- list()

# Build a plot for each covariate
for (cov in covariate_names) {
  df_cov <- tidy_cox %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high, color = trans_label)) +
    geom_pointrange(size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map) +
    coord_flip() +
    labs(title = paste("HR for transitions - Covariate:", cov),
         x = "Transition",
         y = "Hazard Ratio (exponential of the coefficient)",
         color = "Transition") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "none")
  
  plots[[cov]] <- p
}

#Little changes in the titles:
#boarded:
plots[["boarded"]]$labels[2] <- "HR (50 people)"
plots[["boarded"]]$labels[4] <- "Hazard Ratios with 95% CI for Boarded"
#alighted:
plots[["alighted"]]$labels[2] <- "HR (50 people)"
plots[["alighted"]]$labels[4] <- "Hazard Ratios with 95% CI for Alighted"
#weather1:
plots[["weather1"]]$labels[2] <- "HR (Clear)"
plots[["weather1"]]$labels[4] <- "Hazard Ratios with 95% CI for Adverse Weather"
#saturation:
plots[["saturation"]]$labels[2] <- "HR (2 trains)"
plots[["saturation"]]$labels[4] <- "Hazard Ratios with 95% CI for Train Frequency per Hour"
#zoneZone.1:
plots[["zoneZone.1"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zoneZone.1"]]$labels[4] <- "Hazard Ratios with 95% CI for Varese - Gallarate"
#zoneZone.2:
plots[["zoneZone.2"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zoneZone.2"]]$labels[4] <- "Hazard Ratios with 95% CI for Busto Arsizio - Rho Fiera"
#zoneZone.3:
plots[["zoneZone.3"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zoneZone.3"]]$labels[4] <- "Hazard Ratios with 95% CI for Milano Certosa - Milano Forlanini"

# Plot:
print(plots[["boarded"]])
print(plots[["alighted"]])
print(plots[["saturation"]])
print(plots[["zoneZone.1"]])
print(plots[["zoneZone.2"]])
print(plots[["zoneZone.3"]])
```


Plot Transition probabilities:

1- Analysis for Route Section x passengers(boarded&alighted) (min) - Direction 0
```{r}
# quantile(msdata_cov$boarded, probs = c(0.15, 0.85))
# quantile(msdata_cov$alighted, probs = c(0.15, 0.85))
# boarded_min <- 0.04
# boarded_max <- 0.98 
# alighted_min <- 0.10
# alighted_max <- 1.08
cov <- c("boarded", "alighted", "saturation", "weather", "zone")

make_probtrans <- function(zone, model, data, tmat, boarded, alighted) {
  idx <- which(data$weather == 0 & data$zone == zone)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- boarded
  df$alighted <- alighted
  df$saturation <- mean(msdata_cov$saturation)
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_Zone1_passengers_min_0 <- make_probtrans("Zone 1", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_min, alighted_min)
prob_Zone2_passengers_min_0 <- make_probtrans("Zone 2", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_min, alighted_min)
prob_Zone3_passengers_min_0 <- make_probtrans("Zone 3", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_min, alighted_min)
prob_Zone4_passengers_min_0 <- make_probtrans("Zone 4", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_min, alighted_min)

pt_list <- list(
  Zone1 = prob_Zone1_passengers_min_0,
  Zone2 = prob_Zone2_passengers_min_0,
  Zone3 = prob_Zone3_passengers_min_0,
  Zone4 = prob_Zone4_passengers_min_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Passengers (min) per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

2- Analysis for Route Section x passengers(boarded&alighted) (max) - Direction 0
```{r}
prob_Zone1_passengers_max_0 <- make_probtrans("Zone 1", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_max, alighted_max)
prob_Zone2_passengers_max_0 <- make_probtrans("Zone 2", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_max, alighted_max)
prob_Zone3_passengers_max_0 <- make_probtrans("Zone 3", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_max, alighted_max)
prob_Zone4_passengers_max_0 <- make_probtrans("Zone 4", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_max, alighted_max)

pt_list <- list(
  Zone1 = prob_Zone1_passengers_max_0,
  Zone2 = prob_Zone2_passengers_max_0,
  Zone3 = prob_Zone3_passengers_max_0,
  Zone4 = prob_Zone4_passengers_max_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Passengers (max) per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

3- Analysis for Route Section x weather (good) - Direction 0
```{r}
make_probtrans <- function(zone, model, data, tmat, weather) {
  idx <- which(data$weather == weather & data$zone == zone)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- mean(msdata_cov$boarded)
  df$alighted <- mean(msdata_cov$alighted)
  df$saturation <- mean(msdata_cov$saturation)
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_Zone1_weather_good_0 <- make_probtrans("Zone 1", cox_Zone_bis_0, msdata_cov_0, tmat, 0)
prob_Zone2_weather_good_0 <- make_probtrans("Zone 2", cox_Zone_bis_0, msdata_cov_0, tmat, 0)
prob_Zone3_weather_good_0 <- make_probtrans("Zone 3", cox_Zone_bis_0, msdata_cov_0, tmat, 0)
prob_Zone4_weather_good_0 <- make_probtrans("Zone 4", cox_Zone_bis_0, msdata_cov_0, tmat, 0)

pt_list <- list(
  Zone1 = prob_Zone1_weather_good_0,
  Zone2 = prob_Zone2_weather_good_0,
  Zone3 = prob_Zone3_weather_good_0,
  Zone4 = prob_Zone4_weather_good_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Clear Weather per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

4- Analysis for Route Section x weather (bad) - Direction 0
```{r}
prob_Zone1_weather_bad_0 <- make_probtrans("Zone 1", cox_Zone_bis_0, msdata_cov_0, tmat, 1)
prob_Zone2_weather_bad_0 <- make_probtrans("Zone 2", cox_Zone_bis_0, msdata_cov_0, tmat, 1)
prob_Zone3_weather_bad_0 <- make_probtrans("Zone 3", cox_Zone_bis_0, msdata_cov_0, tmat, 1)
prob_Zone4_weather_bad_0 <- make_probtrans("Zone 4", cox_Zone_bis_0, msdata_cov_0, tmat, 1)

pt_list <- list(
  Zone1 = prob_Zone1_weather_bad_0,
  Zone2 = prob_Zone2_weather_bad_0,
  Zone3 = prob_Zone3_weather_bad_0,
  Zone4 = prob_Zone4_weather_bad_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Adverse Weather per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

5- Analysis for Route Section x saturation (min) - Direction 0
```{r}
saturation_min <- 2 #4/2 --> Peripheral areas
saturation_max <- 12 #24/2 --> Milan urban core

make_probtrans <- function(zone, model, data, tmat, saturation) {
  idx <- which(data$weather == 0 & data$zone == zone)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- mean(msdata_cov$boarded)
  df$alighted <- mean(msdata_cov$alighted)
  df$saturation <- saturation
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_Zone1_saturation_min_0 <- make_probtrans("Zone 1", cox_Zone_bis_0, msdata_cov_0, tmat, saturation_min)
prob_Zone2_saturation_min_0 <- make_probtrans("Zone 2", cox_Zone_bis_0, msdata_cov_0, tmat, saturation_min)
prob_Zone3_saturation_min_0 <- make_probtrans("Zone 3", cox_Zone_bis_0, msdata_cov_0, tmat, saturation_min)
prob_Zone4_saturation_min_0 <- make_probtrans("Zone 4", cox_Zone_bis_0, msdata_cov_0, tmat, saturation_min)

pt_list <- list(
  Zone1 = prob_Zone1_saturation_min_0,
  Zone2 = prob_Zone2_saturation_min_0,
  Zone3 = prob_Zone3_saturation_min_0,
  Zone4 = prob_Zone4_saturation_min_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Train Frequency per Hour (min) per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

6- Analysis for Route Section x saturation (max) - Direction 0
```{r}
prob_Zone1_saturation_max_0 <- make_probtrans("Zone 1", cox_Zone_bis_0, msdata_cov_0, tmat, saturation_max)
prob_Zone2_saturation_max_0 <- make_probtrans("Zone 2", cox_Zone_bis_0, msdata_cov_0, tmat, saturation_max)
prob_Zone3_saturation_max_0 <- make_probtrans("Zone 3", cox_Zone_bis_0, msdata_cov_0, tmat, saturation_max)
prob_Zone4_saturation_max_0 <- make_probtrans("Zone 4", cox_Zone_bis_0, msdata_cov_0, tmat, saturation_max)

pt_list <- list(
  Zone1 = prob_Zone1_saturation_max_0,
  Zone2 = prob_Zone2_saturation_max_0,
  Zone3 = prob_Zone3_saturation_max_0,
  Zone4 = prob_Zone4_saturation_max_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Train Frequency per Hour (max) per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

7- Analysis for Route Section x best case - Direction 0
```{r}
make_probtrans <- function(zone, model, data, tmat, boarded, alighted, weather, saturation) {
  idx <- which(data$weather == weather & data$zone == zone)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- boarded
  df$alighted <- alighted
  df$saturation <- saturation
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_Zone1_best_0 <- make_probtrans("Zone 1", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_min, alighted_min, 0, saturation_min)
prob_Zone2_best_0 <- make_probtrans("Zone 2", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_min, alighted_min, 0, saturation_min)
prob_Zone3_best_0 <- make_probtrans("Zone 3", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_min, alighted_min, 0, saturation_min)
prob_Zone4_best_0 <- make_probtrans("Zone 4", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_min, alighted_min, 0, saturation_min)

pt_list <- list(
  Zone1 = prob_Zone1_best_0,
  Zone2 = prob_Zone2_best_0,
  Zone3 = prob_Zone3_best_0,
  Zone4 = prob_Zone4_best_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Best Case Scenario per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

8- Analysis for Route Section x worst case - Direction 0
```{r}
prob_Zone1_worst_0 <- make_probtrans("Zone 1", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_max, alighted_max, 1, saturation_max)
prob_Zone2_worst_0 <- make_probtrans("Zone 2", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_max, alighted_max, 1, saturation_max)
prob_Zone3_worst_0 <- make_probtrans("Zone 3", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_max, alighted_max, 1, saturation_max)
prob_Zone4_worst_0 <- make_probtrans("Zone 4", cox_Zone_bis_0, msdata_cov_0, tmat, boarded_max, alighted_max, 1, saturation_max)

pt_list <- list(
  Zone1 = prob_Zone1_worst_0,
  Zone2 = prob_Zone2_worst_0,
  Zone3 = prob_Zone3_worst_0,
  Zone4 = prob_Zone4_worst_0
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Worst Case Scenario per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```


## Covariates and Frailties----
###Model with covariates and frailties: Time Slot (Split by Direction) ----  
Contruct the model defining a frailty on ID_Train (Gamma is better than Gaussian frailty):
```{r}
frailtyGamma_TimeSlot_0 <- coxph(Surv(time, status) ~ boarded.1 + boarded.2 + boarded.3 + boarded.4 + alighted.1 + alighted.2 + alighted.3 + alighted.4 + saturation.1 + saturation.2 + saturation.3 + saturation.4 + weather1.1 + weather1.2 + weather1.3 + weather1.4 + time_slotMorning.Peak.Time.1 + time_slotMorning.Peak.Time.2 + time_slotMorning.Peak.Time.3 + time_slotMorning.Peak.Time.4 + time_slotEvening.Peak.Time.1 + time_slotEvening.Peak.Time.2 + time_slotEvening.Peak.Time.3 + time_slotEvening.Peak.Time.4 + frailty(ID_Train, distribution = "gamma") + strata(trans), data = msdata_cov_exp_0, method = "breslow")
summary(frailtyGamma_TimeSlot_0)
logLik(frailtyGamma_TimeSlot_0)

# frailtyGaussian_TimeSlot_0 <- coxph(Surv(time, status) ~ boarded.1 + boarded.2 + boarded.3 + boarded.4 + alighted.1 + alighted.2 + alighted.3 + alighted.4 + saturation.1 + saturation.2 + saturation.3 + saturation.4 + weather1.1 + weather1.2 + weather1.3 + weather1.4 + time_slotMorning.Peak.Time.1 + time_slotMorning.Peak.Time.2 + time_slotMorning.Peak.Time.3 + time_slotMorning.Peak.Time.4 + time_slotEvening.Peak.Time.1 + time_slotEvening.Peak.Time.2 + time_slotEvening.Peak.Time.3 + time_slotEvening.Peak.Time.4 + frailty(ID_Mezzo, distribution = "gaussian") + strata(trans), data = msdata_cov_exp_0, method = "breslow")
# summary(frailtyGaussian_TimeSlot_0)
# logLik(frailtyGaussian_TimeSlot_0)
```

Plot HR:
```{r}
color_map <- c(
  "OnTime → Mild Delay" = "black",
  "MildDelay → SevereDelay" = "black",
  "SevereDelay → MildDelay" = "black",
  "MildDelay → OnTime" = "black"
)
tidy_cox <- broom::tidy(cox_TimeSlot_0, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""),
         model = "Cox")

# Estract coeff, confint e compute HR
frailty_coef <- coef(frailtyGamma_TimeSlot_0)
frailty_ci <- confint(frailtyGamma_TimeSlot_0)

tidy_frailty <- tibble(
  term = names(frailty_coef),
  estimate = exp(frailty_coef),
  conf.low = exp(frailty_ci[, 1]),
  conf.high = exp(frailty_ci[, 2])
) %>%
  mutate(
    trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
    trans_label = factor(trans, levels = c("1","3","4","2"),
                         labels = c("OnTime → Mild Delay",
                                    "MildDelay → SevereDelay",
                                    "SevereDelay → MildDelay",
                                    "MildDelay → OnTime")),
    covariate = str_replace(term, "\\.\\d$", ""),
    model = "Frailty"
  )
combined_data <- bind_rows(tidy_cox, tidy_frailty)
covariate_names <- unique(combined_data$covariate)

plots <- list()
pd <- position_dodge(width = 0.6)

for (cov in covariate_names) {
  df_cov <- combined_data %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high,
                          color = trans_label, shape = model)) +
    geom_pointrange(position = pd, size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map, name = "Transition") +
    scale_shape_manual(values = c(Cox = 16, Frailty = 17),
                       labels = c("Cox model", "Frailty model"),
                       name = "Model") +
    coord_flip() +
    labs(title = paste("HR for transitions - Covariate:", cov),
         x = "Transition",
         y = "Hazard Ratio (exponential of the coefficient)") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "right",
          legend.box = "vertical",
          legend.title = element_text(face = "bold"),
          legend.spacing.y = unit(0.4, 'cm'),
          legend.text = element_text(size = 11))
  
  plots[[cov]] <- p
}

#Little changes in the titles:
#boarded
plots[["boarded"]]$labels[["y"]] <- "HR (50 people)"
plots[["boarded"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Boarded"
#alighted
plots[["alighted"]]$labels[["y"]] <- "HR (50 people)"
plots[["alighted"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Alighted"
#weather
plots[["weather1"]]$labels[["y"]] <- "HR (Clear)"
plots[["weather1"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Adverse Weather"
#saturation
plots[["saturation"]]$labels[["y"]] <- "HR (2 trains)"
plots[["saturation"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Train Frequency per Hour"
#time_slotMorning.Peak.Time
plots[["time_slotMorning.Peak.Time"]]$labels[["y"]] <- "HR (Off-Peak Time)"
plots[["time_slotMorning.Peak.Time"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Morning-Peak Time"
#time_slotEvening.Peak.Time
plots[["time_slotEvening.Peak.Time"]]$labels[["y"]] <- "HR (Off-Peak Time)"
plots[["time_slotEvening.Peak.Time"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Evening-Peak Time"

# Plot
print(plots[["boarded"]])
print(plots[["alighted"]])
print(plots[["weather1"]])
print(plots[["saturation"]])
print(plots[["time_slotMorning.Peak.Time"]])
print(plots[["time_slotEvening.Peak.Time"]])
```

Frailty Plot:
```{r}
# Estract log(wj) values
frailty_vals_TimeSlot_0 <- frailtyGamma_TimeSlot_0$frail

# Assign ID_Train to the respective values of frailty and consider the specific variances for wj:
cluster_levels_TimeSlot_0 <- sort(unique(msdata_cov_exp_0$ID_Train))
frailty_table_TimeSlot_0 <- data.frame(ID_Train = cluster_levels_TimeSlot_0, frailty = frailtyGamma_TimeSlot_0$frail, var=frailtyGamma_TimeSlot_0$fvar)

# Now repeat the same but for ID_TrainRun adding also the actual values of wj instead of considering frailty=log(wj):
#Morning
data_distinct_TimeSlot_0 <- msdata_cov_exp[!duplicated(msdata_cov_exp_0$ID_Train), c("ID_Train", "ID_TrainRun", "departure", "time_slot")]
tab_frailty_TimeSlot_0 <- merge(frailty_table_TimeSlot_0, data_distinct_TimeSlot_0, by = "ID_Train")
tab_frailty_TimeSlot_0$wj <- exp(tab_frailty_TimeSlot_0$frailty)
tab_frailty_TimeSlot_0$departure <- format(as.POSIXct(tab_frailty_TimeSlot_0$departure), "%I:%M %p")
tab_frailty_TimeSlot_0$lower <- exp(tab_frailty_TimeSlot_0$frailty - 1.96 * sqrt(tab_frailty_TimeSlot_0$var))
tab_frailty_TimeSlot_0$upper <- exp(tab_frailty_TimeSlot_0$frailty + 1.96 * sqrt(tab_frailty_TimeSlot_0$var))
```

Frailty Plot colored by TimeSlot:
```{r}
times_unique_TimeSlot_0 <- c("Morning-Peak Time", "Off-Peak Time", "Evening-Peak Time")
tab_frailty_TimeSlot_0$time_slot <- factor(tab_frailty_TimeSlot_0$time_slot, levels = times_unique_TimeSlot_0)
personalized_colors <- c("#87CEFA", "#EB5C82", "#F59B51")
palette_times_TimeSlot_0 <- setNames(personalized_colors, times_unique_TimeSlot_0)

theta_TimeSlot_0 <- 0.235767
down <- exp(-1.5 * sqrt(theta_TimeSlot_0))
up <- exp(1.5 * sqrt(theta_TimeSlot_0))

ggplot(tab_frailty_TimeSlot_0, aes(x = ID_Train, y = wj, color = time_slot)) +
  geom_point(size = 2) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", linewidth = 0.4) +
  geom_hline(yintercept = up, linetype = "dashed", color = "grey", linewidth = 0.4) +
  geom_hline(yintercept = down, linetype = "dashed", color = "grey", linewidth = 0.4) +
  scale_color_manual(values = palette_times_TimeSlot_0) +
  labs(
    title = "Empirical Gamma Failty Terms",
    x = "Mission",
    y = "Frailty (wj)",
    color = "Time Slot"
  ) +
  theme_minimal()
```


###Model with covariates and frailties: Route Section (Split by Direction) ----  
Contruct the model defining a frailty on ID_Train (Gamma is better than Gaussian frailty):
```{r}
frailtyGamma_Zone_0 <- coxph(Surv(time, status) ~ boarded.1 + boarded.2 + boarded.3 + boarded.4 + alighted.1 + alighted.2 + alighted.3 + alighted.4 + saturation.1 + saturation.2 + saturation.3 + saturation.4 + weather1.1 + weather1.2 + weather1.3 + weather1.4 + zoneZone.3.1 + zoneZone.3.2 + zoneZone.3.3 + zoneZone.3.4 + zoneZone.2.1 + zoneZone.2.2 + zoneZone.2.3 + zoneZone.2.4 + zoneZone.1.1 + zoneZone.1.2 + zoneZone.1.3 + zoneZone.1.4 + frailty(ID_Train, distribution = "gamma") + strata(trans), data = msdata_cov_exp_0, method = "breslow")
summary(frailtyGamma_Zone_0)
logLik(frailtyGamma_Zone_0)

# frailtyGaussian_Zone_0 <- coxph(Surv(time, status) ~ boarded.1 + boarded.2 + boarded.3 + boarded.4 + alighted.1 + alighted.2 + alighted.3 + alighted.4 + saturation.1 + saturation.2 + saturation.3 + saturation.4 + weather1.1 + weather1.2 + weather1.3 + weather1.4 + zoneZone.3.1 + zoneZone.3.2 + zoneZone.3.3 + zoneZone.3.4 + zoneZone.2.1 + zoneZone.2.2 + zoneZone.2.3 + zoneZone.2.4 + zoneZone.1.1 + zoneZone.1.2 + zoneZone.1.3 + zoneZone.1.4 + frailty(ID_Mezzo, distribution = "gaussian") + strata(trans), data = msdata_cov_exp_0, method = "breslow")
# summary(frailtyGaussian_Zone_0)
# logLik(frailtyGaussian_Zone_0)
```

Plot HR:
```{r}
color_map <- c(
  "OnTime → Mild Delay" = "black",
  "MildDelay → SevereDelay" = "black",
  "SevereDelay → MildDelay" = "black",
  "MildDelay → OnTime" = "black"
)
tidy_cox <- broom::tidy(cox_Zone_0, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""),
         model = "Cox")

# Estract coeff, confint e compute HR
frailty_coef <- coef(frailtyGamma_Zone_0)
frailty_ci <- confint(frailtyGamma_Zone_0)

tidy_frailty <- tibble(
  term = names(frailty_coef),
  estimate = exp(frailty_coef),
  conf.low = exp(frailty_ci[, 1]),
  conf.high = exp(frailty_ci[, 2])
) %>%
  mutate(
    trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
    trans_label = factor(trans, levels = c("1","3","4","2"),
                         labels = c("OnTime → Mild Delay",
                                    "MildDelay → SevereDelay",
                                    "SevereDelay → MildDelay",
                                    "MildDelay → OnTime")),
    covariate = str_replace(term, "\\.\\d$", ""),
    model = "Frailty"
  )
combined_data <- bind_rows(tidy_cox, tidy_frailty)
covariate_names <- unique(combined_data$covariate)

plots <- list()
pd <- position_dodge(width = 0.6)

for (cov in covariate_names) {
  df_cov <- combined_data %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high,
                          color = trans_label, shape = model)) +
    geom_pointrange(position = pd, size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map, name = "Transition") +
    scale_shape_manual(values = c(Cox = 16, Frailty = 17),
                       labels = c("Cox model", "Frailty model"),
                       name = "Model") +
    coord_flip() +
    labs(title = paste("HR for transitions - Covariate:", cov),
         x = "Transition",
         y = "Hazard Ratio (exponential of the coefficient)") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "right",
          legend.box = "vertical",
          legend.title = element_text(face = "bold"),
          legend.spacing.y = unit(0.4, 'cm'),
          legend.text = element_text(size = 11))
  
  plots[[cov]] <- p
}

#Little changes in the titles:
#boarded
plots[["boarded"]]$labels[["y"]] <- "HR (50 people)"
plots[["boarded"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Boarded"
#alighted
plots[["alighted"]]$labels[["y"]] <- "HR (50 people)"
plots[["alighted"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Alighted"
#weather
plots[["weather1"]]$labels[["y"]] <- "HR (Clear)"
plots[["weather1"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Adverse Weather"
#saturation
plots[["saturation"]]$labels[["y"]] <- "HR (2 trains)"
plots[["saturation"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Train Frequency per Hour"
#zoneZone.1:
plots[["zoneZone.1"]]$labels["y"] <- "HR (Segrate-Treviglio)"
plots[["zoneZone.1"]]$labels["title"] <- "Hazard Ratios with 95% CI for Varese - Gallarate"
#zoneZone.2:
plots[["zoneZone.2"]]$labels["y"] <- "HR (Segrate-Treviglio)"
plots[["zoneZone.2"]]$labels["title"] <- "Hazard Ratios with 95% CI for Busto Arsizio - Rho Fiera"
#zoneZone.3:
plots[["zoneZone.3"]]$labels["y"] <- "HR (Segrate-Treviglio)"
plots[["zoneZone.3"]]$labels["title"] <- "Hazard Ratios with 95% CI for Milano Certosa - Milano Forlanini"

# Plot
print(plots[["boarded"]])
print(plots[["alighted"]])
print(plots[["weather1"]])
print(plots[["saturation"]])
print(plots[["zoneZone.1"]])
print(plots[["zoneZone.2"]])
print(plots[["zoneZone.3"]])
```

Frailty Plot:
```{r}
# Estract log(wj) values
frailty_vals_Zone_0 <- frailtyGamma_Zone_0$frail

# Assign ID_Train to the respective values of frailty and consider the specific variances for wj:
cluster_levels_Zone_0 <- sort(unique(msdata_cov_exp_0$ID_Train))
frailty_table_Zone_0 <- data.frame(ID_Train = cluster_levels_Zone_0, frailty = frailtyGamma_Zone_0$frail, var=frailtyGamma_Zone_0$fvar)

# Now repeat the same but for ID_TrainRun adding also the actual values of wj instead of considering frailty=log(wj):
#Morning
data_distinct_Zone_0 <- msdata_cov_exp[!duplicated(msdata_cov_exp_0$ID_Train), c("ID_Train", "ID_TrainRun", "departure", "zone")]
tab_frailty_Zone_0 <- merge(frailty_table_Zone_0, data_distinct_Zone_0, by = "ID_Train")
tab_frailty_Zone_0$wj <- exp(tab_frailty_Zone_0$frailty)
tab_frailty_Zone_0$departure <- format(as.POSIXct(tab_frailty_Zone_0$departure), "%I:%M %p")
tab_frailty_Zone_0$lower <- exp(tab_frailty_Zone_0$frailty - 1.96 * sqrt(tab_frailty_Zone_0$var))
tab_frailty_Zone_0$upper <- exp(tab_frailty_Zone_0$frailty + 1.96 * sqrt(tab_frailty_Zone_0$var))
```

Frailty Plot colored by Zone:
```{r}
times_unique_Zone_0 <- c("Zone1", "Zone2", "Zone3", "Zone4")
tab_frailty_Zone_0$time_slot <- factor(tab_frailty_Zone_0$time_slot, levels = times_unique_Zone_0)
personalized_colors <- c("#87CEFA", "#00B88D", "#EB5C82", "#F59B51")
palette_times_Zone_0 <- setNames(personalized_colors, times_unique_Zone_0)

theta_Zone_0 <- 0.235767
down <- exp(-1.5 * sqrt(theta_Zone_0))
up <- exp(1.5 * sqrt(theta_Zone_0))

ggplot(tab_frailty_Zone_0, aes(x = ID_Train, y = wj, color = zone)) +
  geom_point(size = 2) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", linewidth = 0.4) +
  geom_hline(yintercept = up, linetype = "dashed", color = "grey", linewidth = 0.4) +
  geom_hline(yintercept = down, linetype = "dashed", color = "grey", linewidth = 0.4) +
  scale_color_manual(values = palette_times_Zone_0) +
  labs(
    title = "Empirical Gamma Failty Terms",
    x = "Mission",
    y = "Frailty (wj)",
    color = "Zone"
  ) +
  theme_minimal()
```




#Direction 1----
##Only Covariates----
###Model with covariates: Time Slot (Split by Direction) ---- 
Construct the base model with all the covariates included and then remove the non-significant ones:
```{r}
cox_TimeSlot_1 <- coxph(Surv(time, status) ~ boarded.1 + boarded.2 + boarded.3 + boarded.4 + alighted.1 + alighted.2 + alighted.3 + alighted.4 + saturation.1 + saturation.2 + saturation.3 + saturation.4 + weather1.1 + weather1.2 + weather1.3 + weather1.4 + time_slotMorning.Peak.Time.1 + time_slotMorning.Peak.Time.2 + time_slotMorning.Peak.Time.3 + time_slotMorning.Peak.Time.4 + time_slotEvening.Peak.Time.1 + time_slotEvening.Peak.Time.2 + time_slotEvening.Peak.Time.3 + time_slotEvening.Peak.Time.4 + strata(trans), data = msdata_cov_exp_1, method = "breslow")
summary(cox_TimeSlot_1)

# cox_TimeSlot_bis_1 <- coxph(Surv(time, status) ~ boarded.1 + boarded.2 + boarded.3 + alighted.1 + alighted.2 + alighted.3 + alighted.4 + saturation.2 + saturation.3 + weather1.2 + time_slotMorning.Peak.Time.1 + time_slotMorning.Peak.Time.2 + time_slotEvening.Peak.Time.1 + time_slotEvening.Peak.Time.2 + time_slotEvening.Peak.Time.4 + strata(trans), data = msdata_cov_exp_1, method = "breslow")
# summary(cox_TimeSlot_bis_1)
```

Plot HR:
```{r}
# Prepare data
tidy_cox <- broom::tidy(cox_TimeSlot_1, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""))

color_map <- c(
  "OnTime → Mild Delay" = "black",
  "MildDelay → SevereDelay" = "black",
  "SevereDelay → MildDelay" = "black",
  "MildDelay → OnTime" = "black"
)

covariate_names <- unique(tidy_cox$covariate)

plots <- list()

# Build a plot for each covariate
for (cov in covariate_names) {
  df_cov <- tidy_cox %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high, color = trans_label)) +
    geom_pointrange(size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map) +
    coord_flip() +
    labs(title = paste("HR for transitions - Covariate:", cov),
         x = "Transition",
         y = "Hazard Ratio (exponential of the coefficient)",
         color = "Transition") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "none")
  
  plots[[cov]] <- p
}

#Little changes in the titles:
#boarded:
plots[["boarded"]]$labels[2] <- "HR (50 people)"
plots[["boarded"]]$labels[4] <- "Hazard Ratios with 95% CI for Boarded"
#alighted:
plots[["alighted"]]$labels[2] <- "HR (50 people)"
plots[["alighted"]]$labels[4] <- "Hazard Ratios with 95% CI for Alighted"
#weather1:
plots[["weather1"]]$labels[2] <- "HR (Clear)"
plots[["weather1"]]$labels[4] <- "Hazard Ratios with 95% CI for Adverse Weather"
#saturation:
plots[["saturation"]]$labels[2] <- "HR (2 trains)"
plots[["saturation"]]$labels[4] <- "Hazard Ratios with 95% CI for Train Frequency per Hour"
#time_slotMorning.Peak.Time:
plots[["time_slotMorning.Peak.Time"]]$labels[2] <- "HR (Off-Peak Time)"
plots[["time_slotMorning.Peak.Time"]]$labels[4] <- "Hazard Ratios with 95% CI for Morning-Peak Time"
#time_slotEvening.Peak.Time:
plots[["time_slotEvening.Peak.Time"]]$labels[2] <- "HR (Off-Peak Time)"
plots[["time_slotEvening.Peak.Time"]]$labels[4] <- "Hazard Ratios with 95% CI for Evening-Peak Time"

# Plot:
print(plots[["boarded"]])
print(plots[["alighted"]])
print(plots[["weather1"]])
print(plots[["saturation"]])
print(plots[["time_slotMorning.Peak.Time"]])
print(plots[["time_slotEvening.Peak.Time"]])
```


Plot Transition probabilities:

1- Analysis for Time Slot x passengers(boarded&alighted) (min) - Direction 1
```{r}
quantile(msdata_cov$boarded, probs = c(0.15, 0.85))
quantile(msdata_cov$alighted, probs = c(0.15, 0.85))
boarded_min <- 0.04
boarded_max <- 0.98 
alighted_min <- 0.10
alighted_max <- 1.08
cov <- c("boarded", "alighted", "saturation", "weather", "time_slot")

make_probtrans <- function(time_slot, model, data, tmat, boarded, alighted) {
  idx <- which(data$weather == 0 & data$time_slot == time_slot)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- boarded
  df$alighted <- alighted
  df$saturation <- mean(msdata_cov$saturation)
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_morning_passengers_min_1 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, boarded_min, alighted_min)
prob_off_passengers_min_1 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, boarded_min, alighted_min)
prob_evening_passengers_min_1 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, boarded_min, alighted_min)

pt_list <- list(
  MorningPeak = prob_morning_passengers_min_1,
  OffPeak     = prob_off_passengers_min_1,
  EveningPeak = prob_evening_passengers_min_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
  plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
    scale_fill_manual(values = statecols) +
    theme_minimal() +
    labs(
      title = paste("From", state_label, "(", timeslot_name, ")"),
      x = "Time (Minutes ahead)",
      y = "Transition Probability"
    ) +
    guides(fill = guide_legend(title = "States"))
}
plot_specs <- expand.grid(
  timeslot = names(pt_list),
  from = 1:3,
  stringsAsFactors = FALSE
)
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Passengers (min) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

2- Analysis for Time Slot x passengers(boarded&alighted) (max) - Direction 1
```{r}
prob_morning_passengers_max_1 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, boarded_max, alighted_max)
prob_off_passengers_max_1 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, boarded_max, alighted_max)
prob_evening_passengers_max_1 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, boarded_max, alighted_max)

pt_list <- list(
  MorningPeak = prob_morning_passengers_max_1,
  OffPeak     = prob_off_passengers_max_1,
  EveningPeak = prob_evening_passengers_max_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", timeslot_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   timeslot = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Passengers (max) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

3- Analysis for Time Slot x weather (good) - Direction 1
```{r}
make_probtrans <- function(time_slot, model, data, tmat, weather) {
  idx <- which(data$weather == weather & data$time_slot == time_slot)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- mean(msdata_cov$boarded)
  df$alighted <- mean(msdata_cov$alighted)
  df$saturation <- mean(msdata_cov$saturation)
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_morning_weather_good_1 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, 0)
prob_off_weather_good_1 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, 0)
prob_evening_weather_good_1 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, 0)

pt_list <- list(
  MorningPeak = prob_morning_weather_good_1,
  OffPeak     = prob_off_weather_good_1,
  EveningPeak = prob_evening_weather_good_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", timeslot_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   timeslot = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Clear Weather per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

4- Analysis for Time Slot x weather (bad) - Direction 1
```{r}
prob_morning_weather_bad_1 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, 1)
prob_off_weather_bad_1 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, 1)
prob_evening_weather_bad_1 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, 1)

pt_list <- list(
  MorningPeak = prob_morning_weather_bad_1,
  OffPeak     = prob_off_weather_bad_1,
  EveningPeak = prob_evening_weather_bad_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", timeslot_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   timeslot = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Adverse Weather per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

5- Analysis for Time Slot x saturation (min) - Direction 1
```{r}
saturation_min <- 2 #4/2 --> Peripheral areas
saturation_max <- 12 #24/2 --> Milan urban core

make_probtrans <- function(time_slot, model, data, tmat, saturation) {
  idx <- which(data$weather == 0 & data$time_slot == time_slot)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- mean(msdata_cov$boarded)
  df$alighted <- mean(msdata_cov$alighted)
  df$saturation <- saturation
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_morning_saturation_min_1 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, saturation_min)
prob_off_saturation_min_1 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, saturation_min)
prob_evening_saturation_min_1 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, saturation_min)

pt_list <- list(
  MorningPeak = prob_morning_saturation_min_1,
  OffPeak     = prob_off_saturation_min_1,
  EveningPeak = prob_evening_saturation_min_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", timeslot_name, ")"),
#       x = "Time (Minutes)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   timeslot = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Train Frequency per Hour (min) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

6- Analysis for Time Slot x saturation (max) - Direction 1
```{r}
prob_morning_saturation_max_1 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, saturation_max)
prob_off_saturation_max_1 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, saturation_max)
prob_evening_saturation_max_1 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, saturation_max)

pt_list <- list(
  MorningPeak = prob_morning_saturation_max_1,
  OffPeak     = prob_off_saturation_max_1,
  EveningPeak = prob_evening_saturation_max_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", timeslot_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   timeslot = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Train Frequency per Hour (max) per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

7- Analysis for Time Slot x best case - Direction 1
```{r}
make_probtrans <- function(time_slot, model, data, tmat, boarded, alighted, weather, saturation) {
  idx <- which(data$weather == weather & data$time_slot == time_slot)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- boarded
  df$alighted <- alighted
  df$saturation <- saturation
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_morning_best_1 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, boarded_min, alighted_min, 0, saturation_min)
prob_off_best_1 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, boarded_min, alighted_min, 0, saturation_min)
prob_evening_best_1 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, boarded_min, alighted_min, 0, saturation_min)

pt_list <- list(
  MorningPeak = prob_morning_best_1,
  OffPeak     = prob_off_best_1,
  EveningPeak = prob_evening_best_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", timeslot_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   timeslot = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Best Case Scenario per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

8- Analysis for Time Slot x worst case - Direction 1
```{r}
prob_morning_worst_1 <- make_probtrans("Morning-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, boarded_max, alighted_max, 1, saturation_max)
prob_off_worst_1 <- make_probtrans("Off-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, boarded_max, alighted_max, 1, saturation_max)
prob_evening_worst_1 <- make_probtrans("Evening-Peak Time", cox_TimeSlot_bis_1, msdata_cov_1, tmat, boarded_max, alighted_max, 1, saturation_max)

pt_list <- list(
  MorningPeak = prob_morning_worst_1,
  OffPeak     = prob_off_worst_1,
  EveningPeak = prob_evening_worst_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, timeslot_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", timeslot_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   timeslot = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(timeslot, from) {
    make_plot(
      pt_obj = pt_list[[timeslot]],
      from_state = from,
      timeslot_name = timeslot,
      state_label = state_names[from]
    )
  },
  plot_specs$timeslot,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 3), top = textGrob("Predicted Future State Probabilities for Worst Case Scenario per Time Slot", gp = gpar(fontsize = 18, fontface = "bold"))
)
```


###Model with covariates: Route Section (Split by Direction) ---- 
Construct the base model with all the covariates included and then remove the non-significant ones:
```{r}
cox_Zone_1 <- coxph(Surv(time, status) ~ boarded.1 + boarded.2 + boarded.3 + boarded.4 + alighted.1 + alighted.2 + alighted.3 + alighted.4 + saturation.1 + saturation.2 + saturation.3 + saturation.4 + weather1.1 + weather1.2 + weather1.3 + weather1.4 + + zoneZone.3.1 + zoneZone.3.2 + zoneZone.3.3 + zoneZone.3.4 + zoneZone.2.1 + zoneZone.2.2 + zoneZone.2.3 + zoneZone.2.4 + zoneZone.1.1 + zoneZone.1.2 + zoneZone.1.3 + zoneZone.1.4 + strata(trans), data = msdata_cov_exp_1, method = "breslow")
summary(cox_Zone_1)

# cox_Zone_bis_1 <- coxph(Surv(time, status) ~ boarded.1 + boarded.2 + boarded.3 + alighted.2 + alighted.4 + zoneZone.3.1 + zoneZone.3.2 + zoneZone.3.3 + zoneZone.2.1 + zoneZone.2.2 + zoneZone.2.3 + zoneZone.2.4 + zoneZone.1.2 + zoneZone.1.3 + strata(trans), data = msdata_cov_exp_1, method = "breslow")
# summary(cox_Zone_bis_1)
```

Plot HR:
```{r}
# Prepare data
tidy_cox <- broom::tidy(cox_Zone_1, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""))

color_map <- c(
  "OnTime → Mild Delay" = "black",
  "MildDelay → SevereDelay" = "black",
  "SevereDelay → MildDelay" = "black",
  "MildDelay → OnTime" = "black"
)

covariate_names <- unique(tidy_cox$covariate)

plots <- list()

# Build a plot for each covariate
for (cov in covariate_names) {
  df_cov <- tidy_cox %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high, color = trans_label)) +
    geom_pointrange(size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map) +
    coord_flip() +
    labs(title = paste("HR for transitions - Covariate:", cov),
         x = "Transition",
         y = "Hazard Ratio (exponential of the coefficient)",
         color = "Transition") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "none")
  
  plots[[cov]] <- p
}

#Little changes in the titles:
#boarded:
plots[["boarded"]]$labels[2] <- "HR (50 people)"
plots[["boarded"]]$labels[4] <- "Hazard Ratios with 95% CI for Boarded"
#alighted:
plots[["alighted"]]$labels[2] <- "HR (50 people)"
plots[["alighted"]]$labels[4] <- "Hazard Ratios with 95% CI for Alighted"
#weather1:
plots[["weather1"]]$labels[2] <- "HR (Clear)"
plots[["weather1"]]$labels[4] <- "Hazard Ratios with 95% CI for Adverse Weather"
#saturation:
plots[["saturation"]]$labels[2] <- "HR (2 trains)"
plots[["saturation"]]$labels[4] <- "Hazard Ratios with 95% CI for Train Frequency per Hour"
#zoneZone.1:
plots[["zoneZone.1"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zoneZone.1"]]$labels[4] <- "Hazard Ratios with 95% CI for Varese - Gallarate"
#zoneZone.2:
plots[["zoneZone.2"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zoneZone.2"]]$labels[4] <- "Hazard Ratios with 95% CI for Busto Arsizio - Rho Fiera"
#zoneZone.3:
plots[["zoneZone.3"]]$labels[2] <- "HR (Segrate-Treviglio)"
plots[["zoneZone.3"]]$labels[4] <- "Hazard Ratios with 95% CI for Milano Certosa - Milano Forlanini"

# Plot:
print(plots[["boarded"]])
print(plots[["alighted"]])
print(plots[["saturation"]])
print(plots[["zoneZone.1"]])
print(plots[["zoneZone.2"]])
print(plots[["zoneZone.3"]])
```


Plot Transition probabilities:

1- Analysis for Route Section x passengers(boarded&alighted) (min) - Direction 1
```{r}
# quantile(msdata_cov$boarded, probs = c(0.15, 0.85))
# quantile(msdata_cov$alighted, probs = c(0.15, 0.85))
# boarded_min <- 0.04
# boarded_max <- 0.98 
# alighted_min <- 0.10
# alighted_max <- 1.08
cov <- c("boarded", "alighted", "saturation", "weather", "zone")

make_probtrans <- function(zone, model, data, tmat, boarded, alighted) {
  idx <- which(data$weather == 0 & data$zone == zone)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- boarded
  df$alighted <- alighted
  df$saturation <- mean(msdata_cov$saturation)
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_Zone1_passengers_min_1 <- make_probtrans("Zone 1", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_min, alighted_min)
prob_Zone2_passengers_min_1 <- make_probtrans("Zone 2", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_min, alighted_min)
prob_Zone3_passengers_min_1 <- make_probtrans("Zone 3", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_min, alighted_min)
prob_Zone4_passengers_min_1 <- make_probtrans("Zone 4", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_min, alighted_min)

pt_list <- list(
  Zone1 = prob_Zone1_passengers_min_1,
  Zone2 = prob_Zone2_passengers_min_1,
  Zone3 = prob_Zone3_passengers_min_1,
  Zone4 = prob_Zone4_passengers_min_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Passengers (min) per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

2- Analysis for Route Section x passengers(boarded&alighted) (max) - Direction 1
```{r}
prob_Zone1_passengers_max_1 <- make_probtrans("Zone 1", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_max, alighted_max)
prob_Zone2_passengers_max_1 <- make_probtrans("Zone 2", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_max, alighted_max)
prob_Zone3_passengers_max_1 <- make_probtrans("Zone 3", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_max, alighted_max)
prob_Zone4_passengers_max_1 <- make_probtrans("Zone 4", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_max, alighted_max)

pt_list <- list(
  Zone1 = prob_Zone1_passengers_max_1,
  Zone2 = prob_Zone2_passengers_max_1,
  Zone3 = prob_Zone3_passengers_max_1,
  Zone4 = prob_Zone4_passengers_max_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Passengers (max) per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

3- Analysis for Route Section x weather (good) - Direction 1
```{r}
make_probtrans <- function(zone, model, data, tmat, weather) {
  idx <- which(data$weather == weather & data$zone == zone)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- mean(msdata_cov$boarded)
  df$alighted <- mean(msdata_cov$alighted)
  df$saturation <- mean(msdata_cov$saturation)
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_Zone1_weather_good_1 <- make_probtrans("Zone 1", cox_Zone_bis_1, msdata_cov_1, tmat, 0)
prob_Zone2_weather_good_1 <- make_probtrans("Zone 2", cox_Zone_bis_1, msdata_cov_1, tmat, 0)
prob_Zone3_weather_good_1 <- make_probtrans("Zone 3", cox_Zone_bis_1, msdata_cov_1, tmat, 0)
prob_Zone4_weather_good_1 <- make_probtrans("Zone 4", cox_Zone_bis_1, msdata_cov_1, tmat, 0)

pt_list <- list(
  Zone1 = prob_Zone1_weather_good_1,
  Zone2 = prob_Zone2_weather_good_1,
  Zone3 = prob_Zone3_weather_good_1,
  Zone4 = prob_Zone4_weather_good_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Clear Weather per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

4- Analysis for Route Section x weather (bad) - Direction 1
```{r}
prob_Zone1_weather_bad_1 <- make_probtrans("Zone 1", cox_Zone_bis_1, msdata_cov_1, tmat, 1)
prob_Zone2_weather_bad_1 <- make_probtrans("Zone 2", cox_Zone_bis_1, msdata_cov_1, tmat, 1)
prob_Zone3_weather_bad_1 <- make_probtrans("Zone 3", cox_Zone_bis_1, msdata_cov_1, tmat, 1)
prob_Zone4_weather_bad_1 <- make_probtrans("Zone 4", cox_Zone_bis_1, msdata_cov_1, tmat, 1)

pt_list <- list(
  Zone1 = prob_Zone1_weather_bad_1,
  Zone2 = prob_Zone2_weather_bad_1,
  Zone3 = prob_Zone3_weather_bad_1,
  Zone4 = prob_Zone4_weather_bad_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Adverse Weather per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

5- Analysis for Route Section x saturation (min) - Direction 1
```{r}
saturation_min <- 2 #4/2 --> Peripheral areas
saturation_max <- 12 #24/2 --> Milan urban core

make_probtrans <- function(zone, model, data, tmat, saturation) {
  idx <- which(data$weather == 0 & data$zone == zone)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- mean(msdata_cov$boarded)
  df$alighted <- mean(msdata_cov$alighted)
  df$saturation <- saturation
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_Zone1_saturation_min_1 <- make_probtrans("Zone 1", cox_Zone_bis_1, msdata_cov_1, tmat, saturation_min)
prob_Zone2_saturation_min_1 <- make_probtrans("Zone 2", cox_Zone_bis_1, msdata_cov_1, tmat, saturation_min)
prob_Zone3_saturation_min_1 <- make_probtrans("Zone 3", cox_Zone_bis_1, msdata_cov_1, tmat, saturation_min)
prob_Zone4_saturation_min_1 <- make_probtrans("Zone 4", cox_Zone_bis_1, msdata_cov_1, tmat, saturation_min)

pt_list <- list(
  Zone1 = prob_Zone1_saturation_min_1,
  Zone2 = prob_Zone2_saturation_min_1,
  Zone3 = prob_Zone3_saturation_min_1,
  Zone4 = prob_Zone4_saturation_min_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Train Frequency per Hour (min) per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

6- Analysis for Route Section x saturation (max) - Direction 1
```{r}
prob_Zone1_saturation_max_1 <- make_probtrans("Zone 1", cox_Zone_bis_1, msdata_cov_1, tmat, saturation_max)
prob_Zone2_saturation_max_1 <- make_probtrans("Zone 2", cox_Zone_bis_1, msdata_cov_1, tmat, saturation_max)
prob_Zone3_saturation_max_1 <- make_probtrans("Zone 3", cox_Zone_bis_1, msdata_cov_1, tmat, saturation_max)
prob_Zone4_saturation_max_1 <- make_probtrans("Zone 4", cox_Zone_bis_1, msdata_cov_1, tmat, saturation_max)

pt_list <- list(
  Zone1 = prob_Zone1_saturation_max_1,
  Zone2 = prob_Zone2_saturation_max_1,
  Zone3 = prob_Zone3_saturation_max_1,
  Zone4 = prob_Zone4_saturation_max_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Train Frequency per Hour (max) per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

7- Analysis for Route Section x best case - Direction 1
```{r}
make_probtrans <- function(zone, model, data, tmat, boarded, alighted, weather, saturation) {
  idx <- which(data$weather == weather & data$zone == zone)[1]
  df <- data[rep(idx, 4), c(17, 18, 20, 21, 23, 24)]
  df$trans <- 1:4
  df$boarded <- boarded
  df$alighted <- alighted
  df$saturation <- saturation
  attr(df, "trans") <- tmat
  df_exp <- expand.covs(df, cov, longnames = TRUE)
  df_exp$strata <- df_exp$trans
  ms <- msfit(model, df_exp, trans = tmat)
  prob <- probtrans(ms, predt = 0)
  return(prob)
}

prob_Zone1_best_1 <- make_probtrans("Zone 1", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_min, alighted_min, 0, saturation_min)
prob_Zone2_best_1 <- make_probtrans("Zone 2", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_min, alighted_min, 0, saturation_min)
prob_Zone3_best_1 <- make_probtrans("Zone 3", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_min, alighted_min, 0, saturation_min)
prob_Zone4_best_1 <- make_probtrans("Zone 4", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_min, alighted_min, 0, saturation_min)

pt_list <- list(
  Zone1 = prob_Zone1_best_1,
  Zone2 = prob_Zone2_best_1,
  Zone3 = prob_Zone3_best_1,
  Zone4 = prob_Zone4_best_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Best Case Scenario per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```

8- Analysis for Route Section x worst case - Direction 1
```{r}
prob_Zone1_worst_1 <- make_probtrans("Zone 1", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_max, alighted_max, 1, saturation_max)
prob_Zone2_worst_1 <- make_probtrans("Zone 2", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_max, alighted_max, 1, saturation_max)
prob_Zone3_worst_1 <- make_probtrans("Zone 3", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_max, alighted_max, 1, saturation_max)
prob_Zone4_worst_1 <- make_probtrans("Zone 4", cox_Zone_bis_1, msdata_cov_1, tmat, boarded_max, alighted_max, 1, saturation_max)

pt_list <- list(
  Zone1 = prob_Zone1_worst_1,
  Zone2 = prob_Zone2_worst_1,
  Zone3 = prob_Zone3_worst_1,
  Zone4 = prob_Zone4_worst_1
)
state_names <- c("OnTime", "MildDelay", "SevereDelay")
statecols <- c("#D1E5F0", "#F6A482", "#B31529")
ord <- c(1,2,3)
# make_plot <- function(pt_obj, from_state, routesec_name, state_label) {
#   plot(pt_obj, ord = ord, from = from_state, xlim = c(0,30), use.ggplot = TRUE) +
#     scale_fill_manual(values = statecols) +
#     theme_minimal() +
#     labs(
#       title = paste("From", state_label, "(", routesec_name, ")"),
#       x = "Time (Minutes ahead)",
#       y = "Transition Probability"
#     ) +
#     guides(fill = guide_legend(title = "States"))
# }
# plot_specs <- expand.grid(
#   routesec = names(pt_list),
#   from = 1:3,
#   stringsAsFactors = FALSE
# )
plots <- mapply(
  function(routesec, from) {
    make_plot(
      pt_obj = pt_list[[routesec]],
      from_state = from,
      routesec_name = routesec,
      state_label = state_names[from]
    )
  },
  plot_specs$routesec,
  plot_specs$from,
  SIMPLIFY = FALSE
)
grid.arrange(arrangeGrob(plots, nrow = 3, ncol = 4), top = textGrob("Predicted Future State Probabilities for Worst Case Scenario per Route Section", gp = gpar(fontsize = 18, fontface = "bold"))
)
```


## Covariates and Frailties----
###Model with covariates and frailties: Time Slot (Split by Direction) ----  
Contruct the model defining a frailty on ID_Train (Gamma is better than Gaussian frailty):
```{r}
frailtyGamma_TimeSlot_1 <- coxph(Surv(time, status) ~ boarded.1 + boarded.2 + boarded.3 + boarded.4 + alighted.1 + alighted.2 + alighted.3 + alighted.4 + saturation.1 + saturation.2 + saturation.3 + saturation.4 + weather1.1 + weather1.2 + weather1.3 + weather1.4 + time_slotMorning.Peak.Time.1 + time_slotMorning.Peak.Time.2 + time_slotMorning.Peak.Time.3 + time_slotMorning.Peak.Time.4 + time_slotEvening.Peak.Time.1 + time_slotEvening.Peak.Time.2 + time_slotEvening.Peak.Time.3 + time_slotEvening.Peak.Time.4 + frailty(ID_Train, distribution = "gamma") + strata(trans), data = msdata_cov_exp_1, method = "breslow")
summary(frailtyGamma_TimeSlot_1)
logLik(frailtyGamma_TimeSlot_1)

# frailtyGaussian_TimeSlot_1 <- coxph(Surv(time, status) ~ boarded.1 + boarded.2 + boarded.3 + boarded.4 + alighted.1 + alighted.2 + alighted.3 + alighted.4 + saturation.1 + saturation.2 + saturation.3 + saturation.4 + weather1.1 + weather1.2 + weather1.3 + weather1.4 + time_slotMorning.Peak.Time.1 + time_slotMorning.Peak.Time.2 + time_slotMorning.Peak.Time.3 + time_slotMorning.Peak.Time.4 + time_slotEvening.Peak.Time.1 + time_slotEvening.Peak.Time.2 + time_slotEvening.Peak.Time.3 + time_slotEvening.Peak.Time.4 + frailty(ID_Mezzo, distribution = "gaussian") + strata(trans), data = msdata_cov_exp_1, method = "breslow")
# summary(frailtyGaussian_TimeSlot_1)
# logLik(frailtyGaussian_TimeSlot_1)
```

Plot HR:
```{r}
color_map <- c(
  "OnTime → Mild Delay" = "black",
  "MildDelay → SevereDelay" = "black",
  "SevereDelay → MildDelay" = "black",
  "MildDelay → OnTime" = "black"
)
tidy_cox <- broom::tidy(cox_TimeSlot_1, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""),
         model = "Cox")

# Estract coeff, confint e compute HR
frailty_coef <- coef(frailtyGamma_TimeSlot_1)
frailty_ci <- confint(frailtyGamma_TimeSlot_1)

tidy_frailty <- tibble(
  term = names(frailty_coef),
  estimate = exp(frailty_coef),
  conf.low = exp(frailty_ci[, 1]),
  conf.high = exp(frailty_ci[, 2])
) %>%
  mutate(
    trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
    trans_label = factor(trans, levels = c("1","3","4","2"),
                         labels = c("OnTime → Mild Delay",
                                    "MildDelay → SevereDelay",
                                    "SevereDelay → MildDelay",
                                    "MildDelay → OnTime")),
    covariate = str_replace(term, "\\.\\d$", ""),
    model = "Frailty"
  )
combined_data <- bind_rows(tidy_cox, tidy_frailty)
covariate_names <- unique(combined_data$covariate)

plots <- list()
pd <- position_dodge(width = 0.6)

for (cov in covariate_names) {
  df_cov <- combined_data %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high,
                          color = trans_label, shape = model)) +
    geom_pointrange(position = pd, size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map, name = "Transition") +
    scale_shape_manual(values = c(Cox = 16, Frailty = 17),
                       labels = c("Cox model", "Frailty model"),
                       name = "Model") +
    coord_flip() +
    labs(title = paste("HR for transitions - Covariate:", cov),
         x = "Transition",
         y = "Hazard Ratio (exponential of the coefficient)") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "right",
          legend.box = "vertical",
          legend.title = element_text(face = "bold"),
          legend.spacing.y = unit(0.4, 'cm'),
          legend.text = element_text(size = 11))
  
  plots[[cov]] <- p
}

#Little changes in the titles:
#boarded
plots[["boarded"]]$labels[["y"]] <- "HR (50 people)"
plots[["boarded"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Boarded"
#alighted
plots[["alighted"]]$labels[["y"]] <- "HR (50 people)"
plots[["alighted"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Alighted"
#weather
plots[["weather1"]]$labels[["y"]] <- "HR (Clear)"
plots[["weather1"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Adverse Weather"
#saturation
plots[["saturation"]]$labels[["y"]] <- "HR (2 trains)"
plots[["saturation"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Train Frequency per Hour"
#time_slotMorning.Peak.Time
plots[["time_slotMorning.Peak.Time"]]$labels[["y"]] <- "HR (Off-Peak Time)"
plots[["time_slotMorning.Peak.Time"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Morning-Peak Time"
#time_slotEvening.Peak.Time
plots[["time_slotEvening.Peak.Time"]]$labels[["y"]] <- "HR (Off-Peak Time)"
plots[["time_slotEvening.Peak.Time"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Evening-Peak Time"

# Plot
print(plots[["boarded"]])
print(plots[["alighted"]])
print(plots[["weather1"]])
print(plots[["saturation"]])
print(plots[["time_slotMorning.Peak.Time"]])
print(plots[["time_slotEvening.Peak.Time"]])
```

Frailty Plot:
```{r}
# Estract log(wj) values
frailty_vals_TimeSlot_1 <- frailtyGamma_TimeSlot_1$frail

# Assign ID_Train to the respective values of frailty and consider the specific variances for wj:
cluster_levels_TimeSlot_1 <- sort(unique(msdata_cov_exp_1$ID_Train))
frailty_table_TimeSlot_1 <- data.frame(ID_Train = cluster_levels_TimeSlot_1, frailty = frailtyGamma_TimeSlot_1$frail, var=frailtyGamma_TimeSlot_1$fvar)

# Now repeat the same but for ID_TrainRun adding also the actual values of wj instead of considering frailty=log(wj):
#Morning
data_distinct_TimeSlot_1 <- msdata_cov_exp[!duplicated(msdata_cov_exp_1$ID_Train), c("ID_Train", "ID_TrainRun", "departure", "time_slot")]
tab_frailty_TimeSlot_1 <- merge(frailty_table_TimeSlot_1, data_distinct_TimeSlot_1, by = "ID_Train")
tab_frailty_TimeSlot_1$wj <- exp(tab_frailty_TimeSlot_1$frailty)
tab_frailty_TimeSlot_1$departure <- format(as.POSIXct(tab_frailty_TimeSlot_1$departure), "%I:%M %p")
tab_frailty_TimeSlot_1$lower <- exp(tab_frailty_TimeSlot_1$frailty - 1.96 * sqrt(tab_frailty_TimeSlot_1$var))
tab_frailty_TimeSlot_1$upper <- exp(tab_frailty_TimeSlot_1$frailty + 1.96 * sqrt(tab_frailty_TimeSlot_1$var))
```

Frailty Plot colored by TimeSlot:
```{r}
times_unique_TimeSlot_1 <- c("Morning-Peak Time", "Off-Peak Time", "Evening-Peak Time")
tab_frailty_TimeSlot_1$time_slot <- factor(tab_frailty_TimeSlot_1$time_slot, levels = times_unique_TimeSlot_1)
personalized_colors <- c("#87CEFA", "#EB5C82", "#F59B51")
palette_times_TimeSlot_1 <- setNames(personalized_colors, times_unique_TimeSlot_1)

theta_TimeSlot_1 <- 0.235767
down <- exp(-1.5 * sqrt(theta_TimeSlot_1))
up <- exp(1.5 * sqrt(theta_TimeSlot_1))

ggplot(tab_frailty_TimeSlot_1, aes(x = ID_Train, y = wj, color = time_slot)) +
  geom_point(size = 2) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", linewidth = 0.4) +
  geom_hline(yintercept = up, linetype = "dashed", color = "grey", linewidth = 0.4) +
  geom_hline(yintercept = down, linetype = "dashed", color = "grey", linewidth = 0.4) +
  scale_color_manual(values = palette_times_TimeSlot_0) +
  labs(
    title = "Empirical Gamma Failty Terms",
    x = "Mission",
    y = "Frailty (wj)",
    color = "Time Slot"
  ) +
  theme_minimal()
```


###Model with covariates and frailties: Route Section (Split by Direction) ----  
Contruct the model defining a frailty on ID_Train (Gamma is better than Gaussian frailty):
```{r}
frailtyGamma_Zone_1 <- coxph(Surv(time, status) ~ boarded.1 + boarded.2 + boarded.3 + boarded.4 + alighted.1 + alighted.2 + alighted.3 + alighted.4 + saturation.1 + saturation.2 + saturation.3 + saturation.4 + weather1.1 + weather1.2 + weather1.3 + weather1.4 + zoneZone.3.1 + zoneZone.3.2 + zoneZone.3.3 + zoneZone.3.4 + zoneZone.2.1 + zoneZone.2.2 + zoneZone.2.3 + zoneZone.2.4 + zoneZone.1.1 + zoneZone.1.2 + zoneZone.1.3 + zoneZone.1.4 + frailty(ID_Train, distribution = "gamma") + strata(trans), data = msdata_cov_exp_1, method = "breslow")
summary(frailtyGamma_Zone_1)
logLik(frailtyGamma_Zone_1)

# frailtyGaussian_Zone_1 <- coxph(Surv(time, status) ~ boarded.1 + boarded.2 + boarded.3 + boarded.4 + alighted.1 + alighted.2 + alighted.3 + alighted.4 + saturation.1 + saturation.2 + saturation.3 + saturation.4 + weather1.1 + weather1.2 + weather1.3 + weather1.4 + zoneZone.3.1 + zoneZone.3.2 + zoneZone.3.3 + zoneZone.3.4 + zoneZone.2.1 + zoneZone.2.2 + zoneZone.2.3 + zoneZone.2.4 + zoneZone.1.1 + zoneZone.1.2 + zoneZone.1.3 + zoneZone.1.4 + frailty(ID_Mezzo, distribution = "gaussian") + strata(trans), data = msdata_cov_exp_1, method = "breslow")
# summary(frailtyGaussian_Zone_1)
# logLik(frailtyGaussian_Zone_1)
```

Plot HR:
```{r}
color_map <- c(
  "OnTime → Mild Delay" = "black",
  "MildDelay → SevereDelay" = "black",
  "SevereDelay → MildDelay" = "black",
  "MildDelay → OnTime" = "black"
)
tidy_cox <- broom::tidy(cox_Zone_1, conf.int = TRUE, exponentiate = TRUE) %>%
  mutate(trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
         trans_label = factor(trans, levels = c("1","3","4","2"),
                              labels = c("OnTime → Mild Delay",
                                         "MildDelay → SevereDelay",
                                         "SevereDelay → MildDelay",
                                         "MildDelay → OnTime")),
         covariate = str_replace(term, "\\.\\d$", ""),
         model = "Cox")

# Estract coeff, confint e compute HR
frailty_coef <- coef(frailtyGamma_Zone_1)
frailty_ci <- confint(frailtyGamma_Zone_1)

tidy_frailty <- tibble(
  term = names(frailty_coef),
  estimate = exp(frailty_coef),
  conf.low = exp(frailty_ci[, 1]),
  conf.high = exp(frailty_ci[, 2])
) %>%
  mutate(
    trans = str_extract(term, "\\.\\d$") %>% str_replace("\\.", ""),
    trans_label = factor(trans, levels = c("1","3","4","2"),
                         labels = c("OnTime → Mild Delay",
                                    "MildDelay → SevereDelay",
                                    "SevereDelay → MildDelay",
                                    "MildDelay → OnTime")),
    covariate = str_replace(term, "\\.\\d$", ""),
    model = "Frailty"
  )
combined_data <- bind_rows(tidy_cox, tidy_frailty)
covariate_names <- unique(combined_data$covariate)

plots <- list()
pd <- position_dodge(width = 0.6)

for (cov in covariate_names) {
  df_cov <- combined_data %>% filter(covariate == cov)
  
  p <- ggplot(df_cov, aes(x = trans_label, y = estimate, ymin = conf.low, ymax = conf.high,
                          color = trans_label, shape = model)) +
    geom_pointrange(position = pd, size = 0.5) +
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray40") +
    scale_color_manual(values = color_map, name = "Transition") +
    scale_shape_manual(values = c(Cox = 16, Frailty = 17),
                       labels = c("Cox model", "Frailty model"),
                       name = "Model") +
    coord_flip() +
    labs(title = paste("HR for transitions - Covariate:", cov),
         x = "Transition",
         y = "Hazard Ratio (exponential of the coefficient)") +
    theme_minimal(base_size = 14) +
    theme(legend.position = "right",
          legend.box = "vertical",
          legend.title = element_text(face = "bold"),
          legend.spacing.y = unit(0.4, 'cm'),
          legend.text = element_text(size = 11))
  
  plots[[cov]] <- p
}

#Little changes in the titles:
#boarded
plots[["boarded"]]$labels[["y"]] <- "HR (50 people)"
plots[["boarded"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Boarded"
#alighted
plots[["alighted"]]$labels[["y"]] <- "HR (50 people)"
plots[["alighted"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Alighted"
#weather
plots[["weather1"]]$labels[["y"]] <- "HR (Clear)"
plots[["weather1"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Adverse Weather"
#saturation
plots[["saturation"]]$labels[["y"]] <- "HR (2 trains)"
plots[["saturation"]]$labels[["title"]] <- "Hazard Ratios with 95% CI for Train Frequency per Hour"
#zoneZone.1:
plots[["zoneZone.1"]]$labels["y"] <- "HR (Segrate-Treviglio)"
plots[["zoneZone.1"]]$labels["title"] <- "Hazard Ratios with 95% CI for Varese - Gallarate"
#zoneZone.2:
plots[["zoneZone.2"]]$labels["y"] <- "HR (Segrate-Treviglio)"
plots[["zoneZone.2"]]$labels["title"] <- "Hazard Ratios with 95% CI for Busto Arsizio - Rho Fiera"
#zoneZone.3:
plots[["zoneZone.3"]]$labels["y"] <- "HR (Segrate-Treviglio)"
plots[["zoneZone.3"]]$labels["title"] <- "Hazard Ratios with 95% CI for Milano Certosa - Milano Forlanini"

# Plot
print(plots[["boarded"]])
print(plots[["alighted"]])
print(plots[["weather1"]])
print(plots[["saturation"]])
print(plots[["zoneZone.1"]])
print(plots[["zoneZone.2"]])
print(plots[["zoneZone.3"]])
```

Frailty Plot:
```{r}
# Estract log(wj) values
frailty_vals_Zone_1 <- frailtyGamma_Zone_1$frail

# Assign ID_Train to the respective values of frailty and consider the specific variances for wj:
cluster_levels_Zone_1 <- sort(unique(msdata_cov_exp_1$ID_Train))
frailty_table_Zone_1 <- data.frame(ID_Train = cluster_levels_Zone_1, frailty = frailtyGamma_Zone_1$frail, var=frailtyGamma_Zone_1$fvar)

# Now repeat the same but for ID_TrainRun adding also the actual values of wj instead of considering frailty=log(wj):
#Morning
data_distinct_Zone_1 <- msdata_cov_exp[!duplicated(msdata_cov_exp_1$ID_Train), c("ID_Train", "ID_TrainRun", "departure", "zone")]
tab_frailty_Zone_1 <- merge(frailty_table_Zone_1, data_distinct_Zone_1, by = "ID_Train")
tab_frailty_Zone_1$wj <- exp(tab_frailty_Zone_1$frailty)
tab_frailty_Zone_1$departure <- format(as.POSIXct(tab_frailty_Zone_1$departure), "%I:%M %p")
tab_frailty_Zone_1$lower <- exp(tab_frailty_Zone_1$frailty - 1.96 * sqrt(tab_frailty_Zone_1$var))
tab_frailty_Zone_1$upper <- exp(tab_frailty_Zone_1$frailty + 1.96 * sqrt(tab_frailty_Zone_1$var))
```

Frailty Plot colored by Zone:
```{r}
times_unique_Zone_1 <- c("Zone1", "Zone2", "Zone3", "Zone4")
tab_frailty_Zone_1$time_slot <- factor(tab_frailty_Zone_1$time_slot, levels = times_unique_Zone_1)
personalized_colors <- c("#87CEFA", "#00B88D", "#EB5C82", "#F59B51")
palette_times_Zone_1 <- setNames(personalized_colors, times_unique_Zone_1)

theta_Zone_1 <- 0.235767
down <- exp(-1.5 * sqrt(theta_Zone_1))
up <- exp(1.5 * sqrt(theta_Zone_1))

ggplot(tab_frailty_Zone_1, aes(x = ID_Train, y = wj, color = zone)) +
  geom_point(size = 2) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "black", linewidth = 0.4) +
  geom_hline(yintercept = up, linetype = "dashed", color = "grey", linewidth = 0.4) +
  geom_hline(yintercept = down, linetype = "dashed", color = "grey", linewidth = 0.4) +
  scale_color_manual(values = palette_times_Zone_0) +
  labs(
    title = "Empirical Gamma Failty Terms",
    x = "Mission",
    y = "Frailty (wj)",
    color = "Zone"
  ) +
  theme_minimal()
```
